<!DOCTYPE html>
<html lang='zh-hans'>
	<head>
        <meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- favicon -->
        <link rel="icon" href="./files/favicon.svg" type="image/svg+xml">
        <!-- JavaScript Codes -->
        <script src="./files/tutorial.js" defer></script>
        <!-- Basic MathJax Javascript -->
        <script src="./files/mathJax3-tex-svg.js" defer></script>
        <!-- Custom CSS -->
         <link rel="preload" href="./files/tutorial.css" as="style">
        <link rel="stylesheet" href="./files/tutorial.css">
        <!-- highlight JS & CSS (language-cpp, language-bash, language-powershell) -->
        <link rel="stylesheet" href="./files/docco.min.css">
        <script src="./files/highlight.min.js"></script>
        <script>hljs.highlightAll();</script>
        <title>x265 教程 HTML 完整版</title>
	</head>
	<body class="text-gray-main">
        <div class="container-title">
            <h1>x265 教程<span class="text-blue-emph"> HTML 完整版</span></h1>
            <p>欢迎阅读！若有任何问题，请加入 QQ 群<a href='https://jq.qq.com/?_wv=1027&k=5YJFXyf'>691892901</a>。本教程是对 HEVC 编码的业余分析，仅具备业余参考价值。入门时，请先阅读 x264 视频压缩教程综合版，并可参考急用版教程进行编码压制。</p>
            <!-- x264 教程副本，更改需手动同步 { -->
            <h2>地图</h2>
            <ol class="font-monospace">
                <li><a href="../../x264-web-tutorial/HTML/index.html">x264 教程网页版</a></li>
                <li>
                    <a href="../../x265-web-tutorial/HTML/index.html" class="disabled">x265 教程网页版（你在这里）</a>
                    <ul class="text-xs">
                        <li>基础：
                            <a class="toSelf" href="#h2-1">命令参考</a>，
                            <a class="toSelf" href="#h2-2">视频的压制</a>
                        </li>
                        <li>编码：
                            <a class="toSelf" href="#h2-3">分块</a>，
                            <a class="toSelf" href="#h2-4">变换</a>，
                            <a class="toSelf" href="#h2-5">动态预测</a>，
                            <a class="toSelf" href="#h2-6">动态搜索</a>，
                            <a class="toSelf" href="#h2-7">动态补偿</a>，
                            <a class="toSelf" href="#h2-8">时域架网搜索</a>，
                            <a class="toSelf" href="#h2-9">前瞻进程</a>，
                            <a class="toSelf" href="#h2-10">帧内预测</a>，
                            <a class="toSelf" href="#h2-11">率控制</a>，
                            <a class="toSelf" href="#h2-12">自适应量化</a>，
                            <a class="toSelf" href="#h2-13">率失真优化</a>，
                            <a class="toSelf" href="#h2-14">环路滤镜</a>，
                            <a class="toSelf" href="#h2-15">熵编码</a>，
                            <a class="toSelf" href="#h2-16">优化熵编码</a>，
                            <a class="toSelf" href="#h2-17">SEI</a>，
                            <a class="toSelf" href="#h2-18">线程与节点控制</a>，
                            <a class="toSelf" href="#h2-19">色彩，VUI，HDR</a>，
                            <a class="toSelf" href="#h2-20">输入输出</a>
                        </li>
                        <li>附录：
                            <a class="toSelf" href="#h2-21">预设参数</a>
                            <a class="toSelf" href="#h2-22">下载</a>
                        </li>
                    </ul>
                </li>
                <li><a href="../../av1-web-tutorial/HTML/index.html">AV1 教程网页版</a></li>
                <li>
                    附录 α：
                    <a href="https://www.nazorip.site/archives/44/">QAAC 音频压缩教程</a> 或
                    <a href="https://github.com/iAvoe/QAAC-Tutorial-Standalone/blob/master/%E6%95%99%E7%A8%8B.md">Github 副本</a>
                </li>
                <li>附录 β：<a href="https://nazorip.site/archives/334/">x264，libx264，x265，libx265 压制教程急用版</a></li>
                <li>
                    附录 γ：<a href="https://nazorip.site/archives/169/">ffprobe 教程</a> 或
                    <a href="https://github.com/iAvoe/FFprobe-Tutorial-Standalone/blob/master/%E6%95%99%E7%A8%8B.md">Github 副本</a>
                </li>
                <li>附录 δ：<a href="https://nazorip.site/archives/1068/">ffprobe + Excel 绘制码率曲线，帧类型饼图</a></li>
                <li>
                    附录 ε：<a href="../../deint-ivtc-web-tutorial/HTML/index.html">交错转逐行与 IVTC 处理</a>
                    <ul class="text-xs">
                        <li>逐行与交错扫描，帧率与场率，仅交错，A:B Pulldown / telecine，2:2:2:4，3:2:3:2，Euro-pulldown，0.5:0.5，特殊情况，去交错的算法与滤镜，IVTC 滤镜用例，p/c/n/u/b，AviSynth 例，TFM-TDecimate 例，VapourSynth 例</li>
                    </ul>
                </li>
                <li>附录 ζ：<a href="../../img-sequence-enc-web-tutorial/HTML/index.html">图像序列的处理</a></li><!-- 后续顺序：η θ ι κ λ μ -->
                <li>相关：<a href="https://nazorip.site/archives/1052/">mpv 播放器的安装与设置</a></li>
            </ol>
            <h3>打印支持</h3>
            <button type="button" class="border-main rounded-3 ms-1 px-1" onclick="toggleCollapseAll()">1/5. 点击同步展开/折叠所有内容</button>
            <button type="button" class="border-main rounded-3 ms-1 px-1" onclick="printMode()">2. 点击进入文档的打印模式排版</button>
            <button type="button" class="border-main rounded-3 ms-1 px-1" onclick="window.print()">3. 点击打印（可生成 PDF）</button>
            <p class="font-monospace px-1">推荐打印设置：彩色模式、打印背景、含边距、打印页眉页脚</p>
            <button type="button" class="border-main rounded-3 ms-1 px-1" onclick="printModeOff()">4. 点击退出打印排版</button>
            <button type="button" class="border-main rounded-3 ms-1 px-1" onclick="toggleCollapseAll()">1/5. 点击同步展开/折叠所有内容</button>
            <!-- } -->
            <h3>移动端支持</h3>
            <p>点击图片即可轮询三种图片大小。窗口宽度大于窗口高度则切换到宽屏/桌面端/平板电脑排版，否则切换到窄屏/移动端排版。</p>
        </div>
        <div class="container-mobile rounded-9 border-main">
            <h2 id="h2-1">命令行调用参考</h2>

            <h3>命令行参数的说明格式</h3>
            <code class="code-bold">--参数</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关 | 整数 A~B | 浮点 A~B | 其它格式，默认值，<span class="text-red-emph">限制</span>&gt;说明信息，特点注解，推荐<span class="text-blue-emph">这个值</span>，其它情况可设<span class="text-blue-emph">这个值</span>。</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>情况 1：特点如此，推荐<span class="text-blue-emph">这个值</span></li>
                <li>情况 2：特点如此，推荐<span class="text-blue-emph">这个值</span></li>
                <li>情况 3：特点如此，推荐<span class="text-blue-emph">这个值</span></li>
            </ul>

            <h3>ffmpeg 调用 libx265</h3>
            <pre><code class="text-smaller language-powershell">
ffmpeg.exe -i &lt;源&gt; -c:v libx265 -x265-params "&lt;参数A&gt;=&lt;值A&gt;:&lt;参数B&gt;=&lt;值B&gt;" -fps_mode passthrough -c:a copy &lt;输出.mp4&gt;
            </code></pre>

            <h3>ffmpeg，avs2yuv 传递参数</h3>
            <pre><code class="text-smaller language-powershell">
ffmpeg.exe -i &lt;源&gt; -an -f yuv4mpegpipe -strict unofficial - | x265.exe --y4m --input - --output &lt;输出.hevc&gt;

ffmpeg.exe -i &lt;源&gt; -an -f rawvideo - | x265.exe --input-res &lt;宽x高&gt; --fps &lt;整/小/分数&gt; -D &lt;位深&gt; --input - --output &lt;输出.hevc&gt;
            </code></pre>

            <p><span class="text-blue-emph">-f</span>格式，<span class="text-blue-emph">-an</span>关音频，<span class="text-blue-emph">-strict unofficial</span> 解除编码超过 8bit 位深的 y4m 格式，<span class="text-blue-emph">--y4m</span> 对应"YUV for MPEG"，代表一种自带分辨率、帧率、位深等参数的未压缩格式，两个“-”代表 pipe 串流的输出和输入。</p>

            <pre><code class="text-smaller language-powershell">
avs2yuv.exe &lt;源.avs&gt; -csp &lt;色彩空间&gt; -depth &lt;位深&gt; - | x265.exe --input-res &lt;宽x高&gt; --fps &lt;帧率&gt; --input - --output &lt;输出.hevc&gt;

avs2pipemod.exe &lt;源.avs&gt; -y4mp | x265.exe --y4m --input - --output &lt;输出.hevc&gt;
            </code></pre>
            <p>如果源视频的格式不支持元数据（如 .yuv），或者 ffmpeg 读取不到时，可以手动提供分辨率、帧率、色彩空间以及位深（当然此时直接用视频编码器导入，并手动指定这些信息可能更简单）：</p>
            <pre><code class="text-smaller language-powershell">
-s &lt;宽x高&gt; -r &lt;帧率&gt; -pix_fmt &lt;色彩空间及位深，如 yuv420p10le&gt;
            </code></pre>

            <h3>HDR 转换 SDR</h3>
            <p>如果源视频使用 HDR 格式编码，而目标格式为 SDR，则可以使用 ffmpeg 的 <code>-vf zscale</code> 滤镜进行缩放。如 ST.2084 PQ 到 Bt.709：</p>
            <pre><code class="text-smaller language-powershell">
ffmpeg.exe -i &lt;源_HDR10_r2020_ST2084_UHD_24fps_1000nit.mov&gt;
-vf "format=yuv444p12le,
zscale=rin=tv:r=full:tin=smpte2084:min=bt2020nc:pin=bt2020,
zscale=transfer=linear,tonemap=hable:desat=3:peak=1000,
zscale=transfer=bt709:matrix=bt709:primaries=bt709,
format=yuv420p10le"
-color_primaries bt709 -color_trc bt709 -colorspace bt709 -c:v rawvideo -pix_fmt yuv420p10le -strict experimental
&lt;导出无损_yuv444p10le_bt709.yuv&gt;
            </code></pre>

            <h3>VapourSynth 传递参数</h3>
            <h4>R.54——API 3.0:</h4>
            <pre><code class="text-smaller language-powershell">
VSpipe.exe &lt;源.vpy&gt; --y4m - | x265.exe --y4m --input - --output &lt;输出.hevc&gt;
            </code></pre>
            <h4>R.55——API 4.0:</h4>
            <pre><code class="text-smaller language-powershell">
VSpipe.exe &lt;源.vpy&gt; -c y4m - | x265.exe --y4m --input - --output &lt;输出.hevc&gt;

VSpipe.exe &lt;源.vpy&gt; --container y4m - | x265.exe - --y4m --output &lt;输出.hevc&gt;
            </code></pre>

            <h3>ffmpeg 调用 libx265 参数</h3>
            <p>相比直接使用 x265，ffmpeg 通过调用动态链接库的方法做到只用一条命令实现多个视频、音频、字幕和字体，的导入与分别编码，且最后能够封装到一起。同时，这么做可以在不使用 <span>-strict unofficial</span> 命令的情况下直接编码 10bit 或更高位深的视频流。</p>
            <pre><code class="text-smaller language-powershell">
ffmpeg.exe -y -i &lt;源&gt; -c:v libx265 -profile:v &lt;见：输入输出 Input-output IO&gt; -x265-params "high-tier=1:preset=slow:me=umh:subme=5:merange=48:weightb=1:bframes=5:ref=3" -fps_mode passthrough -c:a copy &lt;输出.mp4/mkv&gt;
            </code></pre>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：ffmpeg 常用操作</button>
            <div class="coll-content">
                <h4>ffmpeg 封装流文件</h4>
                <p class="text-gray-side">封装字幕与字体时，需要格外注意检查封装文件与流的兼容性，以及目标播放设备与封装文件的兼容性：<a href="https://en.wikipedia.org/wiki/Comparison_of_video_container_formats">Comparison of video container formats</a></p>
                <pre><code class="text-smaller language-powershell">
ffmpeg.exe -i &lt;视频轨1&gt; -an -c:v copy -i &lt;音轨1&gt; -c:a copy -i &lt;音轨2&gt; -c:a copy -i &lt;字幕轨1&gt; -c:s copy -i &lt;字幕轨2&gt; -c:s copy -i &lt;字体1&gt; -c:t copy &lt;输出.mkv&gt;
                </code></pre>

                <h4>ffmpeg 替换音频流</h4>
                <p class="text-gray-side">通过 itoffset 实现延迟对齐</p>
                <pre><code class="text-smaller language-powershell">
ffmpeg.exe -i &lt;封装文件&gt; -i &lt;新音轨&gt; -c:v copy -map 0:v:0 -map 1:a:0 -c:a copy -itsoffset &lt;秒数&gt; &lt;输出封装文件&gt;
                </code></pre>

                <h4>ffmpeg .ass 字幕渲染</h4>
                <pre><code class="text-smaller language-powershell">
ffmpeg.exe -i &lt;源&gt; -filter_complex "ass='F\:/字幕.ass'" &lt;输出.mp4&gt;
                </code></pre>

                <h4>ffmpeg 缩放滤镜</h4>
                <pre><code class="text-smaller language-powershell">
-sws_flags bicubic/bitexact/gauss/bicublin/lanczos/spline/+full_chroma_int/+full_chroma_inp/+accurate_rnd

ffmpeg.exe -i &lt;源&gt; -s 1280x720 -sws_flags bitexact+full_chroma_int+full_chroma_inp+accurate_rnd &lt;输出.mp4&gt;
                </code></pre>

                <h4>ffmpeg thread_queue_size 过小警告</h4>
                <p class="text-gray-side">在串流（如上游程序通过管道发给 ffmpeg）用途中，如果 ffmpeg 设置的“每线程使用内存”小于上游发送带宽的峰值，就会面临丢包情况，设置 <code>-thread_queue_size</code> 参数，使 ffmpeg 额外占用一个专门用于读取数据包的线程即可。</p>
                <pre><code class="text-smaller language-powershell">
ffmpeg.exe &lt;串流方式导入视频&gt;	-thread_queue_size &lt;源平均码率 kbps ÷ CPU 占用核心数&gt;
                </code></pre>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：命令行工具技巧</button>
            <div class="coll-content">
                <h4>报错导出到文件</h4>
                <p class="text-gray-side">指定 2&gt; 相关的 Bash、Terminal、CMD/PowerShell 内置命令即可实现</p>
                <pre><code class="text-smaller language-powershell">
*.exe &lt;命令&gt; 2&gt;&1 | tee &lt;桌面路径&gt;\报错.txt

*.exe &lt;命令&gt; 2&gt;&1 | tee &lt;桌面路径&gt;\报错.txt

*.exe &lt;命令&gt; 2&gt; &lt;桌面路径&gt;\报错.txt
                </code></pre>

                <h4>压制时退出并封装现有内容到文件</h4>
                <p class="text-gray-side">Ctrl+C（编码器有一定概率不支持）</p>
            </div>

            <h2 id="h2-2">视频的压制（节选自 x264 教程）</h2>
            <ol>
                <li><b>打开编码器</b>
                    <ul>
                        <li>用户可以通过多种方法打开编码器：
                            <ul class="text-smaller">
                                <li>如果编码器内置了如 Lavf 的解封装和解码动态链接库，则编码器可以自动解封装、解码和封装视频文件：
                                    <ul class="text-smaller">
                                        <li>GUI 软件通过发送 CLI 命令，或者使用像 Bash/CMD 这样的 CLI 工具来打开编码器程序。</li>
                                        <li>编码器通常根据输出文件的后缀名自动封装视频文件。</li>
                                    </ul>
                                </li>
                                <li>如果编码器没有内置解封装解码功能，则通常会使用 ffmpeg 内部的解封装工具和编码器。
                                    <ul>
                                        <li>可以使用 pipe 将上游如 ffmpeg、VapourSynth、avs2yuv 连接到下游如 x264/5 的编码器</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li><b>解封装和解码</b>
                    <ul>
                        <li>解封装解码工具将已解压缩的 YUV for MPEG 或 RAW 格式视频流传递给编码器，编码器得到输入信号。
                            <ul class="text-smaller">
                                <li>如果输入是 RGB24 的 RAW 色彩空间视频流，通常需要使用编码器内置的色彩空间转换功能将其转换为 YUV 格式。</li>
                                <li>如果编码器是录像设备的一部分，则需要根据录像设置将视频流拆分为视频帧。</li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li><b>编码过程</b>
                    <ul>
                        <li><b>前瞻进程</b>：Lookahead 从更小的分辨率预先分析未来几帧的复杂度、运动和场景切换 scenecut 的估计。</li>
                        <li><b>分帧/帧类型决策</b>：根据前瞻进程的结果和关键帧间隔 keyframe interval 设置关键帧 I 帧与参考帧 P-B 帧。</li>
                        <li><b>粗分块</b>：
                            <ul>
                                <li>x264 中粗分到宏块 Macroblock MB</li>
                                <li>x265 中粗分到编码树单元 Coding Tree Unit CTU </li>
                            </ul>
                        </li>
                        <li><b>动态搜索</b>：Motion Estimation ME 找到当前帧与参考帧之间的相似区域，并为每个块分配动态向量</li>
                        <li><b>运动补偿</b>：Motion Compensation MC 对比实际画面与搜索到的向量生成预测块，并补偿精度达¼子像素精度的预测帧对齐偏差</li>
                        <li><b>细分块</b>：根据 MEMC，进一步细分宏块或编码树单元到最小的 4x4 编码块上。</li>
                        <li><b>帧间残差编码</b>：对比实际画面与动态搜索与补偿后所得的图像，得到残差，并对残差进行变换和量化，存储到 P-B 帧上，在解码时与 I 帧叠加以得到原始画面。</li>
                        <li><b>帧内预测</b>：在 I 帧或 P 帧的 I 块上，从前面步骤中生成的候选夹角、DC、趋平中的最佳模式冗余帧内的块，得到预测块</li>
                        <li><b>帧内残差编码</b>：对比实际画面与帧内预测得到的残差块，进行变换和量化，存储在预测块中，在解码时与预测模式叠加以得到原始画面</li>
                        <li><b>跳过块编码</b>：跳过帧间或帧内残差编码的块，进行变换和量化。</li>
                        <li><b>变换</b>：将图像从空间域转换到低频到高频信号分量系子之间的每个级别，也称为频域。</li>
                        <li><b>量化</b>：根据用户设置的质量级别，削减高频信号分量系子，这一步骤对画质和文件大小影响最大。</li>
                        <li><b>熵编码/文本编码</b>：将变换和量化后的频域分量系子统计为最小可能的二进制数。</li>
                    </ul>
                </li>
                <li><b>生成视频流</b>
                    <ul>
                        <li>编码器将生成的数据流逐个 GOP Group of Pictures 打包，并附加如色彩空间、Supplemental Enhancement Information SEI、Video
                            Usability Information/High Dynamic Range VUI/HDR 等元数据，得到视频流。</li>
                    </ul>
                </li>
                <li><b>封装视频流</b>
                    <ul>
                        <li>用户可以通过多种方法将视频流封装为 .mp4、.mkv、.mov 等格式：
                            <ul class="text-smaller">
                                <li>如果编码器内置了像 Lavf 的解封装解码动态链接库，编码器可以根据输出命令行的文件后缀名自动完成。</li>
                                <li>如果编码器没有内置解封装解码功能，则通常会使用 ffmpeg 内部的编码器和解封装工具，使编码完成后自动封装。</li>
                                <li>可以使用工具如 <a href="http://ffmpeg.org/download.html">ffmpeg</a>、<a href="https://www.videohelp.com/software/MP4Box">MP4Box</a>，<a href="https://mkvtoolnix.download/">MKVToolNix</a> 等来进行封装。</li>
                            </ul>
                        </li>
                        <li>此处包括了封装音频，字幕和字体文件</li>
                    </ul>
                </li>
            </ol>

            <h2 id="h2-3">分块</h2>
            <p>将帧内的像素组合成大的整体，以更多地冗余单个像素的帧间/帧内信息；同时要根据动静态以及图像边缘的变化，将图像细分为足够小的区域，以精确分配量化的强度。可以说既要大，又要小。</p>
            <p>在 High Efficiency Video Coding HEVC 中，帧的下级结构按照分辨率大小分为帧 → 瓦 tile（x265 编码器中暂未实现）/ 条带 slice → 条带分段 slice segment（ss）→ CTU 树单元 Coding Tree Unit → 编码单元 Coding Unit CU。多个 CTU 可以通过瓦 tile 和条带 slice 两种形式构成一帧，后者继承自 x264，代表按左右顺序划分的一排 CTU；前者较新，代表一定宽高范围的一系列 CTU，更适用于根据画面的分布而分配每个分区的码率。</p>
            <div class="align-items-center">
                <img loading="lazy" src="files/block-splitting/Coding-Tree-Unit.png" alt="image1" class="img-medium">
                <p class="text-gray-side mt-0">图：Coding Tree Unit 以及其下 Coding Unit 的划分</p>
            </div>
            <p>编码单元 Coding Unit CU 的大小有 64x64，32x32，16x16 和 8x8，代表逻辑上粗略划分的待编码区域。是 CTU 通过动态搜索 ME 与运动补偿 MC 隔离分块得到的初步细分结构。其中的 U/unit 代表 YCbCr 一体的结构。</p>
            <p>编码块 Coding Block CB 代表单指编码单元中的 Y，Cb 或 Cr 平面。</p>
            <p>每个 CU 通常包含一个或多个预测单元 Prediction unit PU，从而精确地划分出更小的区间。这个区间相对于当前 CU 的大小，所以不用像素值大小表示。具体为默认的 2Nx2N，NxN、启用 rectangle 划分后添加 2NxN，Nx2N、启用不对称划分后添加 2Nx1.5N+2Nx0.5N，0.5Nx2N+1.5Nx2N，2Nx0.5N+2Nx1.5N，1.5Nx2N+0.5Nx2N。亮度 PB 与色度 PB 的划分方法可以是不同的。</p>
            <div class="align-items-center">
                <img loading="lazy" src="files/block-splitting/Prediction-Unit.png" alt="image2" class="img-medium">
                <p class="text-gray-side mt-0">图：pu 的 4 种对称 rectangular 和 4 种不对称 asymmetric 划分</p>
            </div>
            
            <p class="same-line">变换单元 Transform unit TU 的划分与 CU 而非 PU 同步，实现变换和量化</p>
            <div class="align-items-center">
                <img loading="lazy" src="files/block-splitting/Transform-Unit.png" alt="image3" class="img-medium">
            </div>

            <p class="same-line">存取单元 Access unit AU 代表解码端用于启动解码的块，通常由 IDR 帧开始，所以一般叫做 IDR-AU</p>
            <br>

            <code class="code-bold">--ctu</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;64/32/16，默认 64&gt;编码树单元最大大小。大则有损压缩效率高，速度慢。一般建议保持默认，除非片有类似 jpeg 边缘损失的老片设<span class="text-blue-emph">32</span>，分辨率特别小的老片设<span class="text-blue-emph">16</span>。</p>
            <code class="code-bold">--min-cu-size</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;32/16，默认 8&gt;通过限制最小 CU 大小以简化计算。其副作用是导致后续步骤中 PU，TU 的划分更大。按照画面细节程度和编码策略设置。</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>4x4 细分块能够有效地隔离动静态画面——默认</li>
                <li>8x8 细分块能够有效地隔离动静态画面——<span class="text-blue-emph">16</span></li>
                <li>16x16 细分块能够有效地隔离动静态画面——<span class="text-blue-emph">32</span></li>
                <li>快速编码——<span class="text-blue-emph">16</span> 或 <span class="text-blue-emph">32</span></li>
            </ul>
            <code class="code-bold">--rect --amp</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，受 limit-modes 限制，<span class="text-red-emph">amp 需 rect</span>&gt;PU 的对称与不对称细分块，用较大到大量的时间换取画质和压缩率。使用前考虑：</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>画面中有大量面积小于 4x4 细分块的细节——<code><span class="text-blue-emph">--rect</span></code></li>
                <li>画面中有大量动态细节，包括文本、棱角、纹理、破片等 4x4 细分块也难以隔离的高低频画面——<code><span class="text-blue-emph">--amp</span></code></li>
            </ul>
            
            <h2 id="h2-4">变换</h2>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：傅里叶级数</button>
            <div class="coll-content">
                <h3>傅里叶级数 Fourier Series</h3>
                <p>波形有正弦波 sinusoidal / sine，余弦波 co-sinusoidal / cosine，直流波 direct current / DC，三角波，方形波，以及各种各样的噪声波等等。两波形相加能够得到中间态，通过修改其中波形的振幅强度还可以微调合成的中间态。因此，理论上只要有足够多的可调节波形，就可以让合成的中间态逼近原始波形，甚至做到完全一样。</p>
                <p>除了一条横线以外，波形一般取自余弦 <span class="text-blue-math">\(\cos(x)\)</span> 或正弦 <span class="text-blue-math">\(\sin(x)\)</span>。这两者自带周期循环，通过单纯累计 <span class="text-blue-math">\(\cos(x)\)</span> 可以得到 cosine 的级数：</p>
                <div class="align-items-center">
                    <img loading="lazy" src="files/transforming/cosine-series.png" alt="image4" class="img-medium">
                    <p class="text-gray-side">图：此处使用 cos(πx) 以缩放到 0~2，2~4 为一周期，频率 n 限制范围 1-9 以保证可视化</p>
                </div>
                <p>正弦和余弦函数支持在坐标系中的频率周期缩放，如 <span class="text-blue-math overflow-auto">\(\cos(πx)\)</span> 可以将其缩放到每周期对齐一般坐标系的 x 轴，如果改成 <span class="text-blue-math overflow-auto">\(\cos(2πx)\)</span> 则可将其周期缩短一倍，即频率增加一倍。这里我们用 <span class="text-blue-math overflow-auto">\(\cos(nπx)\)</span> 来与要变换波形的长度 n 对齐。</p>
                <ul class="overflow-auto">
                    <li>原波形可能会有 y 轴偏移（高 <span class="text-blue-math overflow-auto">\(h\)</span>），可以从 <span class="text-blue-math overflow-auto">\(\cos(nπx) + h\)</span> 还原</li>
                    <li>原波形可能会有 x 轴偏移（相位 <span class="text-blue-math overflow-auto">\(\phi\)</span>），可用 <span class="text-blue-math overflow-auto">\(\cos(nπx + \phi_n)\)</span> 还原（每个波形的相位可能不一样，所以用下标 n 表示）</li>
                    <li>最后逐个采样点地乘进原始波形，得到变换结果 <span class="text-blue-math overflow-auto">\(a_n \cos(nπx + \phi_n) + h\)</span></li>
                </ul>
                <p>如果将 <span class="text-blue-math">\(a_n\)</span> 随频率 <span class="text-blue-math">\(n\)</span>变化的状态用坐标系表示，就得到了“频域坐标系”：</p>
                <div class="align-items-center">
                    <img loading="lazy" src="files/transforming/frequency-domain.png" alt="image5" class="img-medium">
                    <p class="text-gray-side mt-0">图：时间域的周期波形映射到频域各个级数（频率 n）的振幅强度 amplitude <span class="text-blue-math">\(a_n\)</span>。来源 <a href="https://edu.svet.gob.gt/fourier-transform-hh-0jVkQOhD">edu.svet.gob.gt</a></p>
                    <img loading="lazy" src="files/transforming/frequency-domain-2.png" alt="image6" class="img-medium">
                    <p class="text-gray-side mt-0">图：逼近方形波的各个级数（频率 n）以及振幅强度。来源 <a href="https://edu.svet.gob.gt/fourier-transform-hh-0jVkQOhD">edu.svet.gob.gt</a></p>
                </div>
                <p>而标准写法为：</p>
                <span class="text-blue-math overflow-auto">\[f(t) =
                    \frac{a_0}{2} + \sum_{n=1}^{\infty} \left( a_n \cos(n\omega t) \right) =
                \]\[
                    h + \sum_{n=1}^{\infty} \left( a_n \cos(n \frac{2\pi}{T} t) \right)
                \]
                </span>
                <ul class="overflow-auto">
                    <li>其中 <span class="text-blue-math">\(x\)</span> 换成了 <span class="text-blue-math">\(t\)</span>，代表时域信号的时间轴</li>
                    <li><span class="text-blue-math">\(\frac{a_0}{2}\)</span> 代替了高度偏移 <span class="text-blue-math">\(h\)</span></li>
                    <li><span class="text-blue-math">\(\omega = \frac{2\pi}{T}\)</span> 代表波形从<span class="text-blue-math">\(\pi\)</span>周期缩放到整数周期，接着缩放到输入信号长度中的基本宽度 <span class="text-blue-math">\(\frac{1}{T}\)</span></li>
                    <li>由于 <span class="text-blue-math">\(\cos(\omega t + \phi_n) = \cos(\omega t) \cdot \cos(\phi_n)\)</span>，所以拆分出 <span class="text-blue-math">\(\cos(\phi_n)\)</span>，乘进 <span class="text-blue-math">\(a_n\)</span> 里：<span class="text-blue-math">\(a_n = a_n \cdot \cos(\phi_n)\)</span>，而简化成了 <span class="text-blue-math">\(a_n\)</span></li>
                </ul>
                <p>当然，理解这个式子背后的理论就足够了，说不定式子非得这样写，原因到底不过是为了好看...</p>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：均方根 RMS</button>
            <div class="coll-content">
                <h3>均方根 Root Mean Square（RMS）</h3>
                <p>统计中常用的一种数据量化，用于表示一组数据平均值的平方根。对于一个包含 N 个值的数据集<span class="text-blue-math">\( \{ x_1, x_2, \ldots, x_N \} \)</span> </p>
                <span class="text-blue-math overflow-auto">\[ \text{RMS} = \sqrt{\frac{1}{N} \sum_{i=1}{N} x_i^2} \]</span>
                <p>具体到 DCT 变换，对于 N×N 块 <span class="text-blue-math">\( f(x,y) \)</span> 的均方根以表示为：</p>
                <span class="text-blue-math overflow-auto">\[ \text{RMS}_{f(x,y)} = \sqrt{\frac{1}{N^2}\sum_{x=0}^{N-1} \sum_{y=0}^{N-1} f(x, y)^2} \]</span>
                <p>DCT 变换后，DCT 系子 <span class="text-blue-math">\( T(u,v) \)</span>的均方根为：</p>
                <span class="text-blue-math overflow-auto">\[ \text{RMS}_{\text{DCT}} = \sqrt{\sum_{u=0}{N-1} \sum_{v=0}^{N-1} C(u, v)^2} \]</span>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：归一化/基本单位化 Normalize</button>
            <div class="coll-content">
                <h3>归一化/基本单位化 Normalize</h3>
                <p>将数据缩放到基本单位大小，以便计算和对比的处理。<span class="text-blue-math">\( \alpha(u) \)</span>和 <span class="text-blue-math">\( \alpha(v) \)</span> 两个缩放值来对齐，使得 <span class="text-blue-math">\( \text{RMS}_{\text{DCT}} = \text{RMS}_{f(x,y)} \)</span>：</p>
                <span class="text-blue-math">\[ \alpha(u), \alpha(v) = \begin{cases} \frac{1}{\sqrt{N}} & \text{if } u,v = 0 \text{ (DC)} \\ \frac{1}{\sqrt{2N}} & \text{if } u,v \neq 0\text{ (AC)} \end{cases} \]</span>
                <p>而在 JPEG 中：</p>
                <div class="overflow-auto"><span class="text-blue-math">\[ \alpha(u), \alpha(v) = \begin{cases} \frac{1}{\sqrt{2}} \approx 0.7071 & \text{if } u,v = 0 \text{ (DC)} \\ 1 & \text{if } u,v \neq 0 \text{ (AC)} \end{cases} \]</span></div>
            </div>

            <button type="button" class="collapsible border-main rounded-3 my-3">点击展开/折叠内容：一维傅里叶变换 1DFT</button>
            <div class="coll-content">
                <div class="row">
                    <div id="LR-UD-001" class="col-8">
                        <h3>一维傅里叶变换 1D Fourier Transform</h3>
                        <p>一种理解方法为：将信号分段或整体视为一个周期，再设定一条从最长周期（起伏很慢的周期线，如 <span class="text-blue-math">\(\cos(0.001x)\)</span>）开始的函数，穷举所有的相位，再穷举所有的振幅，而后记录匹配程度；再缩短一点周期，再穷举所有的相位，...，如此往复直到所有频率、相位、振幅的匹配程度被记录下来。</p>
                        <p>逆变换时，根据每个周期频率所记录的的相位和振幅生成这些波形，再加到一起即可转换回原始信号。计算过程中可能存在信号反相情况，因此还会绝对值的操作。</p>
                    </div>
                    <img loading="lazy" src="files/transforming/Fourier-Transform-Phenomenons.png" alt="image7" id="LR-UD-002" class="img-medium img-right col-4 mb-auto">
                </div>
            </div>

            <code class="code-bold">--limit-tu</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~4 默认关，<span class="text-red-emph">需 tu-intra/inter-depth 大于 1</span>&gt;提前退出 tu 分块，以量化/残差编码质量为代价提速。<a href="https://forum.doom9.org/showthread.php?p=1963250#post1963250">tu 大则易出现量化涂抹涂抹</a>，不利于暂停画质。</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li><span class="text-blue-emph">1</span> 一般，画质编码，取分裂/跳过中花费最小的</li>
                <li><span class="text-blue-emph">2</span> 以同 ctu 内的首个 tu 分裂次数为上限</li>
                <li><span class="text-blue-emph">3</span> 快速编码取帧内帧间附近 tu 分裂平均次数为上限</li>
                <li><span class="text-blue-emph">4</span> 不推荐，将 3 作为未来 tu 的分裂上限，相比 0+20% 速度</li>
            </ul>
            <code class="code-bold">--rdpenalty</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~2，默认关，<span class="text-red-emph">需 tu-intra-depth 大于 1</span>&gt;与 limit-tu 相反，强制 tu 分块细化以增加算力损耗并降低量化涂抹。可理解为 tu 分块的下限，例如高 limit-tu，高 crf 时设 2，避免 32x32tu 量化效果太强画面糊掉。</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li><span class="text-blue-emph">1</span> 提高率失真代价而减少 32x32tu 出现概率</li>
                <li><span class="text-blue-emph">2</span> 强制 32x32tu 分块</li>
                <li><span class="text-red-emph">32x32 的帧内 cu 需 tu-intra-depth 2</span></li>
                <li><span class="text-red-emph">64x64 帧内 cu 需 tu-intra-depth 3</span></li>
            </ul>
            <code class="code-bold">--tu-intra-depth --tu-inter-depth</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 1~4，默认 1，<span class="text-blue-emph">配合 limit-tu</span>&gt;空间域 tu 分裂次数上限，默认只在 cu 基础上分裂一次。决定量化质量所以建议开高，建议一般情况设 2，保画质设 3~4。</p>
            <code class="code-bold">--max-tu-size</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;32/16/8/4，默认 32&gt;大 tu 使压缩高而慢，以及瑕疵检测能力越差。码率换时间加画质。编码已有边缘损失的老片可搭配<span class="text-blue-emph">ctu 32</span>与<span class="text-blue-emph">max-tu-size 16</span></p>

            <h2 id="h2-5">动态预测 Motion Prediction（MP）</h2>
            <p>在参考帧（P-B 帧）的预测单元 Prediction Unit（PU）上，动态搜索（ME）之前，起到<i>提供动态搜索起点</i>功能的预测算法。x264 使用了 <code>--direct</code> 指定。x265 中则使用了更高级的 AMVP + Merge 算法。</p>
            <p>视频里往往会有占据画面不小的物件朝着一处平移，在视频帧中表现为“某个区域的分块拥有高度相似的运动向量”。这些重复性的动态向量分布规律肉眼可见，而动态搜索只能通过不断地计算差异（MSE，率失真代价）而一个一个方向和大小地把向量给试出来。这显然不如通过预测而快速地找出一组方向与大小（然后让整数像素动态搜索从这里开始微调到整数像素精度）直截了当。</p>
            <p>由于动态向量预测得到的向量本身就已经足够靠谱，因此编码器会以“预测动态向量（PMV）+ 动态向量差（MVD）”的形式记录每个帧间块的动态信息，再冗余掉相同的预测动态向量，从而进一步提高压缩。管一个动态向量的信息不多，但放眼到整个视频的所有帧间参考时，质变也就产生了。</p>

            <h4>并合模式预测 Merge Mode</h4>
            <p id="LR-UD-011" class="col-8">为当前块提供一个运动信息候选列表。列表的 5 个参选块（Candidate），2 个备选块来自空域和时域相邻编码块（Neighbour CB）的运动信息（不是预测块 PB 或帧内编码的 CB，否则没有动态向量）。当前块合并多数相邻块的动态信息（动态向量和参考帧索引），<i>直接略过动态搜索</i>，降低完算性（Deterministic），在匀速移动和静止的画面中就能找到可靠的动态向量。</p>
            <p>由于并合模式跳过了动态搜索，因此编码块中的“动态信息”即“对某个相邻块的引用注释”。</p>
            <div class="align-items-center">
                <img loading="lazy" src="files/amvp-merge/Merge-Mode.png" alt="image21" class="img-medium">
            </div>
            <h4>高级动态向量预测 Advanced Motion Vector Prediction（AMVP）</h4>
            <p>在并合模式预测之上，进一步地对比相邻编码块，包括帧间相邻编码块的预测动态向量（PMV），并进行“动态预搜索”（检查参选列表里的动态向量是否匹配，但不是正式的整数像素动态搜索步骤），从而给出准确的预测动态向量（PMV），以及整数像素动态搜索（ME）起点。</p>
            <div class="align-items-center">
                <img loading="lazy" src="files/amvp-merge/Simplified-AMVP.png" alt="image22" class="img-medium">
            </div>

            <h5>空间动态向量预测 Spatial MVP</h5>
            <p>限定必须指向同一张被参考帧，按顺序检查列表中帧内相邻 PU 的动态向量是否当前 PU 匹配：</p>
            <ol class="mt-0">
                <li>左下角帧内邻 PU</li>
                <li>左侧帧内邻 PU</li>
                <li>右上角帧内邻 PU</li>
                <li>上方帧内邻 PU</li>
                <li>左上角帧内邻 PU</li>
            </ol>
            <p>当列表中的 PU 不指向同一张被参考帧时，尝试根据帧间距离进行缩放调整匹配，如果差异或帧间距离太大则换到下一个方法。</p>

            <h5>空间动态向量预测 Temporal MVP</h5>
            <p>以上方法没找到时，按顺序检查列表中 PU 的动态向量是否当前 PU 匹配：</p>
            <ol class="mt-0">
                <li>同位帧间临 PU</li>
                <li>右下角帧间临 PU</li>
            </ol>
            <p>直接尝试根据帧间距离进行缩放调整匹配，如果差异或帧间距离太大则换到下一个方法。</p>

            <h5>补充不足的候选列表</h5>
            <p>没凑齐的候选列表项中写入零运动向量（0,0）。AMBP 需要至少 2 个候选数量。</p>

            <h5>找出最佳候选作为 PMV</h5>
            <p>计算候选的率失真代价（RD Cost），失真最小的候选最精确。<p>
            <p class="text-gray-side">注：率失真优化计算见下方版块的说明。</p>

            <code class="code-bold">--max-merge</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~5，默认 2&gt;重设 merge mode 被选参考块的数量，时间换质量。建议高压编码设<span class="text-blue-emph">4</span>，其它可设<span class="text-blue-emph">2，3</span>。</p>
            <code class="code-bold">--early-skip</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关&gt;首先检查 2Nx2N 结构的并合被选块是否有匹配的动态向量，找不到则跳过 AMVP，让整数像素动态搜索（ME）自己找。</p>

            <h2 id="h2-6">动态搜索 Motion Estimation（ME）</h2>
            <!-- x264 教程副本，更改需手动同步 { -->
            <p class="text-gray-side">注：它的专业术语是运动搜索、运动估计。</p>
            <p>在连续帧间画面中，进行运动估计的整数像素精度动态信息搜索步骤，涵盖了多种搜索算法，也被用于不同的信号处理领域。具体步骤是以被参考帧内的已编码块（Coded Block）为起点，尝试通过位移来匹配相邻帧的画面，从而找到一个失真最小的向量 Direction of minimal distortion（DMD），这个向量就是整数动态向量。</p>
            <p>为了找到可用的最小失真朝向，并且避免进行算力占用巨大的全搜索（Exhausive Search），动态搜索演化出了多种匹配的图案和算法。其中，较为聪明的动态搜索算法是多级算法，它们首会先尝试在较大范围进行粗略搜索，再以大致最佳区域为中心进行精细搜索，从而（包括在噪点干扰下）多快好省地找到整数动态向量。在整数动态搜索之后，还会由子像素动态搜索（Sub-pel Motion Estimation）来进一步做对齐，最终，这个动态向量被用于冗余预测块，以及对高动态画面提高有损压缩强度，从而压缩体积并优化码率的分配。</p>
            <p>如果动态搜索的过程有缺失或不够理想，参考帧与分块的建立会变得低效，码率分配也会变得不够合理，导致画质的降低和码率的增加。</p>
            <!-- } -->
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：十字搜索，大小菱搜索，UMH 搜索算法</button>
            <div class="coll-content">
                <div class="align-items-center">
                    <img loading="lazy" src="files/motion-estimation/Jain&Jain-Search.png" alt="image9" class="">
                    <p class="text-gray-side mt-0">图：传统的 Jain & Jain 十字搜索。</p>
                    <img loading="lazy" src="files/motion-estimation/LDSP&SDSP-Search.png" alt="image10" class="">
                    <p class="text-gray-side mt-0">图：大小菱搜索。x264/5 中，六边形搜索 me hex 将 LDSP 的上下左右斜 8 个外点减到 6 个，SDSP 的细化规则不变。</p>
                    <img loading="lazy" src="files/motion-estimation/Uneven-multi-hexagon-Search.png" alt="image11" class="">
                    <p class="text-gray-side mt-0">图：umh 搜索。</p>
                </div>
            </div>

            <code class="code-bold">--analyze-src-pics</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，推荐关&gt;动态搜索不再等待前瞻进程、分帧/帧类型决策和粗分块（包括 WPP）后的结果，而是直接搜索源帧像素。这样可以将动态搜索在独立线程上运行，提高并行效率；由于编码器最终编码的就是处理后的帧，而不是原帧，因此使用该选项反而会导致动态搜索准确度下降，降低画质。见 <a href="https://forum.doom9.org/showthread.php?s=3034a4a73f990075a4cd088d9902e9f3&p=1797539#post1797539">doom9 说明帖</a>。</p>
            <code class="code-bold">--me</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;hex/umh/star/esa/full，推荐 umh&gt;搜索算法，umh 平衡，star 四角星搜索之后收益递减，sea 是优化过的 x264 esa 穷举，但收益递减仍大。umh 和 star 通过多种分辨率大小的查找范围，减轻了动态噪点对传统搜索算法的干扰</p>
            <code class="code-bold">--merange</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数，推荐 4 的倍数，<span class="text-red-emph">需 me</span>&gt;<span class="text-blue-emph">完全取决于 ME 算法和分辨率</span>，过大会因「找不到更好，找到也是错」而损失画质和压缩。</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>1920x1080 下推荐<span class="text-blue-emph">48</span>左右</li>
                <li>3840x2160 下推荐<span class="text-blue-emph">52</span>左右</li>
                <li>me hex 下设<span class="text-blue-emph">16</span></li>
                <li>me umh-star 设<span class="text-blue-emph">≥32</span></li>
            </ul>
            <code class="code-bold">--no-temporal-mvp</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;关 P-B 条带的动态搜索，除直播外不推荐。</p>
            <code class="code-bold">--hme-search</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;hex/umh/star/esa/full，<span class="text-red-emph">关 me</span>&gt;原画做三种分辨率，分别查找搜索动态信息，能够更好地消除动态噪点所导致的假动态向量。</p>
            <code class="code-bold">--hme-range</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;三整数，<span class="text-red-emph">需 hme-search</span>，推荐默认<span class="text-blue-emph">16,32,48</span>&gt;对应 1/16，¼和全分辨率三画面。</p>
            
            <h3>绝对变换差和 SATD</h3>
            <p>Sum of absolute transformed difference 为两个变换块间做差，取和，取绝对值的步骤：</p>
            <ol>
                <li>首先计算两个块 B 的插值，记做残差块 D：<span class="text-blue-math">\(\text{D}(x,y) = B(x,y) - B\prime(x,y)\)</span></li>
                <li>然后通过如 DCT 变换，得到变换残差块：<span class="text-blue-math">\(T(D)\)</span></li>
                <li>最后，变换残差块的每个像素取绝对值和：<span class="text-blue-math">\(\text{SATD}(B,B\prime) = \sum_{x=0}^{n-1}{\sum_{y=0}^{n-1}}| T(D(x,y)) |\)</span></li>
            </ol>
            <p class="text-gray-side">注：为了简化所以写作 <span class="text-blue-math">\(T(D(x,y))\)</span>，实际这样相当于每加一个像素值就要变换一遍</p>

            <h2 id="h2-7">子像素运动补偿</h2>
            <p>动态预测的精度比起原画还差一点（最高 1px）导致了预测帧相比原画会欠缺大量的纹理细节；在此之上还常遭到动态噪点的干扰劫持。动态补偿 Motion Compensation MC 通过对比原画与预测块得到残差，并根据残差的分布动态向量的精度到¼子像素，使“精加工预测块”的画面残差尽可能地缩小，得到足够准确的预测帧。</p>
            <p>至于对抗动态噪点，大体上是允许真正移动的物件（所涵盖的分块）有运动向量，拦截噪点在静止画面上的孤立运动向量，即「允动之移，防静所变」解决。</p>
            <ol class="overflow-auto">
                <li>此处省略以上帧画面与帧间向量表中的动态向量的和，得到一系列粗加工预测块的步骤</li>
                <li>使用有限冲激响应插值滤镜 FIR filter 放大画面以便后面对齐</li>
                <li>将“粗加工预测块”与源视频所对应的画面使用 SATD 做差，得到当前的误差程度</li>
                <li>当前向量的 x，y 分量分别加减 ½，¼ 像素（插值放大的画面中是整数像素），即分别让这些块对比原画跑一遍 SATD：
                    <ul class="text-smaller">
                        <li><span class="text-blue-math">\(B\prime(x+½,y),B\prime(x,y+½),B\prime(x+½,y+½),B\prime(x+¼,y),B\prime(x,y+¼),B\prime(x+¼,y+¼),B\prime(x+¼,y+½),B\prime(x+½,y+¼)\)</span></li>
                    </ul>
                </li>
                <li>选出 SATD 误差值最小的块——中的 x，y 分量，纠正帧间向量表的动态矢量，完成补偿</li>
            </ol>
            <p class="text-gray-side">注：在参数值强度给高后，上述的对比步骤改成用 me hex 之类的动态搜索算法来找对齐</p>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：补充 x264 的 6tap 滤镜，x265 的 8tap、7tap 和 4tap 滤镜算法表格：</button>
            <div class="coll-content">
                <div class="row">
                    <div id="LR-UD-005" class="col-10 align-items-center">
                        <table class="table-center">
                            <tr>
                                <th class="px-1">编码器</th>
                                <th class="px-1">平面——块类型</th>
                                <th class="px-1">范围精度</th>
                                <th class="px-1">插值方法</th>
                            </tr>
                            <tr class="t-light-gray">
                                <td class="px-1">x264 官方</td>
                                <td class="px-1">亮度 Y</td>
                                <td class="px-1">½ 像素（hpel）</td>
                                <td class="px-1">6 tap FIR</td>
                            </tr>
                            <tr>
                                <td class="px-1">x264 官方</td>
                                <td class="px-1">亮度 Y</td>
                                <td class="px-1">¼ 像素（qpel）</td>
                                <td class="px-1">双线性插值（Bi-lerp）</td>
                            </tr>
                            <tr class="t-light-gray">
                                <td class="px-1">x264 官方</td>
                                <td class="px-1">色度 C</td>
                                <td class="px-1">hpel+qpel</td>
                                <td class="px-1">上下左右加权平均</td>
                            </tr>
                            <tr>
                                <td class="px-1">x265 官方</td>
                                <td class="px-1">亮度 Y</td>
                                <td class="px-1">hpel+qpel</td>
                                <td class="px-1">上下左右加权平均</td>
                            </tr>
                            <tr class="t-light-gray">
                                <td class="px-1">x265 官方</td>
                                <td class="px-1">亮度 Y</td>
                                <td class="px-1">¼像素（qpel）</td>
                                <td class="px-1">两种 7tap FIR</td>
                            </tr>
                            <tr>
                                <td class="px-1">x265 官方</td>
                                <td class="px-1">色度 C</td>
                                <td class="px-1">hpel+qpel</td>
                                <td class="px-1">4tap FIR</td>
                            </tr>
                        </table>
                        <p class="text-gray-side mt-0">表：x264/5 的 h~qpel 插值计算（实现了浮点→整数变量的程序优化）</p>
                    </div>
                    <img loading="lazy" src="files/motion-compensation/hpel-qpel-interpolation.png" alt="image12" id="LR-UD-006" class="img-small img-right col-2 mb-auto" >
                </div>
            </div>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：补充 x264 的 6tap 滤镜，x265 的 8tap、7tap 和 4tap 滤镜算法细节：</button>
            <div class="coll-content">
                <div class="align-items-center">
                    <img loading="lazy" src="files/motion-compensation/7tap-8tap-interpolation-1.png" alt="image13" class="img-medium">
                    <p class="text-gray-side mt-0">图：此“子像素”特指插值出的 half-pixel(hpel)½像素，及 quarter-pixel(qpel)¼像素。</p>
                </div>
                <div class="align-items-center">
                    <img loading="lazy" src="files/motion-compensation/7tap-8tap-interpolation-2.png" alt="image14" class="img-medium">
                    <p class="text-gray-side mt-0">图：Y 平面 FIR 插值和 subme 并行，调用 8²或 16²块的横/纵向参考源。若 subme 所得动态的：</p>
                </div>
                <ul>
                    <li>向量横分量等于 0: [d][n] 分别用 7tapα或β采样整像素 [A]</li>
                    <li>向量横分量非 0: [f][q] 分别用 7tapα或β采样子像素 [b]</li>
                    <li>向量纵分量等于 0: [a][c] 分别用 7tapα或β采样整像素 [A]</li>
                    <li>向量纵分量非 0: [i][k] 用 8tap 分别采样子像素 [a][c]</li>
                </ul>
            </div>

            <code class="code-bold">--subme</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数范围 1~7，默认 2&gt;根据源帧率借下表判断。注：x264 的 rdo 选项和 subme 并用，所以与 x265 不通用；SATD 算法见 x264 教程。</p>

            <table class="align-items-center table-center text-smaller mt-3">
                <tbody>
                    <tr>
                        <th class="px-1">范围——开 RDO</th>
                        <th class="px-1">推荐</th>
                        <th class="px-1">hpel 迭代</th>
                        <th class="px-1">hpel 搜索</th>
                        <th class="px-1">qpel 迭代</th>
                        <th class="px-1">qpel 搜索</th>
                        <th class="px-1">统计法</th>
                    </tr>
                    <tr class="t-light-gray">
                        <td class="px-1">30fps</td>
                        <td class="text-blue-emph px-1">3</td>
                        <td class="px-1">二次</td>
                        <td class="px-1">四方向</td>
                        <td class="px-1">一次</td>
                        <td class="px-1">四方向</td>
                        <td class="px-1">SATD</td>
                    </tr>
                    <tr>
                        <td class="px-1">48fps</td>
                        <td class="text-blue-emph px-1">4</td>
                        <td class="px-1">二次</td>
                        <td class="px-1">四方向</td>
                        <td class="px-1">二次</td>
                        <td class="px-1">四方向</td>
                        <td class="px-1">SATD</td>
                    </tr>
                    <tr class="t-light-gray">
                        <td class="px-1">60fps</td>
                        <td class="text-blue-emph px-1">5</td>
                        <td class="px-1">一次</td>
                        <td class="px-1">八方向</td>
                        <td class="px-1">一次</td>
                        <td class="px-1">八方向</td>
                        <td class="px-1">SATD</td>
                    </tr>
                    <tr>
                        <td class="px-1">90fps</td>
                        <td class="text-blue-emph px-1">6</td>
                        <td class="px-1">二次</td>
                        <td class="px-1">八方向</td>
                        <td class="px-1">一次</td>
                        <td class="px-1">八方向</td>
                        <td class="px-1">SATD</td>
                    </tr>
                    <tr class="t-light-gray">
                        <td class="px-1">≥144fps</td>
                        <td class="text-blue-emph px-1">7</td>
                        <td class="px-1">二次</td>
                        <td class="px-1">八方向</td>
                        <td class="px-1">二次</td>
                        <td class="px-1">八方向</td>
                        <td class="px-1">SATD</td>
                    </tr>
                </tbody>
            </table>

            <h3>量化值加权预测 Weighted Prediction</h3>
            <div class="row">
                <div id="LR-UD-007" class="col-10">
                    <p>解决画面淡入淡出（fade）过程中，部分 PU（预测单元，待编码的 Y，Cb，Cr 块）因误参考，导致量化值不统一或参考源指向错误，导致亮度变化不一的块失真问题；分为 P-B 条带用的显加权，和 B 条带用的隐加权。</p>
                    <ul class="text-gray-side">
                        <li>显 Explicit：原画和编码过的参考帧做差，差距越小权重越高</li>
                        <li>隐 Implicit：用参考帧距离做加权平均插值，距离越近权重越高</li>
                    </ul>
                </div>
                <img loading="lazy" src="files/weighted-prediction/Implicit-Weighted-Prediction.png" alt="image15" id="LR-UD-008" class="img-small img-right col-2 mt-3 mb-auto" >
            </div>

            <code class="code-bold">--weightb</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关&gt;启用 B 条带的隐加权预测。注意光线变化和淡入淡出在公开课，电脑录屏，低成本/旧动漫等片源中几乎不存在，这种情况下打开只会浪费性能。</p>

            <h2 id="h2-8">帧间——时域架网搜索</h2>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：一维小波变换 1D Wavelet Transform</button>
            <div class="coll-content">
                <p>让短波像拉链一样划过一维信号，短波所到的时间域与源信号匹配（波形重合）的程度会变化，而变化本身记为时间频域信息。支持更换波形以提取特征（如特征采样式音频降噪滤镜）。解决了傅里叶变换只有空间频域，无法描述信号随时间变化过程的原生缺陷，缺点是分辨率低。详见<a href="https://www.youtube.com/watch?v=jnxqHcObNK4">科普视频</a>。一般用于检测特征片段，如将小波本身塑性为需要的特征，然后划过源波形，得到这些特征的时间域分布和强度变化。</p>
                <div class="align-items-center">
                    <img loading="lazy" src="files/weighted-prediction/Wavelet-Transform-Example.png" alt="image16" class="img-small" >
                    <p class="text-gray-side mt-0">图：用蓝色小波划过红色信号的变换例子</p>
                </div>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：基于提升式小波变换的时域动态补偿 lifting-scheme temporal MC</button>
            <div class="coll-content">
                <div class="row">
                    <div id="LR-UD-009" class="col-8">
                        <p>类似于 crf/abr 模式推演量化值中以 a-b 帧之差做复杂度累计。此处是用以预测 b-c 帧的差，而<span class="text-blue-emph">预测对的更新到低频 L 带，差错的更新到（不再参与下轮预测）的高频 H 带</span>，得 0-1-2，2-3-4，4-5-6 等（prediction）帧以及其 H 带（update）构成第 0 层</p>
                        <p>继续在 L<sub>1</sub>→L<sub>n</sub> 的 1 层向右迭代，分离出所有的 L，H 带，如此实现迭代 n 次即分离 2<sup>n</sup> 帧动静态，以及所有的预测与补偿，故不像传统动态搜索一样受缩放性 scalability（分辨率 vs 搜索范围）限制。是 Scalable Video Codec（SVC）编码的核心算法之一。</p>
                        <p>迭代后的高低频用 LL<sub>1</sub> LL<sub>2</sub> LH<sub>1</sub> LH<sub>2</sub> 表示低到高频的顺序，字母位数代表迭代次数。</p>
                    </div>
                    <img loading="lazy" src="files/weighted-prediction/Lifting-Scheme-Temporal-MC.png" alt="image17" id="LR-UD-010" class="img-medium img-right col-4 mb-auto" >
                </div>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：高斯模糊 Gaussian blur</button>
            <div class="coll-content">
                <p>利用正态分布函数面积不变的特性，通过设定偏差程度 σ 决定正态分布钟型线的梯度：σ 大则钟扁——滤镜中心分到的权重/面积越被更多分到权/面积的旁像素冲淡模糊掉，设计行业常用。见<a href="https://zh.wikipedia.org/wiki/%E9%AB%98%E6%96%AF%E6%A8%A1%E7%B3%8A">维基百科</a>和<a href="https://www.desmos.com/calculator/jxzs8fz9qr">Desmos 互动例</a>。2D 高斯模糊写作：<span class="text-blue-math">
                    $${\displaystyle G(x,y)={\frac {1}{2\pi \sigma ^{2}}}e^{-{\frac {x^{2}+y^{2}}{2\sigma ^{2}}}}}$$
                </span></p>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：中值滤镜 Median filter</button>
            <div class="coll-content">
                <p>和卷积滤镜一样用 n×n 的滤镜格子逐像素扫图，区别在于滤镜中心会被替换为旁像素的中值。如此一来在扫描窗口任意两端几乎一致的像素值会被识别为线段或边缘，中间的像素值会被同化，而平面上的噪点/颗粒就会被抹除，生成仅有平/斜面和完整线条边缘的“模糊”结果。</p>
                <div class="align-items-center">
                    <img loading="lazy" src="files/bilateral-filter/Median-Filter.png" alt="image18" class="img-medium">
                    <p class="text-gray-side">图：中值滤镜，来源：<a href="https://www.researchgate.net/figure/Example-of-Median-Filtering-using-a-33-sampling-window-keeping-border-values-unchanged_fig1_276304662">Research Gate——Andrzej Bargiela</a></p>
                    <img loading="lazy" src="files/bilateral-filter/Median-Filter-Example.jpg" alt="image19" class="img-medium">
                    <p class="text-gray-side">图：中值滤镜效果。见<a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E5%80%BC%E6%BB%A4%E6%B3%A2%E5%99%A8">维基百科</a></p>
                </div>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：双边滤镜 Bilateral filter</button>
            <div class="coll-content">
                <p>将中值滤镜输出作为（2D）高斯模糊的权重蒙版（通过矩阵点除实现动态干涉滤镜强度）；因此平面/斜面/线条本身会决定高斯模糊正态分布钟在对应位置被保留/干涉/隔断的程度</p>
                <div class="align-items-center">
                    <img loading="lazy" src="files/bilateral-filter/Bilateral-Filter.png" alt="image20" class="img-medium">
                </div>
                <code class="code-bold">--mcstf</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，<span class="text-red-emph">仅支持单线程，有残影失真，推荐关</span>&gt;时域动态补偿滤镜 mctf 搭配双阈滤镜的自动降噪，理论上提高细节保真。</p>
            </div>

            <h2 id="h2-9">前瞻进程 Lookahead</h2>
            <p>最先启动，设立关键帧和参考帧，决定了 GOP 划分的初始编码步骤。决定了后续所有步骤的大纲。过程见<a href="../../x264-web-tutorial/HTML/index.html#h2-4">x264 教程网页版</a></p>

            <code class="code-bold">--scenecut</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数，不推荐用&gt;Lookahead 中两帧差距达到该参数值则触发转场。</p>
            <code class="code-bold">--hist-scenecut</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，<span class="text-red-emph">开启后关闭转场检测</span>，<span class="text-blue-emph">10 与 12bit 源可能会导致崩溃</span>，推荐 8bit 下用&gt;亮度平面边缘 + 颜色直方图 SAD 阈值触发转场。x265 v3.5+69 后编码彩色视频，尤其<a href="https://forum.doom9.org/showthread.php?p=1978502">HDR 源中超越 scenecut 精度~20%</a>，降低了正误判（设 I 帧，closed-gop 下帧间冗余效益降低）和负误判（不设 I 帧，分为多个带 I 块的 P 帧预测效益降低），因此除黑白视频外推荐。缺点是超过 8bit 后不稳定，且理论上不应对画质/压缩率有太大影响</p>
            <p class="text-gray-side pl-5 m-0">注：hist-threshold 参数于 x265 v3.5+69 被删。</p>
            <!-- x264 教程副本，需要手动同步更改 { -->
            <code class="code-bold">--rc-lookahead</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;帧数量，范围 1~250，<span class="text-red-emph">需大于 <code>--bframes</code></span>，<span class="text-blue-emph">推荐 keyint÷2</span>&gt;指定 cutree 的检索帧数，通常设在帧率的 2.5~3 倍。高则占用内存增加延迟，低则降低压缩率和平均画质。</p>
            <p class="text-gray-side pl-5 m-0 overflow-auto">注：mbtree/cutree 会自动选择 <code>--rc-lookahead</code> 和 <span class="text-blue-math text-smaller">\( \max\left( \text{keyint}, \max\left( \text{vbv-maxrate}, \text{bitrate}\right)\div\text{vbv-bufsize} \times \text{fps} \right) \)</span> 中最小的值作为检索帧数</p>
            <!-- } -->
            <code class="code-bold">--no-cutree</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;关闭少见 CTU 量化增强偏移。可能只有近无损，<code>--crf</code> 小于 16 才用的到。</p>

            <h3 class="mb-0">P/B 帧推演——Viterbi 最短路径算法</h3>
            <p class="mt-0">见<a href="https://www.nazorip.site/archives/63">x264 教程</a></p>

            <code class="code-bold">--b-adapt</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~2，推荐<span class="text-blue-emph">2</span>&gt;<span class="text-blue-emph">0</span>停用，<span class="text-blue-emph">1</span>快速算法，因当今设备算力够高所以一律<span class="text-blue-emph">2</span>。</p>
            <code class="code-bold">--bframe-bias</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 -90~100，推荐默认&gt;设立 B 帧判定偏移，增大的同时搭配低 pbratio 可增加 B 帧数量，用负值搭配高 pbratio 可以减少 B 帧数量。</p>

            <h3>网络抽象层单元 Network abstraction layer unit（NALU）——参数集</h3>
            <p>网络抽象层单元中含解码配置 profile，level 的数据包。x264 中的视频帧数就是 <span class="text-blue-math"><code>sps->vui.i_num_units_in_tick</code></span> 或 <span class="text-blue-math"><code>sps->vui.i_time_scale÷2</code></span> 所得（÷1 则为分行交错视频）</p>
            <ul class="text-gray-side">
                <li>视频参数集 Video parameter set</li>
                <li>序列参数集 Sequence parameter set-——分枝——负责播放时间戳，显加权与其它特定解码要求</li>
                <li>图参数集 Picture parameter set————分枝——负责解码信息</li>
                <li>条带段 Slice segment—————————分枝——负责防止 ctu 中的错误传播到整个条带，ctu 以上最小的单位</li>
            </ul>

            <code class="code-bold">--opt-qp-pps --opt-ref-list-length-pps</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，<span class="text-red-emph">已知兼容性问题</span>&gt;据上个 GOP 改动当前 PPS 中默认的 qp/ref 参数值，从而整体上优化视频数据结构。纵然符合 HEVC 标准，但解码播放设备，包括视频网站都不兼容。</p>
            <p class="text-gray-side pl-5 m-0">兼容性问题：<a href="https://forum.doom9.org/showthread.php?p=1978837">应该用 hev1 而非 hvc1 封装进 ISO-BMFF</a>。</p>
            <code class="code-bold">--repeat-headers</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关&gt;在流未封装的情况下提供 SPS，PPS 等信息，正常播放 HEVC 源码</p>
            <p class="text-gray-side pl-5 m-0">注：封装文件的科普<a href="https://www.nazorip.site/archives/63">见 x264 教程</a>。</p>

            <h3>HLS 与 Chunked Encoding 串流</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <h4>HTTP 数据块编码协议 Chunked Encoding（1997 年）</h4>
                <p>HTTP/1.1 的一部分。数据块编码允许服务器分段传输视频流的数据块，实现视频的直播、实时聊天等场合。理论上所有平台都支持该协议。</p>

                <h4>HTTP 直播协议 HTTP Live Streaming HLS（2009 年）</h4>
                <p>适用于视频直播和点播，可以根据网络条件和设备性能动态调整视频质量。HLS 还提供了媒体播放列表（M3U8）和分段（TS）的机制，使得它更适合跨互联网传输视频。主流的浏览器、视频播放器和移动设备都兼容 HLS。</p>
            
                <p>总的来说，HTTP Live Streaming（HLS）和 Chunked Encoding 都是 HTTP 协议的一部分。Chunked Encoding 优点在于容易实现以及冷门设备更可能支持，但是在专门的流媒体应用中不如 HTTP Live Streaming（HLS）的功能强大。</p>

                <code class="code-bold">--chunk-start --chunk-end</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，<span class="text-red-emph">需 no-open-gop</span>&gt;start 跨 GOP 打包网络数据包，end 将数据包结尾标注分割。</p>
                <p class="text-gray-side pl-5 m-0">注：由于数据包接收顺序随机，所以只可参考 chunk 数据包之前，而不可参考 chunk 数据包之后的内容，跟 http 串流的数据包编码协议有关</p>
            </div>

            <h3>关键帧</h3>
            <h5>刷新解码帧 Instant decoder refresh IDR</h5>
            <ul class="text-gray-side text-smaller">
                <li>自身储存完整图片，但同时还负责 GOP 间划界分段，播完令解码器清理前 GOP 缓存的大写 I 帧</li>
                <li>清缓存是为了防止参考/内存错误传播，错误可能源自硬件/软件/网络/干扰等</li>
            </ul>
            <h5>随机访问点 Random access point RAP</h5>
            <ul class="text-gray-side text-smaller">
                <li>“访问”代表播出画面前获取数据的过程</li>
                <li>“任意”代表拖进度条，打开直播，使进度条上任意一点都要正常解码的目的，增加码率提升体验</li>
            </ul>
            <h5>CRA/DRA净/脏任意访问 clean/dirty random access</h5>
            <ul class="text-gray-side text-smaller">
                <li>Open-gop 状态下指定包括 GOP 间划界，GOP 内帧间参考，自身储存完整图片的 i 帧</li>
                <li>附近的 rasl/radl 帧与之相对应</li>
                <li>「脏」指一组含 i 块的 P 帧，需要全部解码才能重建出 i 帧。压缩更高但相比 i 帧的解码更容易糊（脏）</li>
            </ul>
            <h5>断链访问帧 Broken link access BLA</h5>
            <ul class="text-gray-side text-smaller">
                <li class="mt-0">open-gop 间划界，访问不相关/不相连 GOP 的特殊 CRA 帧。用于不暂停播放的分辨率切换</li>
            </ul>

            <code class="code-bold">--no-open-gop</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，建议开&gt;不用 cra/bla，增加码率增加兼容性，适合长 GOP 策略。</p>
            <code class="code-bold">--keyint</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数，默认 25&gt;判断新发现的转场距上个 IDR 帧的距离是否短于此值。有两种设定逻辑，而它们给出的画质都一样：</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>设 5 或更高，省了设立一些 IDR 帧拖慢速度。快速编码/直播环境直接设=keyint</li>
                <li>设 1 来增加 IDR 帧的数量，一帧被判转场本来就意味着前后溯块价值不高。而单/双向参考（P/B）帧内可以放置 I 宏块，x264/5 倾向插 P/B 帧。好处是进度条落点在激烈的动作场面更密集</li>
            </ul>
            <code class="code-bold">--fades</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关&gt;找流中的虚实渐变 fade-in，给小到帧间条带，大到整个帧间范围改用 I 条带，并根据渐变后最亮的帧重设码率控制历史记录，解决转场致模糊的问题</p>
            <p class="text-gray-side pl-5 m-0">注：与 weightb 殊路同归但效果更强，增加码率更多。</p>

            <h3>参考帧</h3>
            <h5>RASL 任访略前导，RADL 任仿解前导 random access skipping/decoding lead</h5>
            <ul class="text-gray-side text-smaller">
                <li>打开直播或用户拖动进度条落在 CRA 附近，找不到 I 帧时指定应该解码 decode 还是略过 skip 的标签 P 帧</li>
                <li>启用后，部分引用这些标签 P 帧的 IDR 帧会改变帧类型，以提示这些标签帧位于其之前，而这种 GOP 的解码会与传统 GOP 有一些区别，导致后续剪辑工具链中的兼容性问题</li>
            </ul>

            <code class="code-bold">--ref</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 1~16&gt;多参考帧前后帧数半径，一图流设<span class="text-blue-emph">1</span>。要在能溯全所有块的情况下降低参考面积，所以一般设<span class="text-blue-emph">3</span>就不管了。</p>
            <code class="code-bold">--radl</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数默认 0，小于连续 B 帧，推荐 2~3&gt;原理以及兼容性问题见上。</p>
            <code class="code-bold">--ipratio --pbratio</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点，默认 1.4 1.3&gt;P 帧比 IDR/I，及 B/b 帧相比 P 帧的量化值递增。B 帧双向参考能从更多帧中找到参考源，因此量化强度理应最高：</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>真人录像片源中保持默认</li>
                <li>动漫片源中连续长 B 帧出现几率增多，有时会找不到合适的参考源导致画质损失，用<span class="text-blue-emph">1.2</span>或更小分配一定码率</li>
                <li>可据比例换算帧类型的 qp，如<span class="text-blue-emph">I-qp17</span>，<span class="text-blue-emph">P-qp20</span>，<span class="text-blue-emph">B-qp22</span>即<span class="text-blue-emph">--qp/crf 17 --ipratio 1.1765 --pbratio 1.1</span></li>
            </ul>
            <code class="code-bold">--bframes</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~16&gt;最多可连续插入的 B 帧数量：</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>一般录像/录屏快速，以及视频剪辑素材设<span class="text-blue-emph">3~6</span>以防止录制和剪辑的解码算力要求过高</li>
                <li>电影片源快速设<span class="text-blue-emph">8</span>左右</li>
                <li>低成本动画片源，或播放设备配置或硬解兼容高的话可设在<span class="text-blue-emph">13</span>左右</li>
            </ul>
            <p class="text-gray-side pl-5 m-0">注：bframes 大于 8，同时 keyint 大于 250 会大增内存占用，但也取决于视频分辨率</p>

            <h2 id="h2-10">帧内预测/单图压缩</h2>
            <div class="row">
                <div id="LR-UD-013" class="col-8">
                    <p>在帧间编码完成，重复内容较多的帧变成 P-B 参考帧后，这些 P/B 帧所冗余的数据都会指向 I 帧/I 块上。这些 I 帧帧内也有像大平面，大斜面之类的空间可供冗余。冗余分为补偿参考源，平滑（3-tap/ss），和编码预测块 PB 三步。参考源由预测块的左，上两排像素构成。</p>
                    <ul>
                        <li>补偿解决参考源（因为编码顺序等原因而）缺失，无法判断 PB 与 CB 参考关系的问题</li>
                        <li>平滑预处理据参考源自身像素值的分布特征选择 3-tap FIR 或强力平滑滤镜，卷积插值出「纯预测 PU」</li>
                        <li>编码即根据参考源像素值分布的特征和编码块 CB 像素值的相性选用趋平/夹角/DC 三种方案之一编码预测块 PB</li>
                    </ul>
                    <p>以下图预测块 C 为例：编码块 B 处缺少参考源就用编码块 A 的最右侧存在参考源做副本。编码块 D 补充 A-B 两块参考源的逻辑同上；若 EDAB 四个编码块都没有参考源，就用编码块 F 的顶部参考源替代；若 EDABF 五个编码块都没有参考源，则给所有参考源填像素中值。</p>
                    <p class="text-gray-side mt-0">图：补充参考源的检查顺序。</p>
                </div>
                <img loading="lazy" src="files/intra-prediction/Reference-Replenishing-Order.png" alt="image22" id="LR-UD-014" class="img-medium img-right col-4 mb-auto" >
    
                <div id="LR-UD-015" class="col-8">
                    <h3>强力平滑滤镜的启用条件</h3>
                    <ol>
                        <li>预测块 C 的大小小于 32x32</li>
                        <li>底——中——顶，及左——中——右三个纵/横向参考源两两差之和小于视频位深，如 8bit 下为 8</li>
                        <li>非 DC，非平行（夹角 10），非垂直（夹角 26）的帧内预测模式</li>
                    </ol>
                    <p class="text-gray-side mt-0">图：强力平滑滤镜的启用条件。</p>
                </div>
                <img loading="lazy" src="files/intra-prediction/Strong-Intra-Smoothing-Condition.png" alt="image24" id="LR-UD-016" class="img-medium img-right col-4 mb-auto" >
                
                <div id="LR-UD-017" class="col-8">
                    <h3>强力平滑滤镜 Strong intra smoothing</h3>
                    <ol>
                        <li>从横、纵向两个参考点直接线性插值 lerp 出所有参考点，以及所对应的预测像素 p</li>
                        <li>缓解了色带问题</li>
                    </ol>
                    <p class="text-gray-side mt-0">图：强力平滑滤镜。</p>
                </div>
                <img loading="lazy" src="files/intra-prediction/Strong-Intra-Smoothing.png" alt="image25" id="LR-UD-018" class="img-medium img-right col-4 mb-auto" >
                
                <div id="LR-UD-019" class="col-8">
                    <h3>3-tap 有限冲击响应 Finite Impulse Reponse 滤镜</h3>
                    <p>用横向 <span class="text-blue-math">\(t(x)\)</span>、纵向 <span class="text-blue-math">\(l(y)\)</span> 各 3 像素加权平均得预测像素 p，按卷积顺序轮询得到 PU</p>
                    <p class="text-gray-side mt-0">图：3tap FIR 滤镜。</p>
                    <p>预处理后，用趋平，夹角，或 DC 模式初步编码 PB 到 CB。</p>
                </div>
                <img loading="lazy" src="files/intra-prediction/3tap-FIR-Filter.png" alt="image26" id="LR-UD-020" class="img-small img-right col-4 mb-auto" >

                <h3>趋平模式 Planar</h3>
                <div id="LR-UD-021" class="col-8">
                    <p>
                        用双线性插值 Bi-lerp，让左，上过渡为右，下平面。由
                        <span class="text-blue-math">
                            <span class="text-blue-pure">底β</span>
                            ×
                            <span class="text-blue-pure">高α</span>
                            +
                            <span class="text-red-pure">底α</span>
                            ×
                            <span class="text-red-pure">高β</span>
                            =
                            <span class="text-green-pure">h</span>
                            ×
                            <span class="text-green-pure">底γ</span>
                        </span>
                        的关系从<span class="text-blue-math">\(l(y)\)</span>得过渡线<span class="text-blue-math">\(h\)</span>，再做<span class="text-blue-math">\(t(x)\)</span>得过渡线<span class="text-blue-math">\(v\)</span>，而所有过渡线连起来，每个预测的像素点取平均就完成了趋平插值。
                    </p>
                    <p class="text-gray-side mt-0">图：得到一个平均预测像素 p(x,y) 的过程。</p>
                </div>
                <img loading="lazy" src="files/intra-prediction/Planar-Intra-Coding-Mode.png" alt="image27" id="LR-UD-022" class="img-medium img-right col-4 mb-auto" >

                <h3>夹角模式 Direct（35 种）</h3>
                <div id="LR-UD-023" class="col-10">
                    <p>将渐变（斜面）预测块 PB 无损压缩为编码块 CB 中全部画面与参考源共角的夹角<span class="text-blue-math">\(\theta\)</span>拓补结构。通过穷举所有<span class="text-blue-math">\(p(x,y)\)</span>的夹角以尝试对齐上方横向参考源<span class="text-blue-math">\(t(x)\)</span>，或左侧纵向参考源<span class="text-blue-math">\(l(y)\)</span>中差异最小的点<span class="text-blue-math">\(t(x\pm n)\)</span>或纵向的<span class="text-blue-math">\(l(y\pm n)\)</span>构成直角三角。用三角函数<span class="text-blue-math">\(\frac{opp}{adj} = \tan\theta\)</span>得预测像素<span class="text-blue-math">\(p\)</span>的夹角<span class="text-blue-math">\(\theta\)</span>
                </div>

                <img loading="lazy" src="files/intra-prediction/Directional-Coding-Modes.png" alt="image28" id="LR-UD-024" class="img-small img-right col-2 mb-auto" >
                <div class="align-items-center">
                    <img loading="lazy" src="files/intra-prediction/Directional-Angle-Algebra.png" alt="image29" class="img-small" >
                    <p class="text-gray-side mt-0">图：大体的精确夹角测算。见<a href="https://www.elecard.com/page/spatial_intra_prediction_in_hevc">Elecard 参考书</a></p>
                </div>
            </div>

            <code class="code-bold">--constrained-intra</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关&gt;缺少生成参考点的 CB 时用帧内块或默认值，不用帧间块生成参考点。降低参考错误传播距离，降低压缩率和速度，增加数据损坏的恢复概率。</p>
            <code class="code-bold">--fast-intra</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，rd 大于 4 时关，推荐开&gt;夹角模式优化。先查夹角模式 2,10,18,26,34，再提高精度到 5，15，21，31，再用最高精度。提高速度且略微增加参考错误，关闭相对更加浪费算力。</p>
            <code class="code-bold">--b-intra</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，rd 大于 4 时关，推荐开&gt;B 条带同样进行帧内预测。关闭可以提速，但相对浪费压缩率。</p>
            <code class="code-bold">--no-strong-intra-smoothing</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，不推荐&gt;强力平滑滤镜平滑的是参考点而非 pu，还能去色带，所以不推荐关。触发条件与原理见上说明。</p>

            <h2 id="h2-11">率控制</h2>
            
            <h3>量化</h3>
            <p>由 QP 值，分块大小，位深等条件所指定的矩阵除法表。通过点除实现的频域强度分解。</p>
            
            <h4>矩阵 Matrix</h4>
            <p>一串于特定位置换行的数字，用括号括起来得到。矩阵和矩阵之间可以根据情况选一种算法实现加减乘，和一种除法</p>

            <h4>点乘/内积 Dot Product</h4>
            <p>两个矩阵之间，位置相对应的数相乘，得到新的矩阵。如果两个矩阵大小不一，则需要设定其它规则才能计算。</p>
            <div class="overflow-auto"><span class="text-blue-math">\[ A = \begin{bmatrix} a_{1} & a_{2} \\ a_{3} & a_{4} \end{bmatrix}, \quad B = \begin{bmatrix} b_{1} & b_{2} \\ b_{3} & b_{4} \end{bmatrix}, \quad A \cdot B = \begin{bmatrix} a_{1} \cdot b_{1} + a_{2} \cdot b_{3} & a_{1} \cdot b_{2} + a_{2} \cdot b_{4} \\a_{3} \cdot b_{1} + a_{4} \cdot b_{3} & a_{3} \cdot b_{2} + a_{4} \cdot b_{4} \end{bmatrix} \]</span></div>

            <h4>矩阵除法</h4>

            <p>没有乘法的各种花样，由两个大小一致的矩阵一对一地点除（和约分）实现。如 JPEG 8x8 亮度变换块的量化：</p>
            <div class="overflow-auto"><span class="text-blue-math">\[ Q(u, v) = \text{round} \left( \frac{C(u, v)}{Q_m(u, v)} \right) \]</span></div>
            <div class="overflow-auto"><span class="text-blue-math">\[ \text{round} \left( {\begin{bmatrix} 515&65&-12&4&1&2&-8&5 \\ -16&3&2&0&0&-11&-2&3 \\ -12&6&11&-1&3&0&1&-2 \\ -8&3&-4&2&-2&-3&-5&-2 \\ 0&-2&7&-5&4&0&-1&-4 \\ 0&-3&-1&0&4&1&-1&0 \\ 3&-2&-3&3&3&-1&-1&3 \\ -2&5&-2&4&-2&2&-3&0 \end{bmatrix}}\div{ \begin{bmatrix} 16&11&10&16&24&40&51&61 \\ 12&12&14&19&26&58&60&55 \\ 14&13&16&24&40&57&69&56 \\ 14&17&22&29&51&87&80&62 \\ 18&22&37&56&68&109&103&77 \\ 24&35&55&64&81&104&113&92 \\ 49&64&78&87&103&121&120&101 \\ 72&92&95&98&112&100&103&99\end{bmatrix} } \right) = \begin{bmatrix} 32&6&-1&0&0&0&0&0 \\ -1&0&0&0&0&0&0&0 \\ -1&0&0&0&0&0&0&0 \\ -1&0&0&0&0&0&0&0 \\ 0&0&0&0&0&0&0&0 \\ 0&0&0&0&0&0&0&0 \\ 0&0&0&0&0&0&0&0 \\ 0&0&0&0&0&0&0&0 \end{bmatrix} \]</span></div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：矩阵间的行列式叉乘与外积</button>
            <div class="coll-content">
                <h4>矩阵间的行列式叉乘 Determinant cross product</h4>
                <p>通过一种算法（此处为行列式）将矩阵坍缩为一个数字（标量）得到。</p>
                <div class="overflow-auto"><span class="text-blue-math">\[ A = \begin{bmatrix} a_{1} & a_{2} \\ a_{3} & a_{4} \end{bmatrix}, \quad B = \begin{bmatrix} b_{1} & b_{2} \\ b_{3} & b_{4} \end{bmatrix} \]</span></div>
                <div class="overflow-auto"><span class="text-blue-math">\[ A \times B = (a_{1} \cdot a_{4} - a_{2} \cdot a_{3}) \cdot (b_{1} \cdot b_{4} - b_{2} \cdot b_{3}) \]</span></div>

                <h4>矩阵间的外积——克罗内克积 Outer product</h4>
                <p>将乘数矩阵本身乘进被乘数矩阵中的每一个值得到：</p>
                <div class="overflow-auto"><span class="text-blue-math">\[ A \otimes B = \begin{bmatrix} a_{1}B & a_{2}B \\ a_{3}B & a_{4}B \end{bmatrix} = \begin{bmatrix} a_{1}b_{1} & a_{1}b_{2} & a_{2}b_{1} & a_{2}b_{2} \\ a_{1}b_{3} & a_{1}b_{4} & a_{2}b_{3} & a_{2}b_{4} \\ a_{3}b_{1} & a_{3}b_{2} & a_{4}b_{1} & a_{4}b_{2} \\ a_{3}b_{3} & a_{3}b_{4} & a_{4}b_{3} & a_{4}b_{4} \end{bmatrix} \]</span></div>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：矩阵间的哈达玛积</button>
            <div class="coll-content">
                <h4>矩阵间的哈达玛积 Haramad product</h4>
                <p>两个大小相同矩阵下的一种常用的自定义点乘/内积算法。</p>
                <div class="overflow-auto"><span class="text-blue-math">\[ A = \begin{bmatrix} a_{1} & a_{2} \\ a_{3} & a_{4} \end{bmatrix}, \quad B = \begin{bmatrix} b_{1} & b_{2} \\ b_{3} & b_{4} \end{bmatrix}, \quad A \circ B = \begin{bmatrix} a_{1} \cdot b_{1} & a_{2} \cdot b_{2} \\ a_{3} \cdot b_{3} & a_{4} \cdot b_{4} \end{bmatrix} \]</span></div>

                <p>x264 中，变换与量化会通过哈达玛积合并为一个矩阵表格，如 4x4 亮度块下为：</p>
                <div class="overflow-auto"><span class="text-blue-math">\[ \text{round} \begin{bmatrix}1/4 & 1/2\sqrt{10} & 1/4 & 1/2\sqrt{10} \\1/2\sqrt{10} & 1/10 & 1/2\sqrt{10} & 1/10 \\1/4 & 1/2\sqrt{10} & 1/4 & 1/2\sqrt{10} \\1/2\sqrt{10} & 1/10 & 1/2\sqrt{10} & 1/10 \end{bmatrix} \times Q_{Step} \times 2^6 \]</span></div>
                <p>得到 qp 为 0，1，2，4，5 下的 4x4 块变换量化合并矩阵分别为：</p>
                <div class="overflow-auto"><span class="text-blue-math">\[ \text{QP}_0 \rightarrow \begin{bmatrix} 10&13&10&13 \\ 13&16&13&16 \\ 10&13&10&13 \\ 13&16&13&16 \end{bmatrix}, \text{QP}_1 \rightarrow \begin{bmatrix} 11&14&11&14 \\ 14&18&14&18 \\ 11&14&11&14 \\ 14&18&14&18 \end{bmatrix}, \text{QP}_2 \rightarrow \begin{bmatrix} 13&16&13&16 \\ 16&20&16&20 \\ 13&16&13&16 \\ 16&20&16&20 \end{bmatrix}, \text{QP}_4 \rightarrow \begin{bmatrix} 16&20&16&20 \\ 20&25&20&25 \\ 16&20&16&20 \\ 20&25&20&25 \end{bmatrix}, \text{QP}_5 \rightarrow \begin{bmatrix} 18&23&18&23 \\ 23&29&23&29 \\ 18&23&18&23 \\ 23&29&23&29 \end{bmatrix} \]</span></div>
            </div>
            
            <h3>算出量化值</h3>
            <p>人眼对明暗变化与画面细节程度的感知呈对数 ㏒ 状，分别奠定了显示器的伽马曲线映射，以及量化值 qp（x 轴）到强度 qScale（y 轴）的强度映射。<span class="text-gray-side">图：量化值 qp 到 qScale 的映射，见<a href="https://www.desmos.com/calculator/vernjiiphf">desmos 互动例</a></span>；伽马矫正的科普见<a href="https://www.nazorip.site/archives/63">x264 教程</a>，<a href="https://www.artleds.com/blog/introduction-to-gamma-curves-and-gamma-correction-in-led-pixel-tapes-application">ArtLEDs 科普</a>。</p>
            <div class="align-items-center">
                <img loading="lazy" src="files/rate-control/Logrithm-QP-to-qScale.png" alt="image30" class="img-medium">
            </div>
            <p>由于当前帧此时还未编码（码率未知），故寻已编码前帧的量化失真程度（越高则后帧理应越复杂），做推演复杂度/模糊复杂度。CRF 越高则除进推演复杂度的分母越大/ABR 越低则分子越小，得到的推演复杂度越低，推演出的量化值就越高。</p>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容 CRF/ABR 模式推演量化值 qp 的简略方法</button>
            <div class="coll-content">
                <div class="mt-3 align-items-center">
                    <table class="table-center text-smaller">
                        <tr class="border-bottom">
                            <th class="t-light-gray px-1">
                                cplxSum<span class="text-blue-math">$$\frac{cplxSum\lbrack L_{-1}\rbrack}{2} + SATD\lbrack L_{-1}\rbrack$$</span>
                            </th>
                            <td>重复将当前帧 <span class="text-blue-math">\(L\)</span> 与旧帧 <span class="text-blue-math">\(L_{-1}\)</span> 做帧间差（SATD）并与已有的总复杂度累计到一起，（累计复杂度通过除以二来降低权重），成为新的累计复杂度 <span class="text-blue-math">\(cplxSum\lbrack L_{-1}\rbrack\)</span>，扫完 GOP 内所有帧后完成</td>
                        </tr>
                        <tr class="border-bottom">
                            <th class="t-light-gray px-1">
                                cplxCount<span class="text-blue-math">$$\frac{cplxSum\lbrack L_{-1}\rbrack}{2} + 1$$</span>
                            </th>
                            <td>初始为零，用于逐帧加权 cplxBlur 的帧数计。÷2 与 cplxSum 同步。加权逻辑时越往后参考冗余理应越多的规律</td>
                        </tr>
                        <tr class="border-bottom">
                            <th class="t-light-gray px-1">
                                cplxBlur<span class="text-blue-math">$$\frac{cplxSum}{cplxCount}$$</span>
                            </th>
                            <td>模糊复杂度。据帧所处于 GOP 中的先后位置 cplxCount 为权重，推演加权出新的帧间差复杂度（SATD）。差异近似 100% 则当前帧复杂度推高（复杂度呈涨势）可扭转 cplxCount 越高，分母越大，分配质量越低，量化值越高的跌势</td>
                        </tr>
                        <tr class="border-bottom">
                            <th class="t-light-gray px-1">
                                qScale<span class="text-blue-math">$$0.85 \times 2^{\frac{qp-12}{6}}$$</span>
                            </th>
                            <td>GOP 内累计的直线化 qp，或 rdoq 的拉格朗日值 λ。已编码帧的 qp 转 qScale，便于其它参数修改更新</td>
                        </tr>
                        <tr class="border-bottom">
                            <th class="t-light-gray px-1">
                                ABR_rate_factor<span class="text-blue-math">$$\frac{target\_rate\_window}{\text{cplxSum}}$$</span>
                            </th>
                            <td>GOP 初始值，ABR 下的 qScale（rdoqλ）转 qp</td>
                        </tr>
                        <tr class="border-bottom">
                            <th class="t-light-gray px-1">
                                ABR_qScaleNew<span class="text-blue-math">$$\frac{qscale \times \text{overflow}}{ABR\_rate\_factor}$$</span>
                            </th>
                            <td>据 ABR 控制更新一遍 qScale（rdoqλ）</td>
                        </tr>
                        <tr class="border-bottom">
                            <th class="t-light-gray px-1">
                                cplxBase<span class="text-blue-math">$$ctu\_count \times (bframe?120:80)$$</span>
                            </th>
                            <td>常数/恒定值。CRF 模式默认的复杂度。若用 B 帧编码则 CTU 或宏块数量×120，否则×80</td>
                        </tr>
                        <tr class="border-bottom">
                            <th class="t-light-gray px-1">
                                CRF_rate_factor<span class="text-blue-math text-smaller">$$\frac{cplxBase^{1-qcomp}}{qScale \times (crf + cutree + bframe\_offset)}$$</span>
                            </th>
                            <td>GOP 内累计，经 cutree，B 帧偏移乘进 qScale 后得 1-qcomp 与 CRF_qScale 对齐（仅 cplxBase，cplxBlur 运算）</td>
                        </tr>
                        <tr class=" border-bottom">
                            <th class="t-light-gray px-1">
                                CRF_qScaleNew<span class="text-blue-math">$$\frac{cplxBlur^{1-qcomp}}{CRF\_rate\_factor}$$</span>
                            </th>
                            <td>据 crf_rate_factor 更新当前帧的 qScale（rdoqλ）</td>
                        </tr>
                        <tr class="border-bottom">
                            <th class="t-light-gray px-1">
                                qp<span class="text-blue-math">$$6\log_{2}{\frac{qscale\_ new}{0.85} + 12}$$</span>
                            </th>
                            <td>qScale（rdoqλ）经调整后得到当前帧的量化值 qp。各 qp 对应一套 DCT 变换量化矩阵。qp→qStep 见<a href="https://www.nazorip.site/archives/63">x264 教程</a></td>
                        </tr>
                    </table>
                    <span class="text-gray-side">表：分别以 [L<sub>-1</sub>] 和 [L] 表示上帧和当前帧</span>
                </div>
                <p>因此，帧内画面复杂则 qp 低，简则高；同时据用户设定的（对数）强度的动态变化。这种质量判断只有两帧而不宏观，所以引出了各种各样的优化步骤，如 mb/cutree，rdoq 等。</p>
            </div>

            <h3>上层，下层与双层模式</h3>
            <p>见 <a href="../../x264-web-tutorial/HTML/index.html#h2-8">x264 教程网页版</a></p>

            <!-- x264 教程副本，更改需手动同步 { -->
            <h3>上层——质量呼应码率 CRF 模式</h3>
            <p>全称 Constant Rate Factor。压制三角形下，距离妥协中心点最近的模式。因此也是压制最常用的模式。</p>
            <code class="code-bold">--crf</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点范围 0~51，默认 23&gt;据 cplxBlur，cutree，B 帧偏移给每帧分配各自 qp 的固定目标质量模式，或简称质量呼应码率模式，统称 crf。素材级画质设在 16~18，收藏~高压画质设在 19~20.5，YouTube 是 23。由于动画和录像的内容差距，动画比录像要给低一点</p>

            <h3>上层——平均码率 ABR 模式</h3>
            <p>全称 Average Bitrate。编码器自行判断量化程度，尝试压缩到用户定义的平均码率 average bitrate 上，速度最快</p>
            <code class="code-bold">--bitrate</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 kbps，<span class="text-red-emph">禁用 CRF</span>&gt;平均码率模式。保持一个较低的量化，超出平均码率后增强量化。直播推流用的“码率选项”就是在设置这个参数</p>

            <h3>双层——恒定量化值 CQP 模式</h3>
            <p>全称 Constant Quantizer Parameter</p>
            <code class="code-bold">--qp</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~69，<span class="text-red-emph">禁用 CRF/ABR/模式决策/率失真优化</span>&gt;设定全局量化强度。除非有既定目的，否则不建议使用。如果要手动指定特定范围的帧类型和量化值，则应使用 SBRC 下层模式</p>

            <!-- x264 教程副本，更改需手动同步 { -->
            <h3>下层——FTQP 半自动模式</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>手动通过文件制定一部分帧的帧类型和量化值，实现全部手动或半手动指定。</p>
                <code class="code-bold">--qpfile</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;路径到文件&gt;手动指定帧类型和 qp 值 closed-gop 下 K 帧的 frame type qp 下层模式。qpfile 文件内的格式为"帧号 帧类型 QP"</p>
                <ul class="font-monospace pl-5 text-smaller">
                    <li>帧类型可以选 [I,i,K,P,B,b]</li>
                    <li>大写 B 代表 B-Pyramid</li>
                    <li>大写 I 代表 IDR 帧</li>
                    <li>K 在 <code>--no-open-gop</code> 时代表 IDR 帧</li>
                    <li>K 在  <code>--open-gop</code> 时代表 i 帧</li>
                    <li>x265 中，QP 值可以不填，代表使用上层率控制模式</li>
                    <li>x264 中，QP 值填 <span class="text-blue-emph">-1</span> 代表使用上层率控制模式</li>
                </ul>
                <p class="font-monospace pl-5 m-0 overflow-auto">qpfile.txt 例：</p>
                <ul class="font-monospace pl-5 text-smaller list-dotless">
                    <li>0 I 18</li>
                    <li>1 P 20</li>
                    <li>2 B 22</li>
                    <li>3 i 21</li>
                    <li>4 b 28</li>
                </ul>
            </div>
            <!-- } -->
            <h3>下层——VBR，CBR 模式</h3>
            <p>带宽是有限资源。一旦网络、硬盘、内存、PCIE 等等带宽慢于当前视频码率，播放就会卡顿。因此在播放流媒体前，播放器会设置一段内存缓冲区，利用了传输速度有时会快于当前视频码率的随机条件，预加载一些数据以求播放不卡顿。此时问题变成了“缸里一端加水（进入缓存）、另一端放水（放出缓存），注水量变化但确保缸里一直有水，求缸的大小”。如此，只要平均传输带宽大于 GOP 平均码率则播放流畅。有的大型 3D 游戏中没有加载缓冲区，导致无论电脑内存多大，只要玩家移动到触发地图加载的区域后，游戏才会开始读盘而突然卡顿。</p>

            <h4>基于缓冲区的量化控制 Video Buffer Verifier（VBV）</h4>
            <ol>
                <li>保证 <code>rc-lookahead</code> 范围内，用户通过 <code>--vbv-bufsize --vbv-maxrate</code> 指定网络/设备元器件带宽所能及的缓冲速度是否大于等于码率流量</li>
                <li>码率超过缓冲区域则视频必然会卡顿，所以加大视频中「码率大于带宽处」的压缩强度。因此 VBV 对画质的破坏较大</li>
                <li>与 CRF 上层模式一并使用时叫可变码率 Variable BitRate（VBR），或 Capped-CRF 模式</li>
                <li>与 ABR 上层模式一并使用时叫固定码率 Constant BitRate（CBR），或 Capped-ABR 模式</li>
            </ol>
            <!-- x264 教程副本，更改需手动同步 { -->
            <code class="code-bold">--vbv-bufsize</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 kbps，默认关（0），<span class="text-red-emph">需小于 <code>--vbv-maxrate</code></span>&gt;在编码器解码出原画后，每秒最多可占的缓存大小。此外，在对解码缓冲速度有要求的应用里，需要同时确保解码 GOP 缓冲时长的合规，时长即 <span class="text-blue-math">bufsize ÷ maxrate</span>（秒）。</p>
            <code class="code-bold">--vbv-maxrate</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 kbps，默认关（0）&gt;峰值红线，在限制缓存占用之上确保码率峰值受控，不会大于播放设备预留的内存大小。方法是提高压缩（提高量化强度 + 强降噪）。据情景不同，maxrate 可以有 4 种状态，且这 4 种状态可以出现在同一视频中。<code>--vbv-bufsize --vbv-maxrate</code> 实际控制的还是这些状态的出现概率，需经验判断：</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>大：GOP 大小=bufsize=2×maxrate，视频码率超出 maxrate 后等缓存满再压缩，避开多数涨落，适合限平均率的串流</li>
                <li>小：GOP 大小=bufsize=1×maxrate，视频码率超出 maxrate 后直接压缩，避开部分涨落，适合限峰值的串流</li>
                <li>超：GOP 大小&lt;bufsize=1~2×maxrate，视频码率超出 maxrate 后直接压缩，但因视频小/CRF 大所以作用不大</li>
                <li>欠：GOP 大小&gt;bufsize=1~2×maxrate，视频码率超出 maxrate 后直接压缩，但因视频大/CRF 小所以全都糊掉</li>
            </ul>
            <p class="font-monospace pl-5 m-0 overflow-auto">由于 GOP 的内容多样，因此</p>
            <!-- } -->
            <code class="code-bold">--crf-max</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~51&gt;防止 vbv 把 crf 拉太高，但会导致码率失控。</p>

            <h3>下层——SBRC 分段控制模式</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>Segment based rate control，实现 DASH，M3U8 串流（视频平台）用。可搭配 CRF/ABR/CRF-VBR/ABR-VBR。</p>
                <code class="code-bold">--sbrc</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，<span class="text-red-emph">需 min-keyint=keyint</span>，<span class="text-red-emph">no-open-gop</span>&gt;由于提高了初始 CRF 值的利用率，所以建议搭配--cplxblur=crf 使用。</p>
            </div>

            <h3>双层——2pass-ABR 模式</h3>
            <p>先用 CRF 模式分析整个视频总结可压缩信息，后根据 ABR 模式的码率限制统一分配量化值。有 pass 2 给特别高的平均码率，输出最小损失的最小体积近无损模式，以及 pass2 给码率硬限的全局整体压缩模式。</p>
            <code class="code-bold">--pass 1</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;挡位，导出 stats 数据文件&gt;</p>
            <code class="code-bold">--pass 2</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;挡位，导入 stats 数据文件&gt;</p>
            <code class="code-bold">--stats</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;路径，默认在 x264/5 所在目录下&gt;设定导出和导入 stats 数据文件的路径和文件名</p>
            <!-- } 额外参数（与 x264 教程不同）：-->
            <code class="code-bold">--slow-firstpass</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;pass1 里自动关闭以下提速，或自动提高以下参数的强度，以保证 pass1 模式中 CRF 模式计算量化值的准确度：<code>fast-intra，no-rect，no-amp，early-skip，ref 1，max-merge 1，me dia，subme 2 rd 2</code>，可手动覆盖为强度更高的参数</p>

            <h3>双层——Analysis-2pass-ABR 模式</h3>
            <p>于普通 2pass 基础上，将 pass1 的帧内和帧间的分析结果传给 pass2。</p>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：Analysis-2pass</button>
            <div class="coll-content">
                <code class="code-bold">--analysis-save --analysis-load</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;路径&gt;指定导入/出 analysis 信息文件的路径，文件名。</p>
                <code class="code-bold">--analysis-save-reuse-level --analysis-load-reuse-level</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 1~10，默认 5&gt;指定 analysis-save 和 load 的信息量，配合 pass1 的动态搜索，帧内搜索，参考帧等参数。推荐 8</p>
                <ul class="font-monospace pl-5 text-smaller">
                    <li><span class="text-blue-emph">1</span>储存 lookahead 信息</li>
                    <li><span class="text-blue-emph">2==4</span>同时储存帧内/帧间向量格式 + 参考信息</li>
                    <li><span class="text-blue-emph">5==6</span>加 rect/amp 分块信息</li>
                    <li><span class="text-blue-emph">7</span>加 8x8cu 分块优化信息</li>
                    <li><span class="text-blue-emph">8==9</span>加完整 8x8cu 分块信息</li>
                    <li><span class="text-blue-emph">10</span>加所有 cu 分析信息</li>
                </ul>
                <code class="code-bold">--dynamic-refine</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;路径，默认在 x264/5 所在目录下&gt;设定导出和导入 stats 数据文件的路径和文件名</p>
                <code class="code-bold">--refine-inter</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~3，默认 0&gt;限制帧间块的向量格式，<span class="text-blue-emph">取决于 pass1 分析结果是否可信，如 pass 1 只跑了快速搜索的情况</span>。</p>
                <ul class="font-monospace pl-5 text-smaller">
                    <li><span class="text-blue-emph">0</span>完全遵从 pass1 的分块深度和向量格式</li>
                    <li><span class="text-blue-emph">1</span>分析所有 pass2 中与 pass1 相同分块的向量格式，除 2pass 中比 1pass 更大的分块</li>
                    <li><span class="text-blue-emph">2</span>一旦找出最佳的动态向量格式就应用于全部的块，2Nx2N 块的 rect/amp 分块全部遵从 pass1，仅对 merge 和 2Nx2N 划分的块的动态向量信息进行分析</li>
                    <li><span class="text-blue-emph">3</span>保持使用 pass1 的分块程度，仍然搜索向量格式</li>
                </ul>
                <code class="code-bold">--refine-intra</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~3，默认 0&gt;限制帧间块的向量格式，<span class="text-blue-emph">取决于 pass1 分析结果是否可信，如 pass 1 只跑了快速搜索的情况</span>。</p>
                <ul class="font-monospace pl-5 text-smaller">
                    <li><span class="text-blue-emph">0~2</span>同上</li>
                    <li><span class="text-blue-emph">3</span>保持使用 pass1 的分块程度，但优化动态向量</li>
                    <li><span class="text-blue-emph">4</span>pass1 丢弃不用</li>
                </ul>
                <code class="code-bold">--refine-mv</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 1~3&gt;优化分辨率变化情况下 pass2 的最优动态向量，<span class="text-blue-emph">1</span>仅搜索动态向量周围的动态，<span class="text-blue-emph">2</span>增加搜索 AMVP 的顶级候选块，<span class="text-blue-emph">3</span>再搜索更多 AMVP 候选。</p>
                <code class="code-bold">--scale-factor</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，<span class="text-blue-emph">需 analysis-reuse-level 10</span>&gt;若 1pass 和 2pass 视频的分辨率不一致，就使用这个参数。</p>
                <code class="code-bold">--refine-mv-type avc</code>
                <p class="font-monospace pl-5 m-0 overflow-auto"> 读取 API 调用的动态信息，目前支持 avc 大小，使用 analyse-reuse 模块就用这个参数+avc。</p>
                <code class="code-bold">--refine-ctu-distortion</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~1&gt;pass 1 下用 0 写，pass 2 下用 1 读取 ctu 失真信息。</p>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：Analysis-2pass 转场优化</button>
            <div class="coll-content">
                <code class="code-bold">--scenecut-aware-qp</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数，默认关，<span class="text-red-emph">仅 pass2</span>&gt;降低转场前/后 qp 以增加转场画质，类似 fades 和 weightb。</p>
                <ul class="font-monospace pl-5 text-smaller">
                    <li><span class="text-blue-emph">1</span>仅转前</li>
                    <li><span class="text-blue-emph">2</span>仅转后</li>
                    <li><span class="text-blue-emph">3</span>前加后</li>
                </ul>
                <code class="code-bold">--analysis-reuse-file</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;路径，默认 x265 目录下 x265_analysis.dat&gt;若使用了 2pass-ABR 调优，则导入 multi-pass-opt-analysis/distortion 信息的路径，文件名。</p>
                <code class="code-bold">--masking-strength</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;逗号分隔整数&gt;于 sct-awr-qp 基础上定制 qp 偏移量。建议根据低~高成本动漫，真人录像三种情况定制参数值。scenecut-aware-qp 的三种方向决定了 masking-strength 的三种方向。所谓的非参考帧就是参考参考帧的帧，包括 B，b，P 三种帧。</p>
                <ul class="font-monospace pl-5 text-smaller">
                    <li>sct-awr-qp=1 时写作<span class="text-blue-emph">&lt;转前毫秒（推 500）&gt;,&lt;参考±qp&gt;,&lt;非参±qp&gt;</span></li>
                    <li>sct-awr-qp=2 时写作<span class="text-blue-emph">&lt;转后毫秒（荐 500）&gt;,&lt;参考±qp&gt;,&lt;非参±qp&gt;</span></li>
                    <li>sct-awr-qp=3 时写作<span class="text-blue-emph">&lt;转前毫秒&gt;,&lt;参考±qp&gt;,&lt;非参±qp&gt;,&lt;转后毫秒&gt;,&lt;参考±qp&gt;,&lt;非参±qp&gt;</span></li>
                </ul>
                <p class="text-gray-side pl-5 m-0"> 注：x265 v3.5 移除了 scenecut-window，max-qp-delta，qe-delta-ref，qp-delta-nonref。</p>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：Analysis-Npass 间调优</button>
            <div class="coll-content">
                <p>在 Analysis-pass 1 和 Analysis-pass 2 之间引入一步优化计算，实现比普通的 2pass 编码更精细的码率控制。“优化”代表更详细的分析和统计视频内容，以便在第二次编码时更准确地分配码率。</p>

                <code class="code-bold">--multi-pass-opt-analysis</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认生成 x265_analysis.dat，<span class="text-red-emph">需关闭 pme/pmode/analysis-save|load</span>&gt;储存/导入每个 CTU 的参考帧/分块/向量等信息。将信息优化，细化并省去多余计算。</p>
                <code class="code-bold">--multi-pass-opt-distortion</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，<span class="text-red-emph">需关闭 pme/pmode/analysis-save|load</span>&gt;根据失真（编码前后画面差）进一步分析 qp</p>
                <code class="code-bold">--multi-pass-opt-rps</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关&gt;将 pass1 常用的率参数集保存在序列参数集 SPS 里以加速。</p>
            </div>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：Analysis-2pass pass2 梯级多视频流导出</button>
            <div class="coll-content">
                <code class="code-bold">--abr-ladder</code>
                <p class="font-monospace pl-5 m-0 overflow-auto">&lt;文件名.txt，<a href="https://streaminglearningcenter.com/blogs/the-evolving-encoding-ladder-what-you-need-to-know.html">苹果 TN2224</a>，<span class="text-red-emph">实验性</span>&gt;编码器内部实现 Analysis-2pass 中，pass2-ABR 阶段的多规格输出。方便平台布置多分辨率视频版本用。可以把不变的参数写进 pass1+2，变化的写进 txt。</p>
                <p class="font-monospace pl-5 m-0 overflow-auto">格式为："[压制名:analysis-load-reuse-level:analysis-load] &lt;参数 1+ 输出文件名 1&gt;" 例：</p>
                <pre class="mt-3"><code class="text-smaller language-powershell">
x265.exe --abr-ladder 1440p8000_2160p11000_2160p16000.txt --fps 59.94 --input-depth 8 --input-csp i420 --min-keyint 60 --keyint 60 --no-open-gop --cutree
                </code></pre>
                <p>1440p8kb_2160p11kb_2160p16kb.txt：</p>
                <pre><code class="text-smaller language-powershell">
[1440p:8:Anld存档1] --input 视频.yuv --input-res 2560x1440 --bitrate 8000 --ssim --psnr --csv 9.csv --csv-log-level 2 --output 1.hevc --scale-factor 2

[2160p1:0:nil] --input 视频.yuv --input-res 3840x2160 --bitrate 11000 --ssim --psnr --csv 10.csv --csv-log-level 2 --output 2.hevc --scale-factor 2

[2160p2:10:Anld存档3] --input视频.yuv --input-res 3840x2160 --bitrate 16000 --ssim --psnr --csv 11.csv --csv-log-level 2 --output 3.hevc --scale-factor 0
                </code></pre>
            </div>
            <h3>双层——近无损，真无损模式</h3>
            <code class="code-bold">--lossless</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;过分块，动/帧/参搜索，量/自适量化等影响画质的步骤，保留率失真优化以增强参考性能。输出体积特大的原画。相比锁定量化方法，这样更能满足影业与科研用，但不适合个人和一般媒体。真无损导出有很小几率因为参考质量提升而会比近无损小</p>
            <code class="code-bold">--cu-lossless</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关&gt;将无损量化 cu（qp 4）作为率失真优化的结果选项之一，只要码率管够（符合<span class="text-blue-math">\(\lambda = \frac{R}{D}\)</span>）就不量化。用更多码率换取原画相似度，无损源能提高参考冗余</p>

            <h3>其它率控制</h3>
            <p>可以搭配除 CQP 以外的上下层模式使用，决定了视频各处的最终量化值</p>
            <code class="code-bold">--tskip</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，<span class="text-red-emph">需 rd 大于 2</span>&gt;在 4x4 变换块上尝试 DCT，DST 等变换模式的基础上增加一个不变换直接量化（SKIP 模式），然后由模式决策权衡出率失真最佳的方案。视频内容越复杂，对编码速度的影响就越大。与无损模式无关，但也可算作一种近无损模式。如果嫌慢还可以考虑 <code>--tskip-fast</code></p>
            <code class="code-bold">--qpmin</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~51&gt;由于画质和优质参考帧呈正比，所以仅高压环境建议设最高 14</p>
            <code class="code-bold">--qpmax</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~51&gt;在要用到颜色键，颜色替换等需要清晰物件边缘的滤镜时，可以设<span class="text-blue-emph">26</span> 防止物件的边缘被过度压缩（但作用不如无损量化好），其他情况永远不如关 <code>--cutree/--mbtree</code></p>
            <code class="code-bold">--rc-grain</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，<code>--tune grain</code> 时开启&gt;通过抑制 cplxBlur 的累积，从而保证一定场景下，GOP 分配量化值呈跌势以保证整个视频的码率受控。如果视频中的大多数高频信号都是细节而非噪点，且策略为画质编码则关</p>
            <code class="code-bold">--cplxblur</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点 0~100，默认 20&gt;第 -1 帧不存在，无法算出第 0 帧的 cplxBlur，所以保留默认值或手动指定，如果从第一帧开始就是复杂的动态画面（如花屏转场）则可以提高，但因为时间很短所以效果可能很不明显</p>
            <code class="code-bold">--qcomp</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点范围 0.5~1，推荐默认 0.6&gt;模糊复杂度 cplxBlur 以及 mbtree 迭代每帧量化强度范围的曲线抑制参数。越小则复杂度迭代越符合实际状况，抑制 CRF，mb/cutree，bframes 影响的效果就越弱，搭配高 CRF 能使码率控制接近 VBV 的程度。越大则 CRF，mb-cutree，bframes 越没用，越接近 CQP</p>

            <h2 id="h2-12">自适应量化</h2>
            <p>CRF/ABR设定每帧量化/qp后，方差自适应量化variance adaptive quantizer 再根据复杂度判断高低频信号，来实现精确到宏块的 QP 分配过程。见 <a href="../../x264-web-tutorial/HTML/index.html#h2-9">x264 教程</a></p>
            
            <code class="code-bold">--aq-mode</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~3&gt;据原画和 crf/abr 设定，以及码率不足时（crf&lt;18/低码 abr）如何分配 qp。</p>
            <ul class="font-monospace pl-5 list-dotless text-smaller">
                <li><span class="text-blue-emph">1</span>：标准自适应量化，适合画面内容单调时使用</li>
                <li><span class="text-blue-emph">2</span>：并且启用 aq-variance，自动调整 aq-strength 强度（录像~电影以及 crf&lt;17 推荐）</li>
                <li><span class="text-blue-emph">3</span>：并且在码率不够用时倾向保暗场（接受更明显的涂抹失真）</li>
                <li><span class="text-blue-emph">4</span>：并且码率不够用时更加倾向保纹理（接受平面上的涂抹失真，<span class="text-red-emph">实验性</span>，很慢）</li>
            </ul>
            <code class="code-bold">--aq-strength</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点&gt;自适应量化强度。搭配 aq-mode，如动漫 1:0.8，2:0.9，3:0.7 用。录像上可加 0.1~0.2，画面混乱/观众难以注意平面时可再增加。注意低成本动漫的平面居多，因此码率不足时反而要妥协纹理。</p>
            <code class="code-bold">--hevc-aq</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;以 ¼ 瓦（tile）而非 aq 的边缘高频信息实现自适应（虽然瓦分区还没有被实现）。据 doom9 论坛讨论：<a href="https://forum.doom9.org/showthread.php?p=1925373#post1925373">1</a>，<a href="https://forum.doom9.org/showthread.php?p=1925464">2</a>: hevc-aq 比 aq 4 快且适合动漫，而 aq 4 更适合录播。目前学术方、官方、第三方间信息较割裂，暂无适解。</p>
            <code class="code-bold">--aq-motion</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，<span class="text-red-emph">实验性</span>&gt;据动态信息微调自适应量化的效果 mode 和强度 strength。</p>
            <code class="code-bold">---qg-size</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点&gt;&lt;64/32/16/8，默认 64，<span class="text-red-emph">≥min-cu-size</span>&gt;偏移蓝，红色色度面相比亮度平面的 qp 值差异，负值降低量化。如当色度平面的量化太高则可以用这两个参数补偿回来，但 x264-5 会根据色度平面采样格式（4:2:2，4:4:4）自动设定这些参数。由于编码器一直不擅长深红色，而人眼又对红光敏感，所以可以给红色面设<span class="text-blue-emph">-3</span>左右。</p>
            <code class="code-bold">--cbqpoffs --crqpoffs</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数偏移值&gt;据动态信息微调自适应量化的效果 mode 和强度 strength。</p>

            <h3>x265 jpsdr-mod 参数</h3>

            <code class="code-bold">--aq-auto</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;8bit 四开关十进制，默认 0 关&gt;对应下表：</p>
            <table class="align-items-center table-center">
                <thead>
                    <tr class="border-bottom">
                        <th class="text-blue-emph px-3">值</th>
                        <th class="px-3">逐帧 AQ</th>
                        <th class="px-1">延迟逐帧 AQ</th>
                        <th class="px-3">HDR 兼容</th>
                        <th class="px-1"><code>--aq-mode 5</code></th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-3">1</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-3">2,3</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-3">4</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1"> </td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-3">8</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1"> </td>
                        <td class="px-1"> </td>
                        <td class="px-1 t-light-gray">✓</td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-3">6</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1"> </td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-3">10</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1"> </td>
                        <td class="px-1 t-light-gray">✓</td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-3">12</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1"> </td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1 t-light-gray">✓</td>
                    </tr>
                    <tr class="border-bottom">
                        <td class="text-blue-emph px-3">14</td>
                        <td class="px-1 t-light-gray border-left">✓</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1 t-light-gray">✓</td>
                        <td class="px-1 t-light-gray">✓</td>
                    </tr>
                </tbody>
            </table>

            <code class="code-bold">--aq-fast-edge</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，<span class="text-red-emph">需 aq-mode 4,5</span>&gt;边缘检测跳过高斯模糊过滤，不适合脏片源。</p>
            <code class="code-bold">--aq-bias-strength</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点，默认 1，<span class="text-red-emph">需 aq-mode 3,5</span>&gt;aq-strength 偏给暗场的程度。</p>
            <code class="code-bold">--aq-strength-edge</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点 0~3，默认等于 aq-strength，<span class="text-red-emph">需 aq-mode 4,5</span>&gt;偏给纹理的 aq-strength。</p>
            <code class="code-bold">--aq-bias-strength-edge</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点，默认等于 aq-bias-str，<span class="text-red-emph">需 aq-mode 5</span>&gt;aq-strength-edge 偏给暗场的程度。</p>

            <h3>模式决策 Mode Decision</h3>
            <p>见率失真优化（下方）说明。</p>
            <div class="align-items-center">
                <img loading="lazy" src="files/rate-control/Mode-Decision.png" alt="image31" class="img-medium">
            </div>

            <code class="code-bold">--rd</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;1/2/3/5，默认 3，大则慢&gt;据优化模式决策的程度。建议快速用用<span class="text-blue-emph">1</span>，<span class="text-blue-emph">2</span>；高压用<span class="text-blue-emph">3</span>；片源数据无损 (非视觉无损) 时用<span class="text-blue-emph">5</span>。</p>
            <ul class="font-monospace pl-5 list-dotless text-smaller">
                <li><span class="text-blue-emph">1</span>优化帧内参考，并块/跳过决策，含明显边缘失真时用</li>
                <li><span class="text-blue-emph">2</span>加分块决策，含明显边缘失真时用</li>
                <li><span class="text-blue-emph">3</span>加帧间决策，高压高量化时可平衡</li>
                <li><span class="text-blue-emph">5==6</span>加向量/帧间方向预测决策，比 3 慢一倍，片源含边缘失真时会强化失真</li>
            </ul>
            <code class="code-bold">--limit-modes</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;用附近的 4 个子 CU 以判断用 merge 还是 AMVP，会大幅减少 rect/amp 的效果，提速明显。会增大或减少体积，微降画质但难以察觉。</p>
            <code class="code-bold">--limit-refs</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~3，默认 3&gt;限制分块用信息可参考性。<span class="text-blue-emph">0 不限</span>压缩高且慢；<span class="text-blue-emph">1</span>用 cu 分裂后的信息 + 差异信息描述自身 (推荐)；<span class="text-blue-emph">2</span>据单个 cb 的差异信息建立 pu；<span class="text-blue-emph">3=1+2</span>。</p>
            <code class="code-bold">--rskip</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~2&gt;前 cu 分块被跳过时，判断后 cu 接着搜索分块还是提前退出的参数。画面越接近录屏/低成本动漫就用得越多。</p>
            <ul class="font-monospace pl-5 list-dotless text-smaller">
                <li><span class="text-blue-emph">0</span>继续分析。适合信噪比差/高噪源。原画很干净则不如<span class="text-blue-emph">1</span></li>
                <li><span class="text-blue-emph">1</span>rd 0~4 下据临 cu 是否细分而定；rd5~6 下看附近 2Nx2N cu 分块难度而定，高压和一般情况推荐</li>
                <li><span class="text-blue-emph">2</span>直接对比 cu 纹理密度 Edge Density，快且不比前者差，但存在对源的画质要求及客观判断“画质”的能力</li>
            </ul>
            <code class="code-bold">--tskip-fast</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，<span class="text-red-emph">需 <code>tskip</code></span>&gt;只在帧内编码的亮度 NxN 细分块中的 4x4 变换块上不但尝试 DCT，DST 等变换模式，还增加不变换直接量化（SKIP）模式，然后由模式决策选出更好的方案。色度块的检查也取决于同位亮度块是否最终采用了 SKIP 变换模式。在使用与不使用 <code>--tskip</code> 之间提供了编码压力偏向中间的选项</p>
            <code class="code-bold">--rskip-edge-threshold</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;0~100，默认 5: 趋向于分块，<span class="text-red-emph">需 rskip 大于 1</span>&gt;用 Sobel 算法获取 cu 纹理密度，再将纹理密度除以块所占面积，得到密度占据面积的百分比。纹理密度&gt;阈值=分块，量化强度越高越关键。8×8 或 16×16 块下默认 5%（即含 3 或 12 个系子）就分。类似 x264 的 deadzone 参数。</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>像素风：<span class="text-blue-emph">据像素变大的程度决定</span>。如分辨率宽÷2，分辨率高÷2 会回到 1x1 像素大小，则使默认值乘以 2 以提速</li>
                <li>抗涂抹：<span class="text-blue-emph">--rskip 2 --rskip-edge-threshold 3</span>。即“有一点不平就应分块”。比 <code>--rskip 0</code> 快，用于已知要保留雪景等全屏大量动态信息的源的情况下，节省传统分块计算时间。可=在不添噪点的情况下达成抗涂抹的目的</li>
            </ul>
            <div class="align-items-center">
                <img loading="lazy" src="files/rate-control/rSkip-Edge-Threshold.png" alt="image32" class="img-small" >
                <p class="text-gray-side">图：影响 DCT 系子分布的块中像素，而 DCT 系子的密度影响 rskip-edge-threshold 的设置</p>
            </div>
            <!-- x264 教程副本，更改需手动同步 { -->
            <h2 id="h2-13">率失真优化 Rate distortion optimization（RDO）</h2>
            <p>视频压缩策略受到算力、分析算法、客户等诸多限制，尽管工程师和开发者付出了很多努力，最后也往往回归最直接的“码率越小越好”——给所有压缩步骤选择码率最小的编码模式，或者强行上马一个 CQP 就完事。这样做的结果是码率分配失衡，即“码率在握之画质全损”，而“码率在握”也只是因为作对比的是无损或未压缩视频源；实际上，如此“粗压”与“精压”相比还会露馅——后者在画质更高的情况下，码率往往更低。原因是 <i>过度的有损压缩使得本可用于无损压缩（冗余）的机会被因小失大地浪费</i>。例如，过度的量化会破坏 P-B 帧原本可以参考 I 帧的部分，由于差异太大，编码器只得放弃参考，把这个区域重编码为 I 块，或直接改成 I 帧。</p>
            <p>现代视频编码器已经具备了减免这种问题所需的信息——编码后失真、码率代价，以及编码后码率。将失真，码率分别看做两种“越大越差”的程度，再根据码率代价——“此处码率的宝贵程度”缩放出一个一元一次函数空间（<span class="text-blue-math">\(y = mx + b\)</span>），问题就迎刃而解——只要找到各种 <span class="text-blue-math">\(mx + b\)</span> 里最小的  <span class="text-blue-math">\(y\)</span> 即可，而“找到最小”的过程需要统计每个编码步骤下的多个至全部编码模式，这个过程就是率失真优化（RD）。率失真优化的性能占用虽然不小，但它带来的好处可以和动态搜索相媲美。</p>
            <p>“编码器策略”就是模式决策。率失真程度由代价函数「开销 = 失真+λ⋅码率」（越小越好）得出：</p>
            <span class="text-blue-math text-larger">\[J = D + \lambda \cdot R\]</span>
            <p>编码器在决定采用哪种编码模式（如帧内/帧间、哪种块划分、运动矢量朝向等）时，不再只考虑码率 R 或失真 D，而是计算所有候选模式的率失真代价 <span class="text-blue-math">\(J = D + \lambda R\)</span>，然后选择代价 J 最小的那个模式。</p>
            <ul>
                <li><span class="text-blue-math">\(\lambda=0\)</span>：无斜度，则代价等于失真——码率变而画质不变，宜压缩</li>
                <li><span class="text-blue-math">\(\lambda \rightarrow 0\)</span>：趋 0，则开销趋失真——宜适当压缩</li>
                <li><span class="text-blue-math">\(\lambda &gt;0\)</span>：大于 0，则开销大于失真——保画质收益大于压缩收益，宜保画质</li>
            </ul>
            <!-- } -->
            <div class="align-items-center">
                <img loading="lazy" src="files/rate-distorsion-optimization/x264-JM-RDO-Lambda.png" alt="image33" class="img-medium">
                <img loading="lazy" src="files/rate-distorsion-optimization/RDO-Lambda-Slopes.png" alt="image34" class="img-medium">
                <p class="text-gray-side">图：率失真优化中 λ 的斜度变化与效果</p>
                <img loading="lazy" src="files/rate-distorsion-optimization/RDO-qStep-Chart.png" alt="image35" class="img-medium">
                <p class="text-gray-side">图：率失真表格中不断调整并得到“×”的实际效果</p>
            </div>
            <p>x265 的失真（块间差异）使用均方差 Mean Squared Error（MSE）判断：</p>
            <span class="text-blue-math">\[ \text{MSE} = \frac{1}{n^2}\sum_{x=0}^{n-1}\sum_{y=0}^{n-1} \left| f(x,y) - f'(x,y) \right|^2 \]</span>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：
                <span class="text-red-emph">补充跳过的 x264 教程率失真优化部分，以及 <code>--psy-rd，--fgo</code> 等参数的科普，可略。</span>
            </button>
            <div class="coll-content">
                <p>x264 中使用更快的平方差 Sum of Squared Error（SSE）/ Sum of Squared Difference（SSD）判断:</p>
                <span class="text-blue-math">$$\sum_{x=0}^{n-1}{\sum_{y=0}^{n-1}{\ |f(x,y) - f^\prime(x,y)|^2}}$$</span>
                <p>或者，x264 中可以选用画质优先的高频加权平方差 Noise SSE（见 <a href="https://web.archive.org/web/20090916181521/http://x264dev.blogspot.com/2008/05/film-grain-optimization.html">Dark Shikari 帖子</a>和<a href="https://forum.doom9.org/showthread.php?p=1127999">doom9 论坛</a>）：</p>
                <span class="text-blue-math text-smaller">$$\sum_{x=0}^{n-1}{\sum_{y=0}^{n-1}{\ \left| \left\lbrack N(x,y) - \ N\prime(x,y) \right\rbrack \cdot fgo \right| + |f(x,y) - f^\prime(x,y)|^2}}$$</span>
                <p>其中 N/Noise 代表块的噪点强度，在一个 2x2 的区间下为四个像素两两加减得到，因为噪点和其它高频信号一样都是突兀的像素值（所以速度很慢）：</p>
                <span class="text-blue-math">$$N(0,0)=|f(0,0)-f(0,1)+f(1,1)-f(0,1)|$$</span>
                <ul class="text-gray-side">
                    <li>
                        <span class="text-blue-math">\(n\)</span>为块的大小边界，当然此处未考虑 x265 rect 和 asm CU 的长方形
                    </li>
                    <li>
                        <span class="text-blue-math">\(\sum_{x=0}^{n-1}{\sum_{y=0}^{n-1}}\)</span>分别指块宽，块高的求和范围
                    </li>
                    <li>
                        <span class="text-blue-math">\(x,y\)</span>代表块中各个像素值的坐标
                    </li>
                    <li><span class="text-blue-math">| |</span> 求绝对值以正常求和</li>
                </ul>
            </div>

            <h3>模式决策优化</h3>
            <p>环路滤镜作用于重建帧（编码结果）上，使其成为未来帧的参考。模式决策（帧内模式、运动矢量、块划分等）都在编码当前块时完成，不会在环路滤镜处理之后再复查和修改。但编码器在决策时通常会基于“滤镜处理后的参考帧”来进行运动估计和预测，以保证和解码端一致。模式决策对于帧内编码的块/帧尤其重要，因为帧内预测的模式是根据重建（并滤波）后的左侧、左上和顶部相邻像素做的（信息有限），因此很可能还有更好的编码模式可取。对于帧间编码的块，其前后的参考帧已经进行过滤镜处理（因为编解码顺序不同于播放顺序），因此编码器可以安全地根据处理后的参考帧复查动态向量。</p>
            <ol>
                <li><b>整合动态搜索与补偿可能性</b>：
                    <ul>
                        <li>计算并收集每种帧内，帧间预测模式的率失真程度（于下文解释）</li>
                    </ul>
                </li>
                <li><b>整合分块参考量化可能性</b>：
                    <ul>
                        <li>计算并收集每种细分块方案（4x4，8x8，16x16），参考帧长度，量化强度下的率失真程度</li>
                    </ul>
                </li>
                <li><b>压缩方案定制</b>：
                    <ul>
                        <li>选择码率最小的压缩方案并不是最优解，因此找出率失真程度最大的方案集，得到码率与画质最为平衡的方案</li>
                    </ul>
                </li>
            </ol>
            <code class="code-bold">--dynamic-rd</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~4，<span class="text-red-emph">需 rd 小于 5</span>&gt;给 VBR 限码画面调高 rd 止损。1~4 为 rd 搜索面积倍数，大则慢。</p>
            <code class="code-bold">--splitrd-skip</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关&gt;在“所有当前 CU 分割致失真程度之总和”大于“同帧 CU 分割致失真程度之和”时，不独立计算 rd 值以加速。</p>
            <code class="code-bold">--qp-adaptation-range</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点 1~6，默认 1&gt;psy 参数改动 qp 的最大范围，宏观影响大，片源含明显边缘失真时会不应使用，以防止进一步的失真。</p>
            <code class="code-bold">--psy-rd</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点偏移值 0~50，默认 2.0，<span class="text-red-emph">需 rd 3</span>，加 <code>--psy-rdoq</code> 后构成 x264 psy-rd 参数&gt;心理视觉优化往高影响量化块的能量 J，使 md 偏好保留细节的程度，值随分辨率增加而增加，随片源边缘失真增加而降低，并随量化强度增加而增加。</p>
            <ul class="font-monospace pl-5 list-dotless text-smaller">
                <li><span class="text-blue-emph">0~0.1</span>片源有明显边缘失真（和细节同是高频信号），优化则降低画质</li>
                <li><span class="text-blue-emph">0.2</span>高压或片源暗场有一点点边缘失真</li>
                <li><span class="text-blue-emph">0.5~2</span>根据要保留的边缘峭度以及文件大小，VBR 模式的峰值码率决定</li>
                <li><span class="text-blue-emph">1.5~2.5</span>至少 2k 的录像片源，根据分辨率和边缘失真程度决定</li>
            </ul>
            <code class="code-bold">--rd-refine</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，<span class="text-red-emph">需 rd 5</span>&gt;率失真优化分析帧内预测 CU 的最佳量化和分块结果，耗时换压缩率和画质。但有概率会出现随机块失真（猜测是因为率失真算法发现特定块失真后反而对整体编码收益更大而导致）。</p>

            <h3>优化量化</h3>
            <code class="code-bold">--rdoq-level</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数，0~2&gt;ABR/CRF 分配量化值的宏观调控强度，大则慢，0 则关。</p>
            <ul class="font-monospace pl-5 list-dotless text-smaller">
                <li><span class="text-blue-emph">1</span>逐分块进行率失真优化量化，psy-rdoq 开启则倾向低量化</li>
                <li><span class="text-blue-emph">2</span>对比 4x4 块高频信息/残差是否有利于整个编码组 (CTU 内分块) 画质，同时对所有系子进行同类分析，大量减少 4×4 块，降低 psy-rdoq 效果，适合一般及高压缩用途</li>
            </ul>
            <code class="code-bold">--psy-rdoq</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点 0~50，默认 0 关&gt;心理视觉往高影响量化块的能量 J，改量化偏好为保留细节。值随分辨率增加而增加，随片源边缘失真增加而降低，并随量化强度增加而增加。</p>
            <ul class="font-monospace pl-5 list-dotless text-smaller">
                <li><span class="text-blue-emph">0~0.1</span>片源有明显边缘失真（和细节同是高频信号），优化则降低画质</li>
                <li><span class="text-blue-emph">2.3~2.8</span>电脑录屏，中低成本动漫等几乎没有动态背景变化的情况</li>
                <li><span class="text-blue-emph">3~4.8</span>分辨率从 1280x720 到 3840x2160 的高成本电影动漫，要求片源无明显边缘失真</li>
                <li><span class="text-blue-emph">7~12 搭配 psy-rd 3，tskip，tskip-fast，ipratio 1.2，no-sao</span>留噪。保的细节面积越小越高</li>
            </ul>
            <code class="code-bold">--nr-intra --nr-inter</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0 关~2000，默认 0，<a href="http://forum.doom9.net/showthread.php?s=81cd7c04a679401fe7c4e689e67eaeb8&p=1947571#post1947571">1920x1080 不建议超 250</a>&gt;基于 MC 结果给量化前变换完的 i 帧降噪。nr-intra 不如第三方降噪滤镜。但帧间/时域上降噪的 nr-inter 可以拉近参考源和参考帧的差距/残差，实现在 rc-grain 上进一步稳定 qp 值波动，且在噪点源中相比模糊掉纹理更容易破坏噪点，结果类似低配双阈滤镜。</p>

            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：补充信噪比 SNR 和峰值信噪比 PSNR 的内容</button>
            <div class="coll-content">
                <h3>峰值信噪比 Peak signal-noise ratio PSNR</h3>
                <p>根据信号与噪声之间的比例关系衡量图像或视频的质量。PSNR 不仅仅适用于视频、音频和图像，还可以是温度、气压等强度的差异。由于人对光线变化的感知强度呈对数状，因此对数被用于统计信号的强度，通常用分贝 dB 表示。信噪比 SNR 是指信号与噪声的比值，用于衡量在处理、传输或变换信号过程中有效信息的保留程度。使用对数统计的 PSNR 也能更好地突出关键范围内的变化，并在坐标系中平衡过高或过低的信噪比数据，使得变化更易于理解。</p>
                <p class="text-blue-math">$$PSNR_{8bit} = 10 \log_{10} \left( \frac{2^{8bit}-1}{MSE} \right) \,\text{(dB)}$$</p>
                <ul class="text-gray-side">
                    <li>PSNR 用来判断编码前后的画面差距，此处画面差异记为均方差 MSE</li>
                    <li>右侧减 1 代表从 0 开始数，㏒<sub>10</sub>对齐十进制</li>
                </ul>
            </div>

            <h4>优化策略——随量化强度增加而增加</h4>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <div class="align-items-center">
                    <img loading="lazy" src="files/rate-distorsion-optimization/RDO-Settings-Reference.jpg" alt="image37" class="img-medium">
                    <p class="text-gray-side">图：左 1 源有微量边缘失真以及颗粒。2~4=高量化导致块失真，worm，蚊噪等。5 对应失真用 psy-rd(oq)，(limit)sao，deblock，aq，降 crf 抑制</p>
                </div>
                <table class="table-center">
                    <thead>
                        <tr>
                            <th class="px-1">1</th>
                            <th class="px-1">2</th>
                            <th class="px-1">3</th>
                            <th class="px-1">4</th>
                            <th class="px-1">5</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">crf 25</td>
                            <td class="px-1">crf 25</td>
                            <td class="px-1">crf 25</td>
                            <td class="px-1 t-light-gray">crf 22</td>
                        </tr>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">rd 1</td>
                            <td class="px-1">rd 1</td>
                            <td class="px-1">rd 1</td>
                            <td class="px-1 t-light-gray">rd 3</td>
                        </tr>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">psy-rd 0</td>
                            <td class="px-1">psy-rd 0</td>
                            <td class="px-1">psy-rd 0</td>
                            <td class="px-1 t-light-gray">psy-rd 1.5</td>
                        </tr>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">psy-rdoq 0</td>
                            <td class="px-1">psy-rdoq 0</td>
                            <td class="px-1">psy-rdoq 0</td>
                            <td class="px-1 t-light-gray">psy-rdoq 2.3</td>
                        </tr>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">deblock -3:0</td>
                            <td class="px-1">deblock -3:0</td>
                            <td class="px-1">deblock -3:0</td>
                            <td class="px-1 t-light-gray">deblock 0:-1</td>
                        </tr>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">aq-mode 3</td>
                            <td class="px-1">aq-mode 3</td>
                            <td class="px-1">aq-mode 3</td>
                            <td class="px-1 t-light-gray">hevc-aq</td>
                        </tr>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">aq-strength 1</td>
                            <td class="px-1">aq-strength 1</td>
                            <td class="px-1">aq-strength 1</td>
                            <td class="px-1 t-light-gray">aq-strength 0.9</td>
                        </tr>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">qg-side 8</td>
                            <td class="px-1">qg-side 8</td>
                            <td class="px-1 t-light-gray">qg-side 64</td>
                            <td class="px-1 t-invert-light">qg-side 8</td>
                        </tr>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">max-tu-size 4</td>
                            <td class="px-1 t-light-gray">max-tu-size 32</td>
                            <td class="px-1 t-light-gray">max-tu-size 32</td>
                            <td class="px-1 t-invert-light">max-tu-size 16</td>
                        </tr>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">no-cutree</td>
                            <td class="px-1">no-cutree</td>
                            <td class="px-1">no-cutree</td>
                            <td class="px-1 t-light-gray">cutree</td>
                        </tr>
                        <tr>
                            <td class="px-1"> </td>
                            <td class="px-1">no-sao</td>
                            <td class="px-1">no-sao</td>
                            <td class="px-1">no-sao</td>
                            <td class="px-1 t-light-gray">limit-sao</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>死区量化器 Deadzone Quantizer</h3>
            <p>x264、x265、AV1 默认的量化算法，通过在频域 0 值分量系子周围设定某个宽度的“死区”，使得其周围的小幅度系数被归零（分为帧间编码块、帧内编码块）实现压缩和，这种算法不需要进行统计，所以快速，但精确度低，需要有一定经验，根据画面类型，结合压缩策略才能调整出合适的值。尽管它被用于优化熵编码，但其算法本质是一种量化器。</p>

            <h3>软判决状态网络优化量化 SDQ Trellis</h3>
            <p>x264、x265 中使用的一种率失真优化量化（RDOQ）算法，通过将所有可能的 CABAC 上下文状态量化结果组网（trellis 状态网络），并使用动态优化（动态规划编程）来找出一条率失真最小的路径，从而权衡量化失真与码率。</p>
            <p class="text-gray-side">注：Trellis 在量化进行 CABAC/CAVLC 熵编码之前，量化之后运行，所以“熵编码上下文结果”是估计出来的。</p>

            <h4>构建状态网络</h4>
            <div class="align-items-center">
                <img loading="lazy" src="files/entropy-coding/Soft-Decision-Quantization-Trellis.png" alt="image50" class="img-medium"><br>
                <p class="text-gray-side">图：从左向右推演的 Trellis 有向无环图。其中节点代表各种状态，边代表状态转换路径。</p>
            </div>
            <ul>
                <li><code class="code-bold">NumEq1</code>：值等于 1 的系子个数</li>
                <li><code class="code-bold">NumLg1</code>：值大于 1 的系子个数</li>
            </ul>
            <p>然后，将这两个参数的组合归纳为 8 种 CABAC 上下文状态：</p>
            <ul>
                <li><code>0_0~3_3</code>：<code class="code-bold">NumEq1_NumLg1</code> 皆在 3 个以内的状态</li>
                <li><code>any_any</code>（<code>x_x</code>）：当 <code class="code-bold">NumLg1</code> 大于等于 4 的状态</li>
                <li><code>any_0</code>（<code>x_0</code>）：当 <code class="code-bold">NumEq1</code>大于等于 4，且 <code class="code-bold">NumLg1</code> 等于 0 的状态</li>
            </ul>
            <p>最后，这些状态组网后构成上图的“NxN 块用”状态网络。</p>

            <h4>状态推演规则</h4>
            <ul>
                <li><b>当前频域系子值等于 1</b>：当前分块调用该频率一次来构成画面，<code class="code-bold">NumEq1</code> 加 1</li>
                <li><b>当前频域系子值大于 1</b>：当前分块调用该频率多次来构成画面，<code class="code-bold">NumLg1</code> 加 1</li>
                <li>若 <code class="code-bold">NumLg1</code> 大于 0，则切换路径到新的分支，弃用纯 <code class="code-bold">NumEq1</code> 的分支</li>
            </ul>

            <h4>软判决率失真优化统计</h4>
            <p>直接统计状态网络中所有线路的率失真程度，找出最优解路线，性能损耗远大于死区量化器，但画质也直接与给定的质量绑定，不需要根据经验设置了。仍然是从「开销=失真+λ⋅码率」得来，区别在它们的取值上：</p>
            <span class="text-blue-math text-larger">\[J = D + \lambda \cdot R\]</span>
            <ul>
                <li><span class="text-blue-math">(J)oule</span>：当前线路的率失真含量，越低越好（码率越低越好、失真越小越好）</li>
                <li><span class="text-blue-math">(D)istortion</span>：失真，由每个“频域系子的分量”与“优化前分量”取平方差（SSE）得出</li>
                <li><span class="text-blue-math">(R)ate</span>：码率，由当前选用路径中，频域分量系子的值之和得出</li>
                <li><span class="text-blue-math">λ</span>：拉格朗日乘数</li>
            </ul>

            <p>状态网络优化量化被称为“软判决量化（Soft decision quantization）”是因为采用了<i>欧几里得距离测量/欧氏测距/全局测量</i>：这里的率失真优化考虑了整个选区（如上例中的 4x4 块），相比直接按量化值对应的除法表在全局上更精确：相对的硬判决量化则是量化值所对应的 DCT 除法表，死区量化器（Deadzone Quantizer）等局部统计出的判决条件。</p>

            <p class="text-gray-side">注：Trellis 还代表任何利用网格绘制方法统计的算法，在视频编码中的近义词还包括：</p>
            <ul>
                <li><b>Psy-trellis</b>：心理学优化，如 x264 的 <code>--psy-rd</code></li>
                <li><b>Viterbi-trellis</b>：解决最短路径，隐马尔科夫问题的维特比寻路算法，用于推演 B 帧位置</li>
                <li><b>Trellis-coded quantization（TCQ）</b>，h.263+ 的卷积内核有限状态机量化优化，停留在理论</li>
            </ul>

            <h2 id="h2-14">环路滤镜</h2>
            <!-- x264 教程副本，更改需手动同步 { -->
            <h3>去块滤镜</h3>
            <p>修复“CRF/ABR 模式在某些场景的部分区域里分配量化值过高时，宏块间出现明显横纵割痕瑕疵”的平滑滤镜。编码器内去块利用了帧内帧间搜索到的信息，而理论上相比外部滤镜误判更少（当然外部滤镜也能做动态和帧内搜索）。去块大体上是检查 1 像素宽，且此块边缘没有较大像素值变化造成的横纵边缘（所以也存在误判）。块失真源自块间不统一的量化程度，有的块量化高流就会从邻近画面里凸现出来。而去块手段是平滑滤镜，因此要降低强度才适用于高码视频，动漫，素材录屏等锐利画面。边界强度 Boundary strength（去块力度判断）</p>
            <div class="align-items-center">
                <img loading="lazy" src="files/deblocking-sao/Deblock-detection-visualization.png" alt="image38" class="img-medium">
                <img loading="lazy" src="files/deblocking-sao/Deblock-edge-visualization.png" alt="image39" class="img-medium">
                <p class="text-gray-side">图：取最小 8x8 范围（两个 4x4 CU）间的界线举例。</p>
            </div>

            <ul class="text-smaller">
                <li>平滑 4：a 与 1 皆为帧内块，且边界位于 CTU/宏块间，最强滤镜值</li>
                <li>平滑 3：a 或 1 皆为帧内块，但边界不在 CTU/宏块间</li>
                <li>平滑 2：a 与 1 皆非帧内块，含一参考源/已编码系子</li>
                <li>平滑 1：a 与 1 皆非帧内块，皆无参考源/已编码系子，溯异帧或动态向量相异</li>
                <li>平滑 0：a 与 1 皆非帧内块，皆无参考源/已编码系子，溯同帧或动态向量相同，滤镜关</li>
            </ul>

            <code class="code-bold">--deblock</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;浮点偏移值，默认 1:0。推荐 0:0，-1:-1，-2:-1&gt;平滑强度：搜索精度。两值于原有强度上增减。</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>平滑<span class="text-blue-emph">≥1</span>时用以压缩</li>
                <li>平滑<span class="text-blue-emph">-2~-1</span>时略降锐度，适合串流</li>
                <li>平滑<span class="text-blue-emph">2</span>适合锐利视频源，4k 电影，游戏录屏。提高码率且会出现块失真</li>
                <li>平滑<span class="text-blue-emph">-3~-2</span>适合高码动画源/桌面录屏。增块失真，但观感仍比 1 好</li>
                <li>搜索<span class="text-blue-emph">大于 2</span>易误判；<span class="text-blue-emph">小于 1</span>会遗漏。建议保持<span class="text-blue-emph">0~-1</span>，除非 qp 大于 26 时设设<span class="text-blue-emph">1</span></li>
            </ul>
            <!-- } -->
            <h3>取样迁就偏移滤镜 Sample adaptive offset</h3>
            <div class="row">
                <p id="LR-UD-025" class="col-10">沿着每个编码树单元 CTU 的划分，应用边缘偏移 Edge offset EO，带状偏移 Band offset BO 和融合 merge 滤镜。用于缓解量化或去块丢失所导致的边缘振铃失真，以及平面蠕虫失真。<span class="text-gray-side">图：上为边缘振铃失真，下为平面蠕虫失真</span></p>
                <img loading="lazy" src="files/deblocking-sao/Sample-Adaptive-Offset-Case.jpg" alt="image40" id="LR-UD-026" class="img-small img-right col-2 mb-auto" >
            </div>
            <h4>边缘振铃失真</h4>
            <div class="row">
                <p id="LR-UD-027" class="col-10">表现为高对比度边缘附近的波纹重影效应，因为量化减少了遮盖低频信号，以使信号整体逼近方形波的高频信号。详见<a href="https://en.wikipedia.org/wiki/Ringing_artifacts">维基百科</a></p>
                <img loading="lazy" src="files/deblocking-sao/Ringing-Distortion.png" alt="image41" id="LR-UD-028" class="img-small img-right col-2 mb-auto" >
            </div>
            <ol>
                <li><b>边缘偏移滤镜</b>：
                    <ul>
                        <li>根据分块结果，在每个 CTU 内建立一批 3x3 像素的采样区域。</li>
                        <li>从这些区域中找到三个像素排成一排的横向、纵向、左倾和右倾四种可能性</li>
                        <li>确认中心像素值小于或大于相邻像素且等于任何一边像素的条件，识别出边界</li>
                        <li>确保 3x3 区域的边界连续性，进行边界验证和性能优化。</li>
                    </ul>
                </li>
                <li><b>带状偏移滤镜</b>：
                    <ul>
                        <li>在 CTU 内根据平面 CTU 对比源加上补偿编码差异。</li>
                        <li>划分 32 条色深带，将当前色深下的像素值均分</li>
                        <li>将这些色深带分为明带 24~31，暗带 0~7，和中间带 8~23</li>
                        <li>最大只能补偿 4 条相连的色深带，确保 CTU 内的色深差异不会大到触发 EO，同时涵盖足够大的斜面渐变。</li>
                        <li>使用率失真优化找到每条色深带的补偿像素值偏移</li>
                    </ul>
                </li>
                <li><b>补偿方案（共 7x8 种）</b>：
                    <ul>
                        <li>7 种补偿方案：<span class="text-gray-side">0=无，1=横向 EO，2=纵向 EO，3=左倾 EO，4=右倾 EO，5=中间带，6=明暗带</span></li>
                        <li>8 种平面选择：<span class="text-gray-side">0=无，1=Y，2=Y+Cr，3=Y+Cb，4=Y+Cb+Cr，5=Cr，6=Cb，7=Cb+Cr</span></li>
                    </ul>
                </li>
                <li><b>融合滤镜 Merge</b>：
                    <ul>
                        <li>将相邻两个 CTU 的 SAO 方案（补偿方案、平面选择）融合，根据参数决定是直接使用上/左块的信息，还是对比像素趋势更接近哪个</li>
                        <li>具体的偏移像素值由率失真优化决定</li>
                    </ul>
                </li>
            </ol>
            
            <code class="code-bold">---no-sao</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;关闭 sao，默认开--sao&gt;由于针对的是强量化环境，所以高画质源+crf 小于 17 的情况下可以关。</p>
            <code class="code-bold">--sao-non-deblock</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;启用后，未经由 deblock 分析的内容会被 sao 分析。</p>
            <code class="code-bold">--no-sao-non-deblock</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;默认&gt;sao 分析跳过视频右边和下边边界。</p>
            <code class="code-bold">--limit-sao</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关&gt;对一些计算采用提前退出策略，不是改善画质的，但 crf≈18，cutree 和 bframes 16 下可以开，以保留一定影响。</p>
            <code class="code-bold">--selective-sao</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;0~4，默认 0&gt;从条带（横向的一组 CTU）角度调整 sao 参数，1 启用 I 条带 sao，2 增加 P 条带，3 增加 B 条带，4 所有条带。可直接控制 sao，或搭配 limit-sao 的新方法。</p>

            <h2 id="h2-15">熵编码/文本压缩 Entropy Coding</h2>
            <p>通过读取信息，统计数值的“结构”，洞察规律，将宏观到微观的“结构”记做符号，再以符号替代原始数据的匹配之处，从而实现信息的熵减。这种压缩手段集齐了所有优点（快速高能效无损高压缩）<del>而广为流传</del>。之所以“文本压缩”能够概括熵编码的定义，是因为音频、视频等数据最终还是以某种形式的文本储存，例如视频帧分块的频域分量系子（整数）和各种元数据（字符串），音频的采样点高度（整数）等。于是，这些数据里的“规律结构”会被称为上下文（Context、语境），压缩流程包括了读取数据、统计上下文和应用压缩。这些步骤环环相扣的形成了完整的编码流程，因此是“编码”。</p>
            <p>虽然熵编码统计“频域分量系子”的路径在不同视频编码中可能会有所差别，但在标准定下后就只会固定使用一条或几条预设路线，且大致上都是某种从右下到左上的迂回（zig-zag）次序了。选择这种方向是因为量化会优先消除高频信号分量系子，使得高频信号分量系子聚集的右下角大减或归零，更容易被熵编码总结和冗余。</p>
            <p class="text-gray-side">注：量化压缩削弱分块的高频信息分量系子后，除去当前分块的内容复杂凹凸外，分块会变成少量的低频分量系子和归零的中到高频分量系子。这本身就是明显的上下文规律。</p>

            <div class="align-items-center">
                <img loading="lazy" src="files/entropy-coding/CABAC-Flow-Chart.png" alt="image42" class="">
                <p class="text-gray-side">图：简化的上下文自适应二进制算数编码<a href="https://iphome.hhi.de/marpe/cabac.html">CABAC 流程</a>，分转二进制，出字概率统计和算数编码三步</p>
            </div>

            <h3>算数编码</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>CABAC 的核心结构。将输入文本按字数多少分割 0~1 间的出字概率。优化是尽可能控制概率分布条上落点（得尽可能短的结果小数），以及通过降噪变换量化和游程编码以简化输入信号，实现尽可能高的无损压缩</p>
                <div class="align-items-center">
                    <img loading="lazy" src="files/entropy-coding/Arithmetic-Coding.png" alt="image43" class="">
                    <p class="text-gray-side">图：编码即逐字按出字概率缩窄概率条到最后一个字的出字概率，取上/下区间为编码结果，解码照概率位置（蓝线）的落点反推实现。</p>
                </div>
    
                <h3>自适应 Adaptive 与对等 Uniform 概率</h3>
                <p>预先统计出字概率（要读取全文）的特性限制了算数编码的用途，而解决方法是利用文本编码一次编一字的特性——以「编一字，一改出字概率」的推演，逐字地适配成合理的概率。添切换符 ⊗ 代表自适概率 0 的生字，以临时用对等概率编码（仅推演概率，编码部分以及 0~1 区间的概率分布变化结合上图）：</p>
                <table class="text-gray-side table-fit-container align-items-center">
                    <thead>
                        <tr>
                            <th>1</th>
                            <th class="text-green-dyna">造词典</th>
                            <th> </th>
                            <th> </th>
                            <th> </th>
                            <th> </th>
                            <th> </th>
                            <th> </th>
                            <th> </th>
                            <th>切换符</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>出字词典</td>
                            <td>h</td>
                            <td>e</td>
                            <td>l</td>
                            <td>o</td>
                            <td> </td>
                            <td>w</td>
                            <td>r</td>
                            <td>d</td>
                            <td>⊗</td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>1</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>对等概率</td>
                            <td>1/8</td>
                            <td>1/8</td>
                            <td>1/8</td>
                            <td>1/8</td>
                            <td>1/8</td>
                            <td>1/8</td>
                            <td>1/8</td>
                            <td>1/8</td>
                            <td>0</td>
                        </tr>
                        <tr>
                            <th>2</th>
                            <th class="text-green-dyna">编码 h</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td class="text-pink-cnsq">1/2</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>1/2</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>生成字符</td>
                            <td class="text-blue-cnsq">⊗h</td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <th>3</th>
                            <th class="text-green-dyna">编码 e</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>1/3</td>
                            <td class="text-pink-cnsq">1/3</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>1/3</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>生成字符</td>
                            <td>⊗h</td>
                            <td class="text-blue-cnsq">⊗e</td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <th>4</th>
                            <th class="text-green-dyna">编码 l</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>1/4</td>
                            <td>1/4</td>
                            <td class="text-pink-cnsq">1/4</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>1/4</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>生成字符</td>
                            <td>⊗h</td>
                            <td>⊗e</td>
                            <td class="text-blue-cnsq">⊗l</td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <th>5</th>
                            <th class="text-green-dyna">编码 l</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>1/5</td>
                            <td>1/5</td>
                            <td class="text-pink-cnsq">2/5</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>1/5</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>生成字符</td>
                            <td>⊗h</td>
                            <td>⊗e</td>
                            <td class="text-blue-cnsq">⊗ll</td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <th>6</th>
                            <th class="text-green-dyna">编码 o</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>1/6</td>
                            <td>1/6</td>
                            <td>2/6</td>
                            <td class="text-pink-cnsq">1/6</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>1/6</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>生成字符</td>
                            <td>⊗h</td>
                            <td>⊗e</td>
                            <td>⊗ll</td>
                            <td class="text-blue-cnsq">⊗o</td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <th>7</th>
                            <th class="text-green-dyna">编码空格</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>1/7</td>
                            <td>1/7</td>
                            <td>2/7</td>
                            <td>1/7</td>
                            <td class="text-pink-cnsq">1/7</td>
                            <td>0</td>
                            <td>0</td>
                            <td>0</td>
                            <td>1/7</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>生成字符</td>
                            <td>⊗h</td>
                            <td>⊗e</td>
                            <td>⊗ll</td>
                            <td>⊗o</td>
                            <td class="text-blue-cnsq">⊗</td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <th>8</th>
                            <th class="text-green-dyna">编码 w</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>1/8</td>
                            <td>1/8</td>
                            <td>2/8</td>
                            <td>1/8</td>
                            <td>1/8</td>
                            <td class="text-pink-cnsq">1/8</td>
                            <td>0</td>
                            <td>0</td>
                            <td>1/8</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>生成字符</td>
                            <td>⊗h</td>
                            <td>⊗e</td>
                            <td>⊗ll</td>
                            <td>⊗o</td>
                            <td>⊗</td>
                            <td class="text-blue-cnsq">⊗w</td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <th>9</th>
                            <th class="text-green-dyna">编码 o</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>1/9</td>
                            <td>1/9</td>
                            <td>2/9</td>
                            <td>2/9</td>
                            <td>1/9</td>
                            <td class="text-pink-cnsq">1/9</td>
                            <td>0</td>
                            <td>0</td>
                            <td>1/9</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>生成字符</td>
                            <td>⊗h</td>
                            <td>⊗e</td>
                            <td>⊗ll</td>
                            <td>⊗o</td>
                            <td>⊗</td>
                            <td class="text-blue-cnsq">⊗wo</td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <th>10</th>
                            <th class="text-green-dyna">编码 r</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>1/10</td>
                            <td>1/10</td>
                            <td>2/10</td>
                            <td>2/10</td>
                            <td>1/10</td>
                            <td>1/10</td>
                            <td class="text-pink-cnsq">1/10</td>
                            <td>0</td>
                            <td>1/10</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>生成字符</td>
                            <td>⊗h</td>
                            <td>⊗e</td>
                            <td>⊗ll</td>
                            <td>⊗o</td>
                            <td>⊗</td>
                            <td>⊗wo</td>
                            <td class="text-blue-cnsq">⊗r</td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <th>11</th>
                            <th class="text-green-dyna">编码 l</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>1/11</td>
                            <td>1/11</td>
                            <td>3/11</td>
                            <td>2/11</td>
                            <td>1/11</td>
                            <td>1/11</td>
                            <td class="text-pink-cnsq">1/11</td>
                            <td>0</td>
                            <td>1/11</td>
                        </tr>
                        <tr class="border-bottom">
                            <td>生成字符</td>
                            <td>⊗h</td>
                            <td>⊗e</td>
                            <td>⊗ll</td>
                            <td>⊗o</td>
                            <td>⊗</td>
                            <td>⊗wo</td>
                            <td class="text-blue-cnsq">⊗rl</td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <th>12</th>
                            <th class="text-green-dyna">编码 d</th>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                            <td> </td>
                        </tr>
                        <tr>
                            <td>自适概率</td>
                            <td>1/12</td>
                            <td>1/12</td>
                            <td>3/12</td>
                            <td>2/12</td>
                            <td>1/12</td>
                            <td>1/12</td>
                            <td>1/12</td>
                            <td class="text-pink-cnsq">1/12</td>
                            <td>1/12</td>
                        </tr>
                        <tr>
                            <td>生成字符</td>
                            <td>⊗h</td>
                            <td>⊗e</td>
                            <td>⊗ll</td>
                            <td>⊗o</td>
                            <td>⊗</td>
                            <td>⊗wo</td>
                            <td>⊗rl</td>
                            <td class="text-blue-cnsq">⊗d</td>
                            <td>EOF</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>上下文自适应——类 LZ 的 PPM 推演法简化版</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>拓展上例思路作上下文长 0——CTX0 时的推演，添加 CTX1 或更高的范围。每进一位字就「先查长，后查短，生字用对等；匹长概大，配短概小」的上下文自适应出字概率推演。其中部分匹配预测法 Prediction by Partial Matching 设最长 3 字编码 DNA 链单侧的 CTAGGCAATCTAGGTA 时，推演过程如下：</p>
                <ul class="text-gray-side text-smaller">
                    <li>CTX<sub>-1</sub>-—无上下文 (null) 的 <sub>-1</sub>初始态，储存对等概率，编码生字</li>
                    <li>CTX<sub>0</sub>——输入=字符 1 时，上下文为“”的状态，一次输一字，相当于自适应概率本身</li>
                    <li>CTX<sub>1</sub>——输入=字符 2 时，上下文为“&lt;字符 1&gt;”的状态</li>
                    <li>CTX<sub>2</sub>——输入≥字符 n 时，上下文为“&lt;…&gt;&lt;字符 n-2&gt;&lt;字符 n-1&gt;”的状态</li>
                    <li>⊗———切换符，叠加以显示临时倒退了多少个 CTX 表，各个 CTX 表也因此有 ⊗ 的概率</li>
                    <li>「匹长概大，配短概小」: 先用最长且小于等于已知上下文长度的 CTXn 编码输入符号，该情况下出字概率最大</li>
                </ul>
                <ol class="text-smaller">
                    <li>
                        据已知上下文内容找到各个长度上下文中的概率分组（此处用分色表示）
                        <ol>
                            <li>新组 ⊗ 的概率记为 1 倍，匹配到同组则用最新的概率倍数</li>
                            <li>旧组 ⊗ 的概率为最新的概率倍，如已存在一项则 ⊗ 的概率为 1/2</li>
                        </ol>
                    </li>
                    <li><b>小计</b>：统计 2，2A，2B 的编码文本与概率结果</li>
                    <li>
                        <b>CTX 更新</b>：统计 2，2A，2B 的编码文本与概率结果
                        <ol>
                            <li>新组建立新的½概率，添加对应的 ⊗ 概率</li>
                            <li>旧组更新概率，如 1/2 到 2/3，1/3 到 2/4，以及更新 ⊗ 概率</li>
                        </ol>
                    </li>
                </ol>

                <div class="overflow-auto">
                    <table class="table-fit-container align-items-center text-xs">
                        <thead class="thead-no-border">
                            <tr class="t-invert-dark">
                                <th>出字词典</th>
                                <th>C</th>
                                <th>T</th>
                                <th>A</th>
                                <th>G</th>
                                <th>⊗</th>
                                <th> </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="t-invert-dark">
                                <td>等概 CTX<sub>-1</sub></td>
                                <td>1/5</td>
                                <td>1/5</td>
                                <td>1/5</td>
                                <td>1/5</td>
                                <td>1/5</td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light"><!--1-->
                                <th>1:</th>
                                <td>输入 C</td>
                                <td>已知 null</td>
                                <td>null 长 0</td>
                                <td class="t-align-right"><span class="text-red-emph">C</span>TAGGCAATC</td>
                                <td class="t-align-left">TAGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--1-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 匹配⊗</td>
                                <td>CTX<sub>-1</sub>配 C</td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--1-->
                                <td>已知长 0 跳过 </td>
                                <td>已知长 0 跳过</td>
                                <td>已知长 0 跳过</td>
                                <td>⊗</td>
                                <td>C</td>
                                <td>"⊗C"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--1-->
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>P⊗ = 1</td>
                                <td>P(C)=1/5</td>
                                <td>1×1/5</td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--1-->
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>P(""C)=1/2</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr"><!--1-->
                                <td>⊗ 概率</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>P⊗=1/2</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light"><!--2-->
                                <th>2：</th>
                                <td>输入 T</td>
                                <td>已知"C"</td>
                                <td>已知长 1</td>
                                <td class="t-align-right"><span class="text-blue-emph">C</span><span class="text-red-emph">T</span>AGGCAATC</td>
                                <td class="t-align-left">TAGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--2-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 匹配⊗</td>
                                <td>CTX<sub>-1</sub>配 T</td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--2-->
                                <td>已知长 1 跳过 </td>
                                <td>已知长 1 跳过</td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>T</td>
                                <td>"⊗⊗T"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--2-->
                                <td> </td>
                                <td> </td>
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1/2</td>
                                <td>P(T)=1/5</td>
                                <td>1×1/2×<br>1/5</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--2-->
                                <td> </td>
                                <td> </td>
                                <td>P("C"T)=1/2</td>
                                <td>P(""C)=1/3</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--2-->
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>P(""T)=1/3</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr"><!--2-->
                                <td>⊗ 概率</td>
                                <td> </td>
                                <td> </td>
                                <td>P⊗=1/2</td>
                                <td>P⊗=1/3</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light"><!--3-->
                                <th>3：</th>
                                <td>输入 A</td>
                                <td>已知"CT"</td>
                                <td>已知长 2</td>
                                <td class="t-align-right"><span class="text-blue-emph">CT</span><span class="text-red-emph">A</span>GGCAATC</td>
                                <td class="t-align-left">TAGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--3-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 匹配⊗</td>
                                <td>CTX<sub>-1</sub>配 A</td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--3-->
                                <td>已知长 2 跳过 </td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>A</td>
                                <td>"⊗⊗⊗A"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--3-->
                                <td> </td>
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1/3</td>
                                <td>P(A)=1/5</td>
                                <td>1×1×<br>1/3×1/5</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--3-->
                                <td> </td>
                                <td>P("CT"A)=1/2</td>
                                <td>P("C"T)=1/2</td>
                                <td>P(""C)=1/4</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--3-->
                                <td> </td>
                                <td> </td>
                                <td>P("T"A)=1/2</td>
                                <td>P(""T)=1/4</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--3-->
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>P(""A)=1/4</td>
                                <td> </td>
                                <td> </td><!--3-->
                            </tr>
                            <tr class="border-lr">
                                <td>⊗ 概率</td>
                                <td> </td>
                                <td>P⊗=1/2</td>
                                <td>P⊗=1/2,1/2</td>
                                <td>P⊗=1/4</td>
                                <td> </td>
                                <td> </td><!--3-->
                            </tr>
                            <tr class="t-invert-light"><!--4-->
                                <th>4：</th>
                                <td>输入 G</td>
                                <td>已知"CTA"</td>
                                <td>已知长 3</td>
                                <td class="t-align-right"><span class="text-blue-emph">CTA</span><span class="text-red-emph">G</span>GCAATC</td>
                                <td class="t-align-left">TAGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--4-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 匹配⊗</td>
                                <td>CTX<sub>-1</sub>配 G</td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--4-->
                                <td>⊗ </td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>G</td>
                                <td>"⊗⊗⊗⊗G"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--4-->
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1/4</td>
                                <td>P(G)=1/5</td>
                                <td>1×1×<br>1×1/5×<br>1/4×1/5</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--4-->
                                <td>P("CTA"G)=1/2</td>
                                <td>P("CT"A)=1/2</td>
                                <td>P("C"T)=1/2</td>
                                <td>P(""C)=1/5</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--4-->
                                <td> </td>
                                <td>P("TA"G)=1/2</td>
                                <td>P("T"A)=1/2</td>
                                <td>P(""T)=1/5</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--4-->
                                <td> </td>
                                <td> </td>
                                <td>P("A"G)=1/2</td>
                                <td>P(""A)=1/5</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--4-->
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>P(""G)=1/5</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr"><!--5-->
                                <td>⊗ 概率</td>
                                <td>P⊗=1/2</td>
                                <td>P⊗=1/2,1/2</td>
                                <td>P⊗=1/2,1/2,<br>1/2</td>
                                <td>P⊗=1/5</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light"><!--5-->
                                <th>5：</th>
                                <td>输入 G</td>
                                <td>已知"TAG"</td>
                                <td> </td>
                                <td class="t-align-right"><span class="text-blue-emph">CTAG</span><span class=text-red-emph>G</span>CAATC</td>
                                <td class="t-align-left">TAGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--5-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 配 G</td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--5-->
                                <td>⊗ </td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>G</td>
                                <td> </td>
                                <td>"⊗⊗⊗G"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--5-->
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1</td>
                                <td>P(""G)=1/5</td>
                                <td> </td>
                                <td>1×1×1</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--5-->
                                <td>P("CTA"G)=1/2</td>
                                <td>P("CT"A)=1/2</td>
                                <td>P("C"T)=1/2</td>
                                <td>P(""C)=1/6</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--5-->
                                <td>P("TAG"G)=1/2</td>
                                <td>P("TA"A)=1/2</td>
                                <td>P("T"A)=1/2</td>
                                <td>P(""T)=1/6</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--5-->
                                <td>P("AG"G)=1/2</td>
                                <td>P("A"G)=1/2</td>
                                <td>P(""A)=1/6</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--5-->
                                <td> </td>
                                <td>P("G"G)=1/2</td>
                                <td>P(""G)=2/6</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr"><!--5-->
                                <td>⊗ 概率</td>
                                <td>P⊗=1/2,1/2</td>
                                <td>P⊗=1/2,1/2,<br>1/2</td>
                                <td>P⊗=1/2,1/2,<br>1/2,1/2</td>
                                <td>P⊗=1/6</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light"><!--6-->
                                <th>6：</th>
                                <td>输入 C</td>
                                <td>已知"AGG"</td>
                                <td> </td>
                                <td class="t-align-right"><span class="text-blue-emph">CTAGG</span><span class="text-red-emph">C</span>AATC</td>
                                <td class="t-align-left">TAGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--6-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 配 C</td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--6-->
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>C</td>
                                <td> </td>
                                <td>"⊗⊗⊗C"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--6-->
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1</td>
                                <td>P"G"⊗ = 1/2</td>
                                <td>P(""C)=1/6</td>
                                <td> </td>
                                <td>1×1×<br>1/2×1/6</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--6-->
                                <td>P("CTA"G)=1/2</td>
                                <td>P("CT"A)=1/2</td>
                                <td>P("C"T)=1/2</td>
                                <td>P(""C)=2/7</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--6-->
                                <td>P("TAG"G)=1/2</td>
                                <td>P("TA"G)=1/2</td>
                                <td>P("T"A)=1/2</td>
                                <td>P(""T)=1/7</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--6-->
                                <td>P("AGG"C)=1/2</td>
                                <td>P("AG"G)=1/2</td>
                                <td>P("A"G)=1/2</td>
                                <td>P(""A)=1/7</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--6-->
                                <td> </td>
                                <td>P("GG"C)=1/2</td>
                                <td>P("G"G)=1/3</td>
                                <td>P(""G)=2/7</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--6-->
                                <td> </td>
                                <td> </td>
                                <td>P("G"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr"><!--6-->
                                <td>⊗ 概率</td>
                                <td>P⊗=1/2,1/2,<br>1/2</td>
                                <td>P⊗=1/2,1/2,<br>1/2,1/2</td>
                                <td>P⊗=1/2,1/2,<br>1/2,1/3</td>
                                <td>P⊗=1/7</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light">
                                <th>7：</th><!--7-->
                                <td>输入 A</td>
                                <td>已知"GGC"</td>
                                <td> </td>
                                <td class="t-align-right"><span class="text-blue-emph">CTAGGC</span><span class="text-red-emph">A</span>ATC</td>
                                <td class="t-align-left">TAGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--7-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 配 A</td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--7-->
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>A</td>
                                <td> </td>
                                <td>"⊗⊗⊗A"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--7-->
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1/2</td>
                                <td>P(""A)=1/7</td>
                                <td> </td>
                                <td>1/2×1/7</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--7-->
                                <td>P("CTA"G)=1/2</td>
                                <td>P("CT"A)=1/2</td>
                                <td>P("C"T)=1/3</td>
                                <td>P(""C)=2/8</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--7-->
                                <td>P("TAG"G)=1/2</td>
                                <td>P("TA"G)=1/2</td>
                                <td>P("T"A)=1/2</td>
                                <td>P(""T)=1/8</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--7-->
                                <td>P("AGG"C)=1/2</td>
                                <td>P("AG"G)=1/2</td>
                                <td>P("A"G)=1/2</td>
                                <td>P(""A)=2/8</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--7-->
                                <td>P("GGC"A)=1/2</td>
                                <td>P("GG"C)=1/2</td>
                                <td>P("G"G)=1/3</td>
                                <td>P(""G)=2/8</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--7-->
                                <td> </td>
                                <td>P("GC"A)=1/2</td>
                                <td>P("G"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--7-->
                                <td> </td>
                                <td> </td>
                                <td>P("C"A)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>⊗ 概率</td><!--7-->
                                <td>1/2,1/2,1/2,<br>1/2</td>
                                <td>1/2,1/2,1/2,<br>1/2,1/2</td>
                                <td>1/3,1/2,1/2,<br>1/3</td>
                                <td>P⊗=1/8</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light">
                                <th>8：</th><!--8-->
                                <td>输入 A</td>
                                <td>已知"GCA"</td>
                                <td> </td>
                                <td class="t-align-right"><span class="text-blue-emph">CTAGGCA</span><span class="text-red-emph">A</span>TC</td>
                                <td class="t-align-left">TAGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--8-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 配 A</td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--8-->
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>A</td>
                                <td> </td>
                                <td>"⊗⊗⊗A"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--8-->
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1</td>
                                <td>P"A"⊗ = 1/2</td>
                                <td>P(""A)=1/8</td>
                                <td> </td>
                                <td>1/2×2/8</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--8-->
                                <td>P("CTA"G)=1/2</td>
                                <td>P("CT"A)=1/2</td>
                                <td>P("C"T)=1/3</td>
                                <td>P(""C)=2/9</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--8-->
                                <td>P("TAG"G)=1/2</td>
                                <td>P("TA"G)=1/2</td>
                                <td>P("T"A)=1/2</td>
                                <td>P(""T)=1/9</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--8-->
                                <td>P("AGG"C)=1/2</td>
                                <td>P("AG"G)=1/2</td>
                                <td>P("A"G)=1/3</td>
                                <td>P(""A)=3/9</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--8-->
                                <td>P("GGC"A)=1/2</td>
                                <td>P("GG"C)=1/2</td>
                                <td>P("G"G)=1/3</td>
                                <td>P(""G)=2/9</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--8-->
                                <td>P("GCA"A)=1/2</td>
                                <td>P("GC"A)=1/2</td>
                                <td>P("G"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--8-->
                                <td> </td>
                                <td>P("CA"A)=1/2</td>
                                <td>P("C"A)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--8-->
                                <td> </td>
                                <td> </td>
                                <td>P("A"A)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>⊗ 概率</td><!--8-->
                                <td>1/2,1/2,1/2,<br>1/2,1/2</td>
                                <td>1/2,1/2,1/2,<br>1/2,1/2,1/2</td>
                                <td>1/3,1/2,1/3,<br>1/3</td>
                                <td>P⊗=1/9</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light">
                                <th>9：</th><!--9-->
                                <td> </td>
                                <td>已知"CAA"</td>
                                <td> </td>
                                <td class="t-align-right"><span class="text-blue-emph">CTAGGCAA</span><span class="text-red-emph">T</span>C</td>
                                <td class="t-align-left">TAGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--9-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 配 T</td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--9-->
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>T</td>
                                <td> </td>
                                <td>"⊗⊗⊗T"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--9-->
                                <td>P⊗ = 1</td>
                                <td>P"CA"⊗ = 1/2</td>
                                <td>P"A"⊗ = 1/3</td>
                                <td>P(""A)=1/9</td>
                                <td> </td>
                                <td>1/2×1/3×<br>1/9</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--9-->
                                <td>P("CTA"G)=1/2</td>
                                <td>P("CT"A)=1/2</td>
                                <td>P("C"T)=1/3</td>
                                <td>P(""C)=2/10</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--9-->
                                <td>P("TAG"G)=1/2</td>
                                <td>P("TA"G)=1/2</td>
                                <td>P("T"A)=1/2</td>
                                <td>P(""T)=2/10</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--9-->
                                <td>P("AGG"C)=1/2</td>
                                <td>P("AG"G)=1/2</td>
                                <td>P("A"G)=1/4</td>
                                <td>P(""A)=3/10</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--9-->
                                <td>P("GGC"A)=1/2</td>
                                <td>P("GG"C)=1/2</td>
                                <td>P("G"G)=1/3</td>
                                <td>P(""G)=2/10</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--9-->
                                <td>P("GCA"A)=1/2</td>
                                <td>P("GC"A)=1/2</td>
                                <td>P("G"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--9-->
                                <td>P("CAA"T)=1/2</td>
                                <td>P("CA"A)=1/3</td>
                                <td>P("C"A)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--9-->
                                <td> </td>
                                <td>P("CA"T)=1/3</td>
                                <td>P("A"A)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--9-->
                                <td> </td>
                                <td> </td>
                                <td>P("A"T)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>⊗ 概率</td><!--9-->
                                <td>1/2,1/2,1/2,<br>1/2,1/2</td>
                                <td>1/2,1/2,1/2,<br>1/2,1/2,1/3</td>
                                <td>1/3,1/2,1/4,<br>1/3</td>
                                <td>P⊗=1/10</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light">
                                <th>10：</th><!--10-->
                                <td>输入 C</td>
                                <td>已知"AAT"</td>
                                <td> </td>
                                <td class="t-align-right"><span class="text-blue-emph">CTAGGCAAT</span><span class="text-red-emph">C</span></td>
                                <td class="t-align-left">TAGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--10-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 配 C</td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--10-->
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>C</td>
                                <td> </td>
                                <td>"⊗⊗⊗C"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--10-->
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1</td>
                                <td>P"T"⊗ = 1/2</td>
                                <td>P(""C)=2/10</td>
                                <td> </td>
                                <td>1/2×2/10</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--10-->
                                <td>P("CTA"G)=1/2</td>
                                <td>P("CT"A)=1/2</td>
                                <td>P("C"T)=1/3</td>
                                <td>P(""C)=3/11</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--10-->
                                <td>P("TAG"G)=1/2</td>
                                <td>P("TA"G)=1/2</td>
                                <td>P("T"A)=1/3</td>
                                <td>P(""T)=2/11</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--10-->
                                <td>P("AGG"C)=1/2</td>
                                <td>P("AG"G)=1/2</td>
                                <td>P("A"G)=1/4</td>
                                <td>P(""A)=3/11</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--10-->
                                <td>P("GGC"A)=1/2</td>
                                <td>P("GG"C)=1/2</td>
                                <td>P("G"G)=1/3</td>
                                <td>P(""G)=2/11</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--10-->
                                <td>P("GCA"A)=1/2</td>
                                <td>P("GC"A)=1/2</td>
                                <td>P("G"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--10-->
                                <td>P("CAA"T)=1/2</td>
                                <td>P("CA"A)=1/3</td>
                                <td>P("C"A)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--10-->
                                <td>P("AAT"C)=1/2</td>
                                <td>P("CA"T)=1/3</td>
                                <td>P("A"A)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--10-->
                                <td> </td>
                                <td>P("AT"C)=1/2</td>
                                <td>P("A"T)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--10-->
                                <td> </td>
                                <td> </td>
                                <td>P("T"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>⊗ 概率</td><!--10-->
                                <td>1/2,1/2,1/2,<br>1/2,1/2,1/2</td>
                                <td>1/2,1/2,1/2,<br>1/2,1/2,1/3,<br>1/2</td>
                                <td>1/3,1/3,1/4,<br>1/3</td>
                                <td>P⊗=1/11</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light">
                                <th>11：</th><!--11-->
                                <td>输入 T</td>
                                <td>已知"ATC"</td>
                                <td> </td>
                                <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                                <td class="t-align-left"><span class="text-red-emph">T</span>AGGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--11-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td> </td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--11-->
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>T</td>
                                <td> </td>
                                <td> </td>
                                <td>"⊗⊗T"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--11-->
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1</td>
                                <td>P"T"⊗ = 1/3</td>
                                <td> </td>
                                <td> </td>
                                <td>1/3</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--11-->
                                <td>P("CTA"G)=1/2</td>
                                <td>P("CT"A)=1/2</td>
                                <td>P("C"T)=2/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--11-->
                                <td>P("TAG"G)=1/2</td>
                                <td>P("TA"G)=1/2</td>
                                <td>P("T"A)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--11-->
                                <td>P("AGG"C)=1/2</td>
                                <td>P("AG"G)=1/2</td>
                                <td>P("A"G)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--11-->
                                <td>P("GGC"A)=1/2</td>
                                <td>P("GG"C)=1/2</td>
                                <td>P("G"G)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--11-->
                                <td>P("GCA"A)=1/2</td>
                                <td>P("GC"A)=1/2</td>
                                <td>P("G"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--11-->
                                <td>P("CAA"T)=1/2</td>
                                <td>P("CA"A)=1/3</td>
                                <td>P("C"A)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--11-->
                                <td>P("AAT"C)=1/2</td>
                                <td>P("CA"T)=1/3</td>
                                <td>P("A"A)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--11-->
                                <td>P("ATC"T)=1/2</td>
                                <td>P("AT"C)=1/2</td>
                                <td>P("A"T)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--11-->
                                <td> </td>
                                <td>P("TC"T)=1/2</td>
                                <td>P("T"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>⊗ 概率</td>
                                <td>1/2,1/2,1/2,<br>1/2,1/2,1/2,<br>1/2</td><!--11-->
                                <td>1/2,1/2,1/2,<br>1/2,1/2,1/3,<br>1/2,1/2</td>
                                <td>1/4,1/3,1/4,<br>1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light">
                                <th>12：</th><!--12-->
                                <td>输入 A</td>
                                <td>已知"TCT"</td>
                                <td> </td>
                                <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                                <td class="t-align-left"><span class="text-blue-emph">T</span><span class="text-red-emph">A</span>GGTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--12-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配 A</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--12-->
                                <td>⊗</td>
                                <td>A</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>"⊗A"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--12-->
                                <td>P⊗ = 1</td>
                                <td>P⊗ = 1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>1/2</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--12-->
                                <td>P("CTA"G)=1/2</td>
                                <td>P("CT"A)=2/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--12-->
                                <td>P("TAG"G)=1/2</td>
                                <td>P("TA"G)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--12-->
                                <td>P("AGG"C)=1/2</td>
                                <td>P("AG"G)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--12-->
                                <td>P("GGC"A)=1/2</td>
                                <td>P("GG"C)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--12-->
                                <td>P("GCA"A)=1/2</td>
                                <td>P("GC"A)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--12-->
                                <td>P("CAA"T)=1/2</td>
                                <td>P("CA"A)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--12-->
                                <td>P("AAT"C)=1/2</td>
                                <td>P("CA"T)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--12-->
                                <td>P("ATC"T)=1/2</td>
                                <td>P("AT"C)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--12-->
                                <td>P("TCT"A)=1/2</td>
                                <td>P("TC"T)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>⊗ 概率</td><!--12-->
                                <td>1/2,1/2,1/2,<br>1/2,1/2,1/2,<br>1/2,1/2</td>
                                <td>1/3,1/2,1/2,<br>1/2,1/2,1/3,<br>1/2,1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-bottom t-invert-light">
                                <th>13：</th><!--13-->
                                <td>输入 G</td>
                                <td>已知"CTA"</td>
                                <td> </td>
                                <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                                <td class="t-align-left"><span class="text-blue-emph">TA</span><span class="text-red-emph">G</span>GTA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--13-->
                                <td>CTX3 匹配 G</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--13-->
                                <td>G</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>"G"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--13-->
                                <td>P"CTA"G=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>1/2</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--13-->
                                <td>P("CTA"G)=2/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--13-->
                                <td>P("TAG"G)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--13-->
                                <td>P("AGG"C)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--13-->
                                <td>P("GGC"A)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--13-->
                                <td>P("GCA"A)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--13-->
                                <td>P("CAA"T)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--13-->
                                <td>P("AAT"C)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--13-->
                                <td>P("ATC"T)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--13-->
                                <td>P("TCT"A)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>⊗ 概率</td><!--13-->
                                <td>1/3,1/2,1/2,<br>1/2,1/2,1/2,<br>1/2,1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light">
                                <th>14：</th><!--14-->
                                <td>输入 G</td>
                                <td>已知"TAG"</td>
                                <td> </td>
                                <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                                <td class="t-align-left"><span class="text-blue-emph">TAG</span><span class="text-red-emph">G</span>TA</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--14-->
                                <td>CTX3 匹配 G</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--14-->
                                <td>G</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>"G"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--14-->
                                <td>P"CTA"G=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td>1/2</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--14-->
                                <td>P("CTA"G)=2/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--14-->
                                <td>P("TAG"G)=2/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--14-->
                                <td>P("AGG"C)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--14-->
                                <td>P("GGC"A)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--14-->
                                <td>P("GCA"A)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--14-->
                                <td>P("CAA"T)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--14-->
                                <td>P("AAT"C)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--14-->
                                <td>P("ATC"T)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--14-->
                                <td>P("TCT"A)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>⊗ 概率</td><!--14-->
                                <td>1/3,1/3,1/2,<br>1/2,1/2,1/2,<br>1/2,1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-bottom t-invert-light">
                                <th>15：</th><!--15-->
                                <td>输入 T</td>
                                <td>已知"AGG"</td>
                                <td> </td>
                                <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                                <td class="t-align-left"><span class="text-blue-emph">TAGG</span><span class="text-red-emph">T</span>A</td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--15-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配⊗</td>
                                <td>CTX0 配 T</td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--15-->
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>T</td>
                                <td> </td>
                                <td>"⊗⊗⊗T"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--15-->
                                <td>P"AGG"⊗=1/2</td>
                                <td>P"GG"⊗ = 1/2</td>
                                <td>P"G"⊗ = 1/3</td>
                                <td>P(""C)=2/11</td>
                                <td> </td>
                                <td>1/2×1/2×<br>1/3×2/11</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--15-->
                                <td>P("CTA"G)=2/3</td>
                                <td>P("CT"A)=2/3</td>
                                <td>P("C"T)=2/4</td>
                                <td>P(""C)=3/12</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--15-->
                                <td>P("TAG"G)=2/3</td>
                                <td>P("TA"G)=1/2</td>
                                <td>P("T"A)=1/3</td>
                                <td>P(""T)=3/12</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--15-->
                                <td>P("AGG"C)=1/3</td>
                                <td>P("AG"G)=1/2</td>
                                <td>P("A"G)=1/4</td>
                                <td>P(""A)=3/11</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--15-->
                                <td>P("GGC"A)=1/2</td>
                                <td>P("GG"C)=1/3</td>
                                <td>P("G"G)=1/3</td>
                                <td>P(""G)=2/11</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--15-->
                                <td>P("GCA"A)=1/2</td>
                                <td>P("GC"A)=1/2</td>
                                <td>P("G"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--15-->
                                <td>P("CAA"T)=1/2</td>
                                <td>P("CA"A)=1/3</td>
                                <td>P("C"A)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--15-->
                                <td>P("AAT"C)=1/2</td>
                                <td>P("CA"T)=1/3</td>
                                <td>P("A"A)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--15-->
                                <td>P("ATC"T)=1/2</td>
                                <td>P("AT"C)=1/2</td>
                                <td>P("A"T)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--15-->
                                <td>P("TCT"A)=1/2</td>
                                <td>P("TC"T)=1/2</td>
                                <td>P("T"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--15-->
                                <td>P("AGG"T)=1/3</td>
                                <td>P("GG"T)=1/3</td>
                                <td>P("G"T)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>⊗ 概率</td><!--15-->
                                <td>1/3,1/3,1/3,<br>1/2,1/2,1/2,<br>1/2,1/2</td>
                                <td>1/3,1/2,1/2,<br>1/3,1/2,1/3,<br>1/2,1/2</td>
                                <td>1/4,1/3,1/4,<br>1/4</td>
                                <td>P⊗=1/12</td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="t-invert-light">
                                <th>16：</th><!--16-->
                                <td>输入 A</td>
                                <td>已知"GGT"</td>
                                <td> </td>
                                <td class="t-align-right text-blue-emph">CTAGGCAATC</td>
                                <td class="t-align-left"><span class="text-blue-emph">TAGTAGGT</span><span class="text-red-emph">A</span></td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr text-green-dyna">
                                <td>CTX 匹配</td><!--16-->
                                <td>CTX3 匹配⊗</td>
                                <td>CTX2 匹配⊗</td>
                                <td>CTX1 匹配 A</td>
                                <td> </td>
                                <td> </td>
                                <td>小计</td>
                            </tr>
                            <tr class="border-lr text-blue-cnsq">
                                <td>编码结果</td><!--16-->
                                <td>⊗</td>
                                <td>⊗</td>
                                <td>A</td>
                                <td> </td>
                                <td> </td>
                                <td>"⊗⊗A"</td>
                            </tr>
                            <tr class="border-lr text-pink-cnsq">
                                <td>概率结果</td><!--16-->
                                <td>P⊗=1/2</td>
                                <td>P⊗ = 1</td>
                                <td>P"T"A = 1/3</td>
                                <td> </td>
                                <td> </td>
                                <td>1/2×1/3</td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--16-->
                                <td>P("CTA"G)=2/3</td>
                                <td>P("CT"A)=2/3</td>
                                <td>P("C"T)=2/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--16-->
                                <td>P("TAG"G)=2/3</td>
                                <td>P("TA"G)=1/2</td>
                                <td>P("T"A)=2/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--16-->
                                <td>P("AGG"C)=1/3</td>
                                <td>P("AG"G)=1/2</td>
                                <td>P("A"G)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--16-->
                                <td>P("GGC"A)=1/2</td>
                                <td>P("GG"C)=1/3</td>
                                <td>P("G"G)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--16-->
                                <td>P("GCA"A)=1/2</td>
                                <td>P("GC"A)=1/2</td>
                                <td>P("G"C)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--16-->
                                <td>P("CAA"T)=1/2</td>
                                <td>P("CA"A)=1/3</td>
                                <td>P("C"A)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--16-->
                                <td>P("AAT"C)=1/2</td>
                                <td>P("CA"T)=1/3</td>
                                <td>P("A"A)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--16-->
                                <td>P("ATC"T)=1/2</td>
                                <td>P("AT"C)=1/2</td>
                                <td>P("A"T)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--16-->
                                <td>P("TCT"A)=1/2</td>
                                <td>P("TC"T)=1/2</td>
                                <td>P("T"C)=1/4</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr">
                                <td>CTX 更新</td><!--16-->
                                <td>P("AGG"T)=1/3</td>
                                <td>P("GG"T)=1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>CTX 更新</td><!--16-->
                                <td>P("GGT"A)=1/2</td>
                                <td>P("GT"A)=1/2</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                            <tr class="border-lr border-bottom">
                                <td>⊗ 概率</td><!--16-->
                                <td>1/3,1/3,1/3,<br>1/2,1/2,1/2,<br>1/2,1/2,1/2</td>
                                <td>1/3,1/2,1/2,<br>1/3,1/2,1/3,<br>1/2,1/2,1/2</td>
                                <td>1/4,1/4,1/4,<br>1/3</td>
                                <td> </td>
                                <td> </td>
                                <td> </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <p>PPM 非常适合推演 DNA 链 的出字概率，因为人类细胞染色体多达 0.5~25 亿端，而上表在全文未知的情况下已经把最优的出字概率分布总结得差不多了。这种以查表推演 Table lookup 是一种计算特性，与之相对的特性是有限状态机推演。</p>
            </div>

            <h3>有限状态机 Finite-State Machine</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <div class="row">
                    <p id="LR-UD-029" class="col-10">以状态描述程序/机器。如 1~2 间可过渡出无限个数字，代表机械运动到位的中间过程；去掉过程后（如取整后）剩下圆圈数字表示的①↔②两种状态，就足以抽象地表示按动式圆珠笔；将两态联系起来的操作表示为箭头，即按下笔的按钮，而输出就是下一状态。若需要将笔伸出（需②）而笔已收拢则写作 ①→⓶；若需收拢而笔已伸出则 ②→⓵</p>
                    <img loading="lazy" src="files/entropy-coding/Double-Action-Ball-Point-Pen.png" alt="image44" id="LR-UD-030" class="img-small img-right col-2 mb-auto" >
                </div>
                <div class="align-items-center">
                    <img loading="lazy" src="files/entropy-coding/Finite-State-Machine-on-DB-Pen.png" alt="image45" class="img-medium">
                </div>
            </div>
            
            <h3>上下文自适应——有限状态机推演法</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>二进制算数编码 BAC 下只有大于 50% 出字概率，以及小于 50% 出字概率的两种值，因此设立最大概符 Most-probable symbol MPS 和最小概符 Least-probable symbol LPS
                    两个变量。如果 MPS 变量标记为 1，则同概率区间下的 LPS 变量的值只能为 0。同时，已知出 0 概率为 <span class="text-blue-math">\(p0\)</span>，则出 1 的概率就是
                    <span class="text-blue-math">\(1-p0\)</span>，这样只需要推演 LPS 一个变量的上下文就足以推演 MPS+LPS 概率区间的分布了，这样做的速度和算法都比上述的 PPM 精简很多。
                </p>
                <p>视频编码器中，MPS 和 LPS 的分布由人工筛选，所以具体逻辑要看编码器源码。x264 中大体为输入 LPS 为 0/为 1 时的状态切换：若大于 0.5 则变成 MPS，LPS 最小为 0.01875；MPS 最大为
                    0.98125</p>
                <div class="align-items-center">
                    <img loading="lazy" src="files/entropy-coding/Finite-State-Machine-Context-Adaptation.png" alt="image46" class="img-medium">
                </div>
            </div>

            <h3>（低精度）二进制算数编码 Binary Arithmetic Coding BAC</h3>
            <p>在（有限状态机推演法）上述的 MPS，LPS 变量简化概率统计的基础上降低精度到 ½ 的幂（如 8 则在 0~1 区间精确到 1/256 个过渡）以在允许的概率统计偏差（可接受 5% 左右）进一步优化性能，再加一步将像素值转二进制的编码，设以便统计过程中交换值，而算数编码的部分不变，就实现了二进制的算数编码。</p>

            <h3>几何分布/等差等比分布类 Geometric distribution</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>条件过程不变，各个尝试独立，只有阴阳两结果的<a href="https://zh.wikipedia.org/zh-hans/%E4%BC%AF%E5%8A%AA%E5%88%A9%E8%A9%A6%E9%A9%97">伯努利试验</a>中统计 n 遍成功的概率分布所形成的概率变化曲线，为：<span class="text-blue-math">\[ P(X=x) = (1-p)^{x-1} p \]</span>其中概率 <span class="text-blue-math">\(1-p\)</span> 盖失败，<span class="text-blue-math">\(p\)</span> 盖成功。如：</p>
                <ol>
                    <li>尝试 3 次后得阳结果记作"阴，阴，阳"。<span class="text-blue-math">\(P(X=3)=(1-p)(1-p)(p)=(1-p)^{3-1} p\)</span></li>
                    <li>成功概率为 90% 则记做 <span class="text-blue-math">\( P(X=x) = (1-0.9)^{x-1} (0.9) \)</span>，且成功概率与尝试次数独立</li>
                    <li>所谓「重试 3 次后过关」是可能脱离实际的期望值 eXpectation，记做大写 X：<span class="text-blue-math">\( X(x) = \frac{1}{p} \)</span></li>
                </ol>
                <ul>
                    <li>小概率对时，一遍对的概率被其它次数分走，而反过来大概率对时，一遍对的概率会夺走其它次数的概率</li>
                    <li>因为尝试次数间的差距皆为整数 1（如不存在 0.3 次尝试）所以等差</li>
                    <li>因为尝试次数每次都乘进同个 <span class="text-blue-math">\(1-p\)</span> 比率，所以等比</li>
                    <li>综上所述（计算过程含多次 <span class="text-blue-math">\(1-p\)</span> 相乘）二维坐标系中可见概率的指数递减下降变化，得名几何分布</li>
                </ul>
            </div>

            <h3>小数取整法，进位法以及取模</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <table class="align-items-center table-center">
                    <thead>
                    <tr>
                        <th class="px-1">名称</th>
                        <th class="px-1">所谓</th>
                        <th class="px-1">运算</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="t-light-gray">
                        <td class="px-1">round</td>
                        <td class="px-1">舍入</td>
                        <td class="px-1">四舍五入</td>
                    </tr>
                    <tr>
                        <td class="px-1">celling <span class="text-blue-math">\( \lceil x \rceil \)</span></td>
                        <td class="px-1">取上</td>
                        <td class="px-1">进位法</td>
                    </tr>
                    <tr class="t-light-gray">
                        <td class="px-1">floor <span class="text-blue-math">\( \lfloor x \rfloor \)</span></td>
                        <td class="px-1">取下</td>
                        <td class="px-1">去尾法</td>
                    </tr>
                    <tr>
                        <td class="px-1">modulus</td>
                        <td class="px-1">取模</td>
                        <td class="px-1">余数乘以除数</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <h3>转二进制——伪哥伦布编码（原理解析）</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>十进制的 3 会转为浪费码率的二进制 8bit 00000011 而非 11，因为前后都挨着其它的数而不能删。解决方法是清点有效的位数，11 共有两位数，因此设置两位数的标记 00 作为 11 的前缀，就得到了相对可靠的 <span class="text-blue-math">\( (a=00,b=11) \)</span>。解码器检测到变量 a 和 b，算出无效位有<span class="text-blue-math">\( 8-2 \)</span>个，于是输出 000000，在输出 11，完成还原。</p>
            </div>

            <h3>转二进制——一元码 Unary，截短二进制码 Truncated Binary</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>一元码如 2，3 即<span class="text-blue-math">110</span>，<span class="text-blue-math">1110</span>或<span class="text-blue-math">001</span>，<span class="text-blue-math">0001</span>，末尾分隔后续数，差在吃带宽。截短二进制如 8bit 的十进制 5 是二进制<span class="text-blue-math">00000101</span>。所以能截短到<span class="text-blue-math">101</span>，但问题是多个数字放一起就难以解码。</p>
            </div>

            <h3>转二进制——哥伦布 (-莱斯) 编码 Golomb(-Rice) Coding</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>将正整数转二进制并压缩。以输入 N，十进制缩放值 M 与刻度 Κ，一元码，截短二进制实现。（-莱斯）码在此基础上限制 M 仅为 2 的幂，对计算机更友好。此处例 M=4，输入 N=9：</p>
                <ol>
                    <li>㏒<sub>2</sub>缩放的刻度 K：<span class="text-blue-math">Kλίμακα \( = \lceil \log_{2} M \rceil \)</span>，如 <span class="text-blue-math">\(\log_{2}{4}=2\)</span>，ceil 约 2
                        <ul class="text-gray-side">
                            <li>注：译作刻度 klimaka，但 k 实际是公认随便写的刻度变量</li>
                        </ul>
                    </li>
                    <li>求商去尾，转一元码：<span class="text-blue-math">\(Quotient = \text{Unary} \left\lfloor \frac{N}{M} \right\rfloor\)</span>，如 <span class="text-blue-math">\(9 \div 4 = 2.25\)</span>，floor 约 2，换一元码 110</li>
                    <li>求余数模，判断区间：<span class="text-blue-math">\(\text{Remainder} = N \ \% \ M\)</span>，如 <span class="text-blue-math">\(9 \% 4 = 9 - (\lfloor9 \div 4 \rfloor \times 4) = 1\)</span></li>
                    <li>余数模是否小于刻度：<span class="text-blue-math">\(0 \leq R &lt; (2^K - M) ? \)</span>，如 <span class="text-blue-math">\(0\leq 1 &lt; (2^2 - 4)\)</span> 结果否定，因为 <span class="text-blue-math">\(2^2 - 4 = 0\)</span>
                    <span class="text-blue-math text-smaller">\[R\prime = \begin{cases} 
                    \text{turnc}(R) \text{ in } (K-1) \text{ bits,} & 0 \leq R &lt; (2^K-M) \\
                    \text{turnc}(R+2^K-M) \text{ in } K \text{ bits,} & R \geq (2^K-M)
                    \end{cases} \]</span>
                        <ol class="text-gray-side">
                            <li>小于刻度则用 K-1 个 bit 的长度编码：<span class="text-blue-math">\(R\prime = trunc(R) \text{ in } (K-1) \text{ bits}\)</span></li>
                            <li>大于等于则用 K 个 bit 的长度编码：<span class="text-blue-math">\(R\prime = \text{turnc}(R + 2^K - M) \text{ in Kbits}\)</span></li>
                            <li>简单说，判断输入 N 是否位于「二进制前半」，如 2bit 下，00，01，10，11 的前半 00，01 可省去首位 0</li>
                        </ol>
                    </li>
                </ol>
                <div class="align-items-center">
                    <img loading="lazy" src="files/entropy-coding/Golomb-Rice-Coding-Variations.png" alt="image47" class="img-medium">
                    <p class="text-gray-side">图：M=1~32 时，<span class="text-blue-math">\(2^K - M\)</span> 的边界变化，见<a href="https://www.desmos.com/calculator/2gonwxfc1m">Desmos 例</a></p>
                </div>
            </div>

            <h3>转二进制——零阶指数哥伦布编码 Exponential Golomb k0</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>十进制数添一位则量增十倍，如 1，10，100 按×10 倍增；二进制数添一位则量增二倍，如 001，010，100 照×2 倍增。可见「刻度本是指数」，二进制刻度 K 的间距设为指数增加的<span class="text-blue-math">0,1,3,7,15…</span>或<span class="text-blue-math">0,1,11,111,1111…</span>，每度从底<span class="text-blue-math">\(2^{(M-1)}\)</span>延伸至顶<span class="text-blue-math">\(2^{(M+1)}-1\)</span>。刻度 Kλίμακα 设为对齐小的边界：</p>
                <ol>
                    <li>设定要编码的 N 并获取其二进制值 +1 为刻度后端。如输入 N=6，则二进制 N = 110</li>
                    <li>求二进制刻度 K'：<span class="text-blue-math">\(K\prime = \left\lfloor \log_2 (N+1) \right\rfloor\)</span>。如输入 N=6，则 <span class="text-blue-math">\(\log_{2} (6+1) = 2.81...\)</span>，floor 约 2</li>
                    <li>求刻度内偏移值：<span class="text-blue-math">\(Offset = N + 1 - 2^{K\prime}\)</span>，如输入 N=6，则<span class="text-blue-math">\(6+1-2^2=3\)</span>，代表在刻度 6 处偏移 3 下
                        <ol class="text-gray-side">
                            <li class="text-xs">输入 N=0~31 时，十进制 K'=[0,<span class="text-red-emph">1,1,</span><span class="text-blue-emph">2,2,2,2,</span><span class="text-purple-resv">3,3,3,3,3,3,3,3,</span>4,4,4,4,4,4,4,4,4,4, 4, 4, 4, 4, 4, 4]</li>
                            <li class="text-xs">输入 N=0~31 时，十进制 O =[0,<span class="text-red-emph">0,1,</span><span class="text-blue-emph">0,1,2,3,</span><span class="text-purple-resv">0,1,2,3,4,5,6,7,</span>0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]</li>
                            <li>注：O 就是单纯随 K'指数增加而累计偏移量</li>
                        </ol>
                    </li>
                    <li>K' 值转换为 0 的数量，设为前端 1。如输入 N=6，则 K'=2，则写作 00</li>
                    <li>R 值转换二进制为前端 2。前端 1+ 后端 <span class="text-blue-math">\(\text{concat}(Offset_1,K\prime)\)</span> 是常见的零阶指数哥伦布码</li>
                    <li>前端 2+ 后端 <span class="text-blue-math">\(\text{concat}(Offset_2,K\prime)\)</span></li>
                </ol>
                <p class="text-gray-side">注：此处因篇幅，难度和不相关而省略一阶及更高阶的哥伦布码</p>
                
                <table class="align-items-center table-center">
                    <thead>
                        <tr>
                            <th class="px-1">N</th>
                            <th class="px-1">K'</th>
                            <th class="px-1">R</th>
                            <th class="px-1">前端 1</th>
                            <th class="px-1">后端</th>
                            <th class="px-1">前端 2</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr  class="t-light-gray">
                            <td class="px-1">0</td>
                            <td class="px-1">0</td>
                            <td class="px-1">0</td>
                            <td class="px-1"> </td>
                            <td class="px-1">1</td>
                            <td class="px-1">0</td>
                        </tr>
                        <tr>
                            <td class="px-1">1</td>
                            <td class="px-1">1</td>
                            <td class="px-1">0</td>
                            <td class="px-1">0</td>
                            <td class="px-1">10</td>
                            <td class="px-1">0</td>
                        </tr>
                        <tr class="t-light-gray">
                            <td class="px-1">2</td>
                            <td class="px-1">1</td>
                            <td class="px-1">1</td>
                            <td class="px-1">0</td>
                            <td class="px-1">11</td>
                            <td class="px-1">1</td>
                        </tr>
                        <tr>
                            <td class="px-1">3</td>
                            <td class="px-1">2</td>
                            <td class="px-1">0</td>
                            <td class="px-1">00</td>
                            <td class="px-1">100</td>
                            <td class="px-1">00</td>
                        </tr>
                        <tr class="t-light-gray">
                            <td class="px-1">4</td>
                            <td class="px-1">2</td>
                            <td class="px-1">1</td>
                            <td class="px-1">00</td>
                            <td class="px-1">101</td>
                            <td class="px-1">01</td>
                        </tr>
                        <tr>
                            <td class="px-1">5</td>
                            <td class="px-1">2</td>
                            <td class="px-1">2</td>
                            <td class="px-1">00</td>
                            <td class="px-1">110</td>
                            <td class="px-1">10</td>
                        </tr>
                        <tr class="t-light-gray">
                            <td class="px-1">6</td>
                            <td class="px-1">2</td>
                            <td class="px-1">3</td>
                            <td class="px-1">00</td>
                            <td class="px-1">111</td>
                            <td class="px-1">11</td>
                        </tr>
                        <tr>
                            <td class="px-1">7</td>
                            <td class="px-1">3</td>
                            <td class="px-1">0</td>
                            <td class="px-1">000</td>
                            <td class="px-1">1000</td>
                            <td class="px-3">000</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h2 id="h2-16">优化熵编码</h2>
            <h3>汉明距离与欧几里得距离</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>前者在不考虑大小的情况下测量数字信号的差距，如<span class="text-blue-math">100</span>与<span class="text-blue-math">010</span>的汉明距离为 2，数值误差为 90，很明显信号偏差的程度并不如数值误差所说的那么离谱。汉明距离以累计各位数的异或门 ⊻ 得到，“累计”代表误差和 SAD。</p>
                <p>欧几里得距离测量更高维度下，至少两点分别取值的平方差（SSE），如 GPS 的定位误差</p>
                <div class="align-items-center">
                    <img loading="lazy" src="files/entropy-coding/Euclidean-distance.svg" alt="image48" class="img-medium">
                    <p class="text-gray-side">图：欧几里得距离利用平方差的算法，见<a href="https://en.wikipedia.org/wiki/Euclidean_distance">维基百科</a></p>
                </div>
                <h3>软判决与硬判决解码 Soft/Hard Decision decoding</h3>
                <p>尝试解决以下问题的两种方法，其中软判决最优：</p>
                <ol>
                    <li>假设二进制 0 为<span class="text-blue-math">0.33V</span>，1 为<span class="text-blue-math">0.67V</span>；再定义编解码格式的有效字为<span class="text-blue-math">[001,010,100,101,111]</span></li>
                    <li>传输码字<span class="text-blue-math">001</span>，电压为<span class="text-blue-math">0.33,0.33,0.67V</span></li>
                    <li>结果，解码器得到偏移的<span class="text-blue-math">0.35V,0.55V,0.75V</span></li>
                </ol>
                <p>硬判决：设置大于<span class="text-blue-math">0.4V</span>则 1；小于<span class="text-blue-math">0.5V</span>则 0。得<span class="text-blue-math">0,1,1</span>。比对有效字，汉明距离为<span class="text-blue-math">[1,1,3,2,1]</span>，共 3 个误差最小的可能</p>
                <p class="overflow-auto">软判决：比对电压间的平方差，如同样的偏移值，对比<span class="text-blue-math">001</span>算：<span class="text-blue-math">\[\left(0.33-0.35\right)^2 + \left(0.35-0.55\right)^2 + \left(0.67-0.75\right)^2 = 0.0468\]</span></p>
                <p>对比<span class="text-blue-math">[010，100，…]</span>分别得欧几里得距离为<span class="text-blue-math">[0.1912,0.3272,0.1572,…]</span>等远大于<span class="text-blue-math">0.0468</span>的误差，就在条件不变的情况下更准确的解码了信息。</p>
            </div>

            <h3>游程/游标编码 Run-length/run-level coding</h3>
            <div class="align-items-center">
                <img loading="lazy" src="files/entropy-coding/Run-Length-Coding.png" alt="image49" class="img-medium">
            </div>

            <h2 id="h2-17">补充优化信息 Supplemental enhance info（SEI）</h2>
            <p>记录每帧的播放补充信息。涵盖正确解码新 GOP 用的缓冲区设定、解码时间戳校正设定，让显示主控切边、CC 字幕、HDR 信息等等。由于解码器对 SEI 读取和适应的能力参差不齐，因此请勿高估它的可靠性，而是应该让视频数据本身变得通用。</p>

            <code class="code-bold">--film-grain</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;文件名&gt;将纹理细节模型 Film grain model 录入 SEI 中，将编码压缩掉的细节另存档，兼容解码器播放时恢复的功能。HEVC 解码器对此功能的兼容性未知，但 AV1 标准中集成了编码端的分离和解码端的重建，测试发现视频源的噪点越重，压缩越强，只有使用算法对比才能看出来噪点结构性变化导致的巨大画面差异（失真），即利用“噪点的画质不重要”这一点提高压缩。</p>
            <p>支持 <a href="https://bitbucket.org/multicoreware/libfgm">libfgm</a> 提取的噪声。AV1 编码器提取的噪声模型可能属于同类，但未经测试，兼容性不确定。</p>

            <code class="code-bold">--hash</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~3，默认 0/关，推荐关&gt;于 SEI 中添加每帧的效验码，在人工修复视频时帮助识别哪些帧需要修复。由于校验本身会消耗算力，解码器就算知道也做不了什么，并且会一定程度上增加文件体积，因此不推荐：</p>
            <ul class="font-monospace pl-5 list-dotless text-smaller">
                <li><span class="text-blue-emph">1</span>：checksum 校验，性能占用最小</li>
                <li><span class="text-blue-emph">2</span>：CRC 校验，性能占用略高，准确率较高</li>
                <li><span class="text-blue-emph">3</span>：CRC 校验，性能占用略高，准确率高</li>
            </ul>
            <code class="code-bold">--single-sei</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，推荐关&gt;只写一个装全部 SEI 信息的大 NALU 而非每 GOP 都写，提高一点点压缩率，降低兼容性。</p>
            <code class="code-bold">--hrd</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，<span class="text-red-emph">需开 vbv</span>&gt;将假设对照解码参数 Hypothetical Reference Decoder Parameter 估计不丢包无延迟的瞬间码率，写在每段 SPS、SEI 里，对专门配置了网络串流，NAS 播放自动缓冲的播放器有好处。</p>
            <code class="code-bold">--idr-recovery-sei</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;SEI 写进 idr 帧，串流时防止整个 GOP 都找不到参考帧的机制。</p>
            <code class="code-bold">--frame-dup</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，需<span class="text-red-emph">开 vbv 和 hrd，有 bug</span>&gt;直接将 2~3 面极近似的连续帧换成同一帧并用 SEI 告知，理论上能在动漫和电脑录屏画面提高压缩率，但会降低兼容性。</p>
            <code class="code-bold">--dup-threshold</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 1~99，默认 70&gt;相似度判定值，默认达 70% 重复就判为相似。</p>

            <h2 id="h2-18">线程与节点控制</h2>
            <code class="code-bold">--asm</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;字符串或整数，默认除 avx512 以外全开&gt;通过指定以下列表中特定位置的指令集名称或序号，从而禁用比它新的指令集，从而支持老旧处理器。此外，可以手动指定 <code>avx512</code>，但仅 ZEN4、Arrow Lake 及更新架构的处理器正常支持，其它处理器有的完全不支持，有的假装支持。</p>

            <h3>大缓存处理器是否有优势</h3>
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容</button>
            <div class="coll-content">
                <p>见 <a href="https://www.pugetsystems.com/labs/articles/amd-ryzen-5800x3d-vs-5800x-for-content-creation-2331/">PugetSystems 跑分</a>：</p>
                <ul>
                    <li>Cinebench 与 Unreal Engine 5 跑分上，Ryzen 7 5800X 比 Ryzen 7 5800X3D 快了近 10%，原因是 X3D 缓存限制了处理器的散热，因此频率变低，算力降低了</li>
                    <li>Lightrooms 等单图处理上 Ryzen 7 5800X3D 跑分超过了 Ryzen 7 5800X，因为滤镜所占的缓存较高，普通处理器的算力受到缓存限制而发挥不出来</li>
                    <li>Photoshop 2022，After Effects，Premiere Pro，DaVinci 上 Ryzen 9 5900 X，Ryzen 7 5800X3D，Ryzen 7 5800X 持平，可能是内存瓶颈或优化不足导致</li>
                    <li>然而以上大部分测试中真正领先的是 i9 12900K（S），除了 Unreal Engine 5 和 V-Ray 中 Ryzen 7 5950X 领先一次，因为大小核架构提升了多核性能</li>
                </ul>
                <p>由此可见，持续地高负载下算力比较重要，间接高负载下缓存内存比较重要，同时还要带宽足够大的内存，优化到位的软件和系统才能将性能发挥出来。压制大部分情况下是需要多核性能的持续高负载，因此 X3D 处理器没有优势。尽管这种高负载可能只占很少的使用场景（如大部分时间作游戏机使用）</p>
            </div>

            <h3>多节点/多路主机</h3>
            <p>如电脑连接超过一台打印机，超过一个网卡（如有线 + 无线）就称为多节点部署。此处特指 CPU 节点——同主板上超过一颗处理器以及其对应内存的系统环境。这种环境的缺点是节点 0 的处理器访问节点 1 的内存的延迟很大，所以一般通过虚拟机，或专门优化的程序来限制软件只占用一个节点的 CPU 核心。</p>

            <code class="code-bold">--pools</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数/加减符“,,,”，默认*（占用任意节点电脑的全部线程）&gt;x264 中--threads 的升级版。+代表全部处理器线程，-代表不使用处理器，数字代表占用多少个线程：</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>例如<span class="text-blue-emph">pools +,-,-,-</span>表明电脑有 4 个 CPU 节点，使用首个节点</li>
                <li>设为<span class="text-blue-emph">pools none</span>时关闭</li>
                <li>单节点系统无需关心，或设置如<span class="text-blue-emph">pools 8</span>占用处理器的 8 个线程</li>
                <li>若--wpp，--pmode，--pme，--lookahead-slices 全关，则--pools 参数无效</li>
                <li>若指定--pools none，则--wpp，--pmode，--pme，--lookahead-slices 无效</li>
            </ul>

            <h3>线程池 Threadpool</h3>
            <p>同网络下整台电脑的所有可用线程，或此处所有节点 CPU 线程的数量。若 x265 占用超过 64 个线程（32bit 系统下为 32 个），则这些线程本身还可以细分出最多 64 个子线程（32bit 系统下为 32 个）。子线程池的大小和 pool 参数设置出的大小一致，但因为性能和系统兼容性的限制，子线程可能会比预期少。</p>

            <h3>工作者线程/分工线程-Worker thread</h3>
            <p>一种多线程优化，能部分解决跨节点运行性能问题——主程序分出一个活跃的分工线程持续重复执行任务，如监听端口 8080，监听信息的后台进程；或者是 x265 外包任务给其它核心或节点上的 pme/pmode Worker thread，使 x265 可以略好的跨节点运行。</p>

            <code class="code-bold">--pmode</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，<span class="text-red-emph">需 pools</span>&gt;创建平行模式决策 Parallel Mode Decision 的 Worker thread 以更改 pools 参数功能。推荐先于 pme 打开，推荐搭配 rd 3 + rect，而 rd 5 时可以先确认占用率未跑满再打开。</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>如<span class="text-blue-emph">--pme --pmode</span>表明使用整个线程池，分配平行动态搜索，平行模式决策以更好地增加多线程节点占用。</li>
                <li>模式决策独立线程化会使本可提前退出的策略因信息孤立而不可跳过，使理论率失真最优推理更准（无损压缩略微提升）</li>
            </ul>
            <code class="code-bold">--pme</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关，<span class="text-red-emph">需 pools</span>&gt;创建平行动态搜索 Parallel Motion Estimation 的 Worker thread 以更改 pools 参数功能（不影响输出文件）。</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>如<span class="text-blue-emph">--pme</span>表明使用整个线程池，并分配平行动态搜索的分工线程</li>
                <li>开 pme 时，遇到性能（比仅一个节点）更差状况的可能性不低</li>
            </ul>

            <h3>多线程 vs 多参考（frame-thread）</h3>
            <p>用多线程一次编码多帧来占满算力 vs 一次只编一帧，确保所有参考画面可用（大幅提高多核占用，画质和文件影响小）的决策。造成多线多参考帧困难的原因有：</p>
            <ul class="text-gray-side">
                <li>CTU 的面积比宏块大，其中画面变化的概率增加</li>
                <li>参考前等待环路滤镜、率失真优化以及已编码信息的依赖，使得很多参考（特别是高参考帧长度 <code>--ref</code>）来不及查找而被跳过</li>
            </ul>
            <p>因此有了“每帧线程”的并行编码帧数量分配概念。关--wpp 时，frame-thread 参数设为<span class="text-blue-math">\(\min(\text{cpuCount},\frac{\text{ctuRows}}{2})\)</span>，开则为下表：</p>
            <table class="table-center align-items-center">
                <thead>
                    <tr>
                        <th class="px-3">Cores</th>
                        <th class="px-3">Frames</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="t-light-gray">
                        <td class="px-3">&gt;32</td>
                        <td class="px-3">6..8</td>
                    </tr>
                    <tr>
                        <td class="px-3">&gt;= 16</td>
                        <td class="px-3">5</td>
                    </tr>
                    <tr class="t-light-gray">
                        <td class="px-3">&gt;= 8</td>
                        <td class="px-3">3</td>
                    </tr>
                    <tr>
                        <td class="px-3">&gt;= 4</td>
                        <td class="px-3">2</td>
                    </tr>
                </tbody>
            </table>

            <code class="code-bold">--frame-threads</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~线程数÷2，默认 0 自动，推荐默认&gt;同时压制多少帧：</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li><span class="text-blue-emph">1</span>：让编码器做到前后整帧可完全分析参考，但代价是 CPU 占用受限、压制速度大减。提升存在，但只有望进度条止渴（placebo）的程度。<del>因此建议搭配 mcstf 使用</del>（mcstf 可能会遇到残影画面问题，取消推荐）</li>
            </ul>

            <h2 id="h2-19">色彩空间标注，VUI/HDR 信息，黑边跳过</h2>
            <p>Video usability information 是元数据，播放器会读取这些元数据来选择特定的色彩空间播放视频，由于 HDR 视频的标准受到厂商竞争割据等因素，用户需要手动指定 HDR 参数到 VUI 中才能正确播放（不过，有时电视厂商会为了节省成本而只读取一小部分信息，如只读取 MaxCLL 和 MaxFall）。</p>
            <p>光强/光压 Candela 等于尼特，即<span class="text-blue-math">\(1 \text{cd} = 1 \text{nit}\)</span>。因 bt601，709，HDR-PQ，HLG 标准重视的亮度范围，曲线所异（偏亮或偏暗），故需要量化曲线，心理学优化，模式决策的重适配。</p>
            
            <button type="button" class="collapsible border-main rounded-3 mt-3">点击展开/折叠内容：色彩格式的具体转换变量与算法标准</button>
            <p>详见国际电信联盟（ITU-T）<a href="https://www.itu.int/rec/dologin.asp?lang=s&id=T-REC-H.265-201504-S!!MSW-E">H.265 Table E.3</a>。</p>
            <div class="coll-content">
                <table class="table-center text-smaller">
                    <thead class="thead-no-border">
                        <tr class="t-invert-dark">
                            <th class="px-1">值</th>
                            <th class="px-1">原色系</th>
                            <th class="px-1"></th>
                            <th class="px-1"></th>
                            <th class="px-1">注解</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light">0</td>
                            <td class="px-1">保留值 Reserved</td>
                            <td class="px-1 t-light-gray"> </td>
                            <td class="px-1 t-light-gray"> </td>
                            <td class="px-1">国际电信联盟——电信标准化部门（ITU‑T） | ISO/IEC 占位留以后用</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light">1</td>
                            <td class="px-1">原色 primary</td>
                            <td class="px-1 t-light-gray">x</td>
                            <td class="px-1 t-light-gray">y</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.709-5</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">绿</td>
                            <td class="px-1 t-light-gray">0.3</td>
                            <td class="px-1 t-light-gray">0.6</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.1361 常规色域系统，扩展色域系统</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">蓝</td>
                            <td class="px-1 t-light-gray">0.15</td>
                            <td class="px-1 t-light-gray">0.06</td>
                            <td class="px-1">国际电工委员会（IEC）61966-2-1（sRGB 或 sYCC）</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">红</td>
                            <td class="px-1 t-light-gray">0.64</td>
                            <td class="px-1 t-light-gray">0.33</td>
                            <td class="px-1">国际电工委员会（IEC）61966-2-4</td>
                        </tr>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">白点 D65</td>
                            <td class="px-1 t-light-gray">0.313</td>
                            <td class="px-1 t-light-gray">0.329</td>
                            <td class="px-1">电影电视工程师协会（SMPTE）RP 177（1993）——Annex B</td>
                        </tr>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light">2</td>
                            <td class="px-1">未标注 Unspec</td>
                            <td class="px-1 t-light-gray"> </td>
                            <td class="px-1 t-light-gray"> </td>
                            <td class="px-1">特征未标注，或设为由应用程序确定</td>
                        </tr>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light">3</td>
                            <td class="px-1">保留值 Reserved</td>
                            <td class="px-1 t-light-gray"> </td>
                            <td class="px-1 t-light-gray"> </td>
                            <td class="px-1">国际电信联盟——电信标准化部门（ITU‑T） | ISO/IEC 占位留以后用</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light">4</td>
                            <td class="px-1">原色 primary</td>
                            <td class="px-1 t-light-gray">x</td>
                            <td class="px-1 t-light-gray">y</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.470‑6 System M（历史遗留）</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">绿</td>
                            <td class="px-1 t-light-gray">0.21</td>
                            <td class="px-1 t-light-gray">0.71</td>
                            <td class="px-1">美国国家电视系统委员会（1953），彩色电视传输标准建议</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">蓝</td>
                            <td class="px-1 t-light-gray">0.14</td>
                            <td class="px-1 t-light-gray">0.08</td>
                            <td class="px-1">美国联邦通信委员会（2003），美国联邦法规 47 章 73.682</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">红</td>
                            <td class="px-1 t-light-gray">0.67</td>
                            <td class="px-1 t-light-gray">0.33</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">白点 C</td>
                            <td class="px-1 t-light-gray">0.31</td>
                            <td class="px-1 t-light-gray">0.316</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light">5</td>
                            <td class="px-1">原色 primary</td>
                            <td class="px-1 t-light-gray">x</td>
                            <td class="px-1 t-light-gray">y</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.470‑6 System B，G（历史遗留）</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">绿</td>
                            <td class="px-1 t-light-gray">0.29</td>
                            <td class="px-1 t-light-gray">0.6</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.601‑6 625</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">蓝</td>
                            <td class="px-1 t-light-gray">0.15</td>
                            <td class="px-1 t-light-gray">0.06</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.1358 625</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">红</td>
                            <td class="px-1 t-light-gray">0.64</td>
                            <td class="px-1 t-light-gray">0.33</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.1700 625 PAL，625 SECAM</td>
                        </tr>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">白点 D65</td>
                            <td class="px-1 t-light-gray">0.313</td>
                            <td class="px-1 t-light-gray">0.329</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light">6</td>
                            <td class="px-1">原色 primary</td>
                            <td class="px-1 t-light-gray">x</td>
                            <td class="px-1 t-light-gray">y</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.601‑6 525</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">绿</td>
                            <td class="px-1 t-light-gray">0.31</td>
                            <td class="px-1 t-light-gray">0.595</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.1358 525</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">蓝</td>
                            <td class="px-1 t-light-gray">0.155</td>
                            <td class="px-1 t-light-gray">0.07</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.1700 NTSC</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">红</td>
                            <td class="px-1 t-light-gray">0.63</td>
                            <td class="px-1 t-light-gray">0.34</td>
                            <td class="px-1">电影电视工程师协会（SMPTE）170M（2004）</td>
                        </tr>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">白点 D65</td>
                            <td class="px-1 t-light-gray">0.313</td>
                            <td class="px-1 t-light-gray">0.329</td>
                            <td class="px-1">（功能与值 7 所同）</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light">7</td>
                            <td class="px-1">原色 primary</td>
                            <td class="px-1 t-light-gray">x</td>
                            <td class="px-1 t-light-gray">y</td>
                            <td class="px-1">电影电视工程师协会（SMPTE）240M（1999）</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">绿</td>
                            <td class="px-1 t-light-gray">0.31</td>
                            <td class="px-1 t-light-gray">0.595</td>
                            <td class="px-1">（功能与值 6 所同）</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">蓝</td>
                            <td class="px-1 t-light-gray">0.155</td>
                            <td class="px-1 t-light-gray">0.07</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">红</td>
                            <td class="px-1 t-light-gray">0.63</td>
                            <td class="px-1 t-light-gray">0.34</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">白点 D65</td>
                            <td class="px-1 t-light-gray">0.313</td>
                            <td class="px-1 t-light-gray">0.329</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light">8</td>
                            <td class="px-1">原色 primary</td>
                            <td class="px-1 t-light-gray">x</td>
                            <td class="px-1 t-light-gray">y</td>
                            <td class="px-1">普通胶片电影（国际照明委员会 CIE 光源 C 滤镜）</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">绿（Wratten 58）</td>
                            <td class="px-1 t-light-gray">0.243</td>
                            <td class="px-1 t-light-gray">0.692</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">蓝（Wratten 47）</td>
                            <td class="px-1 t-light-gray">0.145</td>
                            <td class="px-1 t-light-gray">0.049</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">红（Wratten 25）</td>
                            <td class="px-1 t-light-gray">0.681</td>
                            <td class="px-1 t-light-gray">0.319</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">白点 C</td>
                            <td class="px-1 t-light-gray">0.31</td>
                            <td class="px-1 t-light-gray">0.316</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light">9</td>
                            <td class="px-1">原色 primary</td>
                            <td class="px-1 t-light-gray">x</td>
                            <td class="px-1 t-light-gray">y</td>
                            <td class="px-1">国际电信联盟——无线电通信部门（ITU‑R）BT.2020</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">绿</td>
                            <td class="px-1 t-light-gray">0.71</td>
                            <td class="px-1 t-light-gray">0.797</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">蓝</td>
                            <td class="px-1 t-light-gray">0.131</td>
                            <td class="px-1 t-light-gray">0.046</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">红</td>
                            <td class="px-1 t-light-gray">0.708</td>
                            <td class="px-1 t-light-gray">0.292</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">白点 D65</td>
                            <td class="px-1 t-light-gray">0.313</td>
                            <td class="px-1 t-light-gray">0.329</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light">10</td>
                            <td class="px-1">原色 primary</td>
                            <td class="px-1 t-light-gray">x</td>
                            <td class="px-1 t-light-gray">y</td>
                            <td class="px-1">电影电视工程师协会（SMPTE）ST 428-1</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">Y</td>
                            <td class="px-1 t-light-gray">0</td>
                            <td class="px-1 t-light-gray">1</td>
                            <td class="px-1">（国际照明委员会 CIE 1931 XYZ）</td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">Z</td>
                            <td class="px-1 t-light-gray">0</td>
                            <td class="px-1 t-light-gray">0</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">X</td>
                            <td class="px-1 t-light-gray">1</td>
                            <td class="px-1 t-light-gray">0</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr class="border-bottom">
                            <td class="px-1 t-invert-light"> </td>
                            <td class="px-1">中心白点 centre white</td>
                            <td class="px-1 t-light-gray">1÷3</td>
                            <td class="px-1 t-light-gray">1÷3</td>
                            <td class="px-1"> </td>
                        </tr>
                        <tr>
                            <td class="px-1 t-invert-light">11~<br>255</td>
                            <td class="px-1">保留值 Reserved</td>
                            <td class="px-1 t-light-gray"> </td>
                            <td class="px-1 t-light-gray"> </td>
                            <td class="px-1">国际电信联盟——电信标准化部门（ITU‑T） | ISO/IEC 占位留以后用</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>VUI 元数据</h3>

            <h4>缺失元数据补充</h4>
            <p>输入不带分辨率、帧率、位深等元数据的流、使用 RAW 管道而非 YUV for MPEG（y4m）管道时需要进行补充设置：</p>
            <code class="code-bold">--input-csp</code>--input
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;i400/i422/i444/nv12/nv16，默认 i420&gt;视频源的色彩空间，即 YUV 4:0:0、4:2:2、4:4:4、nv12、nv16。</p>
            <p class="text-gray-side">注；rgb，yuvj 等不支持需要滤镜转换。</p>
            <code class="code-bold">--input-res</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;字符串（宽x高）&gt;视频源的分辨率，如 1920x1080。</p>
            <code class="code-bold">--fps</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数/浮点/分数&gt;视频源的帧率，如 30，24000/1001 等。</p>

            <h4>非常规播放条件指定</h4>
            <code class="code-bold">--range</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;full/limited，默认留空&gt;指定视频源的色深范围，full：完整，limited：有限。剪辑时应额外检查剪辑软件的输出设定一致性。</p>
            <code class="code-bold">--chromaloc</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~5，默认留空&gt;指定色度采样缩减分辨率时所用的像素，相对于缩小前像素的位置（chroma location），涉及到解码端的色度像素对齐。如果源视频标注，则建议标注。</p>
            <ul class="list-dotless font-monospace pl-5 list-dotless text-smaller">
                <li><b>0：</b>左</li>
                <li><b>1：</b>中</li>
                <li><b>2：</b>左上</li>
                <li><b>3：</b>上</li>
                <li><b>4：</b>左下</li>
                <li><b>5：</b>下</li>
            </ul>
            <div class="align-items-center">
                <img loading="lazy" src="files/video-usability-information/Chroma-Location-Type.png" alt="image51" class="img-medium" >
                <p class="text-gray-side">图：色度采样位置</p>
            </div>
            <code class="code-bold">--colorprim</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;字符&gt;播放用三原色 (以及白点) 指标，查看视频信息可知：bt470m，bt470bg，smpte170m，smpte240m，film，bt2020，smpte428，smpte431，smpte432。如图 1 为 bt.2020。</p>
            <code class="code-bold">--colormatrix</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;字符&gt;播放用矩阵格式/系数指标：fcc，bt470bg，smpte170m，smpte240m，GBR，YCgCo，bt2020c，smpte2085，chroma-derived-nc，chroma-derived-c，ICtCp。</p>
            <p class="text-gray-side pl-5 m-0">注：不支持 bt2020nc</p>
            <code class="code-bold">--transfer</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;字符&gt;传输特质：bt470m，bt470bg，smpte170m，smpte240m，linear，log100，log316，iec61966-2-4，bt1361e，iec61966-2-1，bt2020-10，bt2020-12，smpte2084，smpte428，arib-std-b67。</p>
            <p class="text-gray-side pl-5 m-0">上图图 2 的 PQ 即 st.2084 的标准，所以参数值为 smpte2084。</p>
            <code class="code-bold">--display-window</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;←,↑,→,↓&gt;指定黑边宽度，从而跳过加速编码，或者用<code>--overscan crop</code> 裁掉。</p>

            <!-- x264 教程副本，更改需手动同步 { -->
            <h3>高动态范围 High Dynamic Range HDR</h3>
            <p>原本是高端音响的标准，代表最小音量下没有一点电流噪声，最大音量可以和真实场景媲美的性能。与扬声器的大小和材质是否匹配场景相关，即「重硬件轻软件」。因为只要硬件达到 HDR 1000 规格，那么只要调高亮度就可以了；而随便一个中位水平的电视/显示器/手机屏幕亮度都能达到 HDR 400 标准。</p>
            <p>HDR 信息分为硬件、软件、以及数据，共 3 类不统一的标准。为保证色彩正确，压制时应额外检查并确保与视频源的一致性。如：</p>
            <div class="align-items-center">
                <img loading="lazy" src="files/video-usability-information/Metadata-for-VUI-HDR-1.png" alt="image51" class="img-medium" >
                <p class="text-gray-side">图 1：cll 1000,640. master-display 由 G(13250…) 开头，L(10000000,1) 结尾</p>
                <img loading="lazy" src="files/video-usability-information/Metadata-for-VUI-HDR-2.png" alt="image52" class="img-medium">
                <p class="text-gray-side">图 2：cll 1655,117/L(40000000,50)/colorprim bt2020/colormatrix bt2020nc/transfer smpte2084</p>
            </div>
            <code class="code-bold">--master-display</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;G(x,y)B(,)R(,)WP(,)L(,)（绿，蓝，红，白点，光强）&gt;写进 SEI 信息里，告诉解码端色彩空间/色域信息用</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li>HDR 标准设立时还没有 HDR 电视，所以就把 master-display 写成必须参数了，而最重要的信息反而是内容亮度 Content light level（CLL）。</li>
                <li>绿蓝红 GBR 和白点 WP 指马蹄形色域的三角 + 白点 4 个位置的值×50000</li>
                <li>光强 L 的单位是 candela×10000</li>
                <li>SDR 视频的 L 是 1000,1. 压制 HDR 视频前一定要看视频信息再设 L，见上图
                    <ul>
                        <li>DCI-P3：<span class="text-blue-emph">G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(?,1)</span></li>
                        <li>bt709：<span class="text-blue-emph">G(15000,30000)B(7500,3000)R(32000,16500)WP(15635,16450)L(?,1)</span></li>
                        <li>bt2020：<span class="text-blue-emph">G(8500,39850)B(6550,2300)R(35400,14600)WP(15635,16450)L(?,1)</span></li>
                    </ul>
                </li>
                <li>RGB 原信息 (对照小数格式的视频信息，然后选择上面对应的参数):
                    <ul>
                        <li>DCI-P3：<span class="text-blue-emph">G(x0.265,y0.690),B(x0.150,y0.060),R(x0.680,y0.320),WP(x0.3127,y0.329)</span></li>
                        <li>bt709：<span class="text-blue-emph">G(x0.30,y0.60),B(x0.150,y0.060),R(x0.640,y0.330),WP(x0.3127,y0.329)</span></li>
                        <li>bt2020：<span class="text-blue-emph">G(x0.170,y0.797),B(x0.131,y0.046),R(x0.708,y0.292),WP(x0.3127,y0.329)</span></li>
                    </ul>
                </li>
            </ul>
            <code class="code-bold">--max-cll</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;字符串 MaxCLL,MaxFall&gt;根据源视频的元数据设置最大内容光强（Max content light level）与最大平均光强（Max Frame-Avg Light level）。见上图例。</p>
            <!-- } -->

            <h3>杜比视界 Dolby vision / DV</h3>
            <p>一种通过嵌入高频信号层来强化播放效果的私有格式。有单流/DV-MEL 和双流/DV-FEL 两种，两者皆含有参考单元 Reference picture unit RPU。</p>
            <ul class="text-gray-side">
                <li>双视频流代表 Base layer 视频层 BL 和 Enhance layer 强化层 EL</li>
                <li>双视频流下，EL 可被一般的解码器丢弃而正常播放</li>
                <li>单视频流下，使用专利色彩空间（ICtCp）的源应依法使用专利授权的解码器解码</li>
                <li>存在假源和假设备，但没有办法验证</li>
                <li>即使是样式为 7 时，EL 也可以为空，等效于仅 BL</li>
            </ul>
            <table class="table-center text-smaller">
                <thead>
                    <tr class="t-invert-dark">
                        <th class="px-1">样式 Profile</th>
                        <th class="px-1">编码</th>
                        <th class="px-1">流标记</th>
                        <th class="px-1">BL 兼容 ID</th>
                        <th class="px-1">BL:EL 大小比例</th>
                        <th class="px-1">x265 支持</th>
                        <th class="px-1">伽马兼容</th>
                        <th class="px-1">色彩空间</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="t-light-gray border-lr">
                        <th class="px-1">4</th>
                        <td class="px-1">10bit hevc</td>
                        <td class="px-1">dvhe.04</td>
                        <td class="px-1">2</td>
                        <td class="px-1">1:¼</td>
                        <td class="px-1"> </td>
                        <td class="px-1">SDR</td>
                        <td class="px-1">YCbCr</td>
                    </tr>
                    <tr class="border-lr">
                        <th class="px-1">5</th>
                        <td class="px-1">10bit hevc</td>
                        <td class="px-1">dvhe.05</td>
                        <td class="px-1">0</td>
                        <td class="px-1">仅 BL（DV-MEL）</td>
                        <td class="px-1">✓</td>
                        <td class="px-1">无（私有色彩空间）</td>
                        <td class="px-1">ICtCp</td>
                    </tr>
                    <tr class="t-light-gray border-lr">
                        <th class="px-1">7</th>
                        <td class="px-1">10bit hevc</td>
                        <td class="px-1">dvhe.07</td>
                        <td class="px-1">6</td>
                        <td class="px-1">UHD = 1:¼, FullHD = 1:1</td>
                        <td class="px-1"> </td>
                        <td class="px-1">UHD 蓝光</td>
                        <td class="px-1">YCbCr</td>
                    </tr>
                    <tr class="border-lr">
                        <th class="px-1">8.1</th>
                        <td class="px-1">10bit hevc</td>
                        <td class="px-1">dvhe.08</td>
                        <td class="px-1">1</td>
                        <td class="px-1">仅 BL（DV-MEL）</td>
                        <td class="px-1">✓</td>
                        <td class="px-1">HDR10</td>
                        <td class="px-1">YCbCr</td>
                    </tr>
                    <tr class="t-light-gray border-lr">
                        <th class="px-1">8.2</th>
                        <td class="px-1">10bit hevc</td>
                        <td class="px-1">dvhe.08</td>
                        <td class="px-1">2</td>
                        <td class="px-1">仅 BL（DV-MEL）</td>
                        <td class="px-1">✓</td>
                        <td class="px-1">SDR</td>
                        <td class="px-1">YCbCr</td>
                    </tr>
                    <tr class="border-lr">
                        <th class="px-1">8.4</th>
                        <td class="px-1">10bit hevc</td>
                        <td class="px-1">dvhe.08</td>
                        <td class="px-1">4</td>
                        <td class="px-1">仅 BL（DV-MEL）</td>
                        <td class="px-1"> </td>
                        <td class="px-1">HLG</td>
                        <td class="px-1">YCbCr</td>
                    </tr>
                    <tr class="t-light-gray border-lr">
                        <th class="px-1">9</th>
                        <td class="px-1">8bit avc</td>
                        <td class="px-1">dvav.09</td>
                        <td class="px-1">2</td>
                        <td class="px-1">仅 BL（DV-MEL）</td>
                        <td class="px-1"> </td>
                        <td class="px-1">SDR</td>
                        <td class="px-1">YCbCr</td>
                    </tr>
                    <tr class="border-lr">
                        <th class="px-1">10</th>
                        <td class="px-1">10bit av1</td>
                        <td class="px-1">dav1.10</td>
                        <td class="px-1">0,1,2,4</td>
                        <td class="px-1">仅 BL（DV-MEL）</td>
                        <td class="px-1"> </td>
                        <td class="px-1">无/SDR/<br>HDR10/HLG</td>
                        <td class="px-1">YCbCr</td>
                    </tr>
                </tbody>
            </table>
            <p>RPU 是含有动态元数据的特殊 NALU，类似（到现在还没几个播放器能正常解码的）<code>opt-qp-pps</code>，<code>opt-ref-list-length-pps</code>的功能。</p>
            <p>像素流量每秒 Pixel per second PPS：像素宽，像素高，帧数每秒的商。</p>
            <div class="overflow-auto">
                <table class="table-center text-smaller">
                    <thead>
                        <tr class="t-invert-dark">
                            <th class="px-1">级别 Level</th>
                            <th class="px-1">PPS</th>
                            <th class="px-1">pps 相符的格式</th>
                            <th class="px-1">Main tier 码率</th>
                            <th class="px-1">High tier 码率</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">01</th>
                            <td class="px-1">22118400</td>
                            <td class="px-1">1280x720 24fps</td>
                            <td class="px-1">20Mbps</td>
                            <td class="px-1">50Mbps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">02</th>
                            <td class="px-1">27648000</td>
                            <td class="px-1">1280x720 30fps</td>
                            <td class="px-1">20Mbps</td>
                            <td class="px-1">50Mbps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">03</th>
                            <td class="px-1">49766400</td>
                            <td class="px-1">1920x1080 24fps</td>
                            <td class="px-1">20Mbps</td>
                            <td class="px-1">70Mbps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">04</th>
                            <td class="px-1">62208000</td>
                            <td class="px-1">1920x1080 30fps</td>
                            <td class="px-1">20Mbps</td>
                            <td class="px-1">70Mbps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">05</th>
                            <td class="px-1">12441600</td>
                            <td class="px-1">1920x1080 60fps</td>
                            <td class="px-1">20Mbps</td>
                            <td class="px-1">70Mbps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">06</th>
                            <td class="px-1">199065000</td>
                            <td class="px-1">3840x2160 24fps</td>
                            <td class="px-1">25Mbps</td>
                            <td class="px-1">130Mbps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">07</th>
                            <td class="px-1">248832000</td>
                            <td class="px-1">3840x2160 30fps</td>
                            <td class="px-1">25Mbps</td>
                            <td class="px-1">130Mbps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">08</th>
                            <td class="px-1">398131200</td>
                            <td class="px-1">3840x2160 48fps</td>
                            <td class="px-1">40Mbps</td>
                            <td class="px-1">130Mbps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">09</th>
                            <td class="px-1">497664000</td>
                            <td class="px-1">3840x2160 60fps</td>
                            <td class="px-1">40Mbps</td>
                            <td class="px-1">130Mbps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">10</th>
                            <td class="px-1">995328000</td>
                            <td class="px-1">3840x2160 120fps</td>
                            <td class="px-1">60Mbps</td>
                            <td class="px-1">240Mbps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">11</th>
                            <td class="px-1">995328000</td>
                            <td class="px-1">7680x4320 30fps</td>
                            <td class="px-1">60Mbps</td>
                            <td class="px-1">240Mbps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">12</th>
                            <td class="px-1">1990656000</td>
                            <td class="px-1">7680x4320 60fps</td>
                            <td class="px-1">120Mbps</td>
                            <td class="px-1">480Mbps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">13</th>
                            <td class="px-1">3981312000</td>
                            <td class="px-1">7680x4320 120fps</td>
                            <td class="px-1">240Mbps</td>
                            <td class="px-1">800Mbps</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p class="text-gray-side mt-0">数据流中表示 profile 和 level 的字串即 <code>[编码].[profile ID].[level ID]</code>。如 dvav.09.04 即 SDR 向后兼容的 8bit AVC，62208000pps（1920x1080 30fps）的视频</p>
            <p class="text-gray-side mt-0">注：HLS 代表 HTTP 网络播放协议 Http live streaming</p>
            <code class="code-bold">--dolby-vision-profile</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;选择 5/8.1（HDR10）/8.2（SDR）&gt;<span class="text-red-emph">大于 8.1 需 master-display 和 HDR10-opt</span>。</p>
            <code class="code-bold">--dolby-vision-rpu</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;路径&gt;导入 RPU 二进制文件（.bin）。</p>
            <p class="text-gray-side pl-5 m-0">注：杜比视界 8.1 需要 <code>--dolby-vision-profile 5.0 --dolby-vision-rpu "元数据.bin" --vbv-bufsize 20000 --vbv-maxrate 20000</code>。</p>

            <h3>RPU 元数据的获取</h3>
            <p>可以用<a href="https://github.com/quietvoid/dovi_tool">dovi_tool</a>提取 RPU，<a href="https://github.com/saindriches/dovi_meta">dovi_meta</a>创建 RPU。ffmpeg 提取源视频 RPU 用：</p>
            <pre><code class="text-smaller language-powershell">
ffmpeg.exe -i "源" -c:v copy -vbsf hevc_mp4toannexb -f hevc - | dovi_tool.exe extract-rpu - -o  "RPU.bin"
            </code></pre>

            <h2 id="h2-20">输入输出 Input-output IO</h2>

            <h3>Profile，Level，Tier</h3>
            <p>用于进一步提高编码内容的兼容性。设定后，如果视频规格（像素流量，帧大小等）高于设定规格（Profile）或级别（Level），或其它无法满足规格、级别要求的情况下阻止编解码。</p>
            <code class="code-bold">--profile</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;字符串&gt;据下表最低支持（视频所有规格小于下表）选择：</p>
            <ul class="font-monospace pl-5 text-smaller">
                <li><b>8 bit</b>：
                    <ul>
                        <li>main, main-intra</li>
                        <li>main444-8, main444-intra</li>
                    </ul>
                </li>
                <li><b>10 bit</b>：
                    <ul>
                        <li>main10, main10-intra</li>
                        <li>main422-10, main422-10-intra</li>
                        <li>main444-10, main444-10-intra</li>
                    </ul>
                </li>
                <li><b>12 bit</b>：
                    <ul>
                        <li>main12, main12-intra</li>
                        <li>main422-12, main422-12-intra</li>
                        <li>main444-12, main444-12-intra</li>
                    </ul>
                </li>
            </ul>
            <p class="font-monospace pl-5 m-0 overflow-auto">“-intra”代表仅使用帧内编码，一般用不到。</p>
            <code class="code-bold">--level-idc</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数/浮点&gt;可选 1, 2, 2.1, 3, 3.1, 4, 4.1, 5, 5.1, 5.2, 6, 6.1, 6.2 据下表的最高分辨率@帧率选择</p>
            <code class="code-bold">--high-tier</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;在压制过程中判断当前规格能否被编码为 Main 规格（main，main10，main12），否则编码为 High 规格（high，high10，high12）。解码时，如果视频规格过高，则用户可能会收到如“设备条件不满足”的警告。不使用 Main tier</p>

            <p>查找方法：根据视频位深选择规格 Profile，分辨率和帧率选择级别 Level，最后细分到档次 Tier（Main/High，或者一直开着 <code>--high-tier</code>）</p>
            <div class="overflow-auto">
                <table class="table-center text-smaller">
                    <thead>
                        <tr class="t-invert-dark">
                            <th class="px-1">级别 Level</th>
                            <th class="px-1">最大亮度像素流量</th>
                            <th class="px-1">最大亮度平面面积</th>
                            <th class="px-1">8~10bit 最大码率</th>
                            <th class="px-1">12bit 最大码率</th>
                            <th class="px-1">4:4:4 12bit 最大码率</th>
                            <th class="px-1">最高分辨率@帧率举例</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">1</th>
                            <td class="px-1">552,960</td>
                            <td class="px-1">36,864</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 128 Kbps<br><b>High</b> -</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 192 Kbps<br><b>High</b>: -</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 384 Kbps<br><b>High</b>: -</td>
                            <td class="px-1">176×144@15 fps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">2</th>
                            <td class="px-1">3,686,400</td>
                            <td class="px-1">122,880</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 1500 Kbps<br><b>High</b>: -</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 2250 Kbps<br><b>High</b>: -</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 4500 Kbps<br><b>High</b>: -</td>
                            <td class="px-1">352×288@30 fps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">2.1</th>
                            <td class="px-1">7,372,800</td>
                            <td class="px-1">245,760</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 3000 Kbps<br><b>High</b>: -</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 4500 Kbps<br><b>High</b>: -</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 9000 Kbps<br><b>High</b>: -</td>
                            <td class="px-1">640×360@30 fps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">3</th>
                            <td class="px-1">16,588,800</td>
                            <td class="px-1">552,960</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 6000 Kbps<br><b>High</b>: -</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 9000 Kbps<br><b>High</b>: -</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 18 Mbps<br><b>High</b>: -</td>
                            <td class="px-1">960×540@30 fps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">3.1</th>
                            <td class="px-1">33,177,600</td>
                            <td class="px-1">983,040</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 10 Mbps<br><b>High</b>: -</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 15 Mbps<br><b>High</b>: -</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 30 Mbps<br><b>High</b>: -</td>
                            <td class="px-1">1280×720@33.7 fps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">4</th>
                            <td class="px-1">66,846,720</td>
                            <td class="px-1">2,228,224</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 12 Mbps<br><b>High</b>: 30 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 18 Mbps<br><b>High</b>: 45 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 36 Mbps<br><b>High</b>: 90 Mbps</td>
                            <td class="px-1">1280×720@68 fps<br>1920×1080@32 fps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">4.1</th>
                            <td class="px-1">133,693,440</td>
                            <td class="px-1">2,228,224</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 20 Mbps<br><b>High</b>: 50 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 30 Mbps<br><b>High</b>: 75 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 60 Mbps<br><b>High</b>: 150 Mbps</td>
                            <td class="px-1">1920×1080@64 fps<br>2048×1080@60 fps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">5</th>
                            <td class="px-1">267,386,880</td>
                            <td class="px-1">8,912,896</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 25 Mbps<br><b>High</b>: 100 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 37.5 Mbps<br><b>High</b>: 150 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 75 Mbps<br><b>High</b>: 300 Mbps</td>
                            <td class="px-1">3840×2160@32 fps<br>4096×2160@30 fps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">5.1</th>
                            <td class="px-1">534,773,760</td>
                            <td class="px-1">8,912,896</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 40 Mbps<br><b>High</b>: 160 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 60 Mbps<br><b>High</b>: 240 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 120 Mbps<br><b>High</b>: 480 Mbps</td>
                            <td class="px-1">3840×2160@64 fps<br>4096×2160@60 fps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">5.2</th>
                            <td class="px-1">1,069,547,520</td>
                            <td class="px-1">8,912,896</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 60 Mbps<br><b>High</b>: 240 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 90 Mbps<br><b>High</b>: 360 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 180 Mbps<br><b>High</b>: 720 Mbps</td>
                            <td class="px-1">3840×2160@128 fps<br>4096×2160@120 fps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">6</th>
                            <td class="px-1">1,069,547,520</td>
                            <td class="px-1">35,651,584</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 60 Mbps<br><b>High</b>: 240 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 90 Mbps<br><b>High</b>: 360 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 180 Mbps<br><b>High</b>: 720 Mbps</td>
                            <td class="px-1">7680×4320@32 fps<br>8192×4320@30 fps</td>
                        </tr>
                        <tr class="border-lr">
                            <th class="px-1">6.1</th>
                            <td class="px-1">2,139,095,040</td>
                            <td class="px-1">35,651,584</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 120 Mbps<br><b>High</b>: 480 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 180 Mbps<br><b>High</b>: 720 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 360 Mbps<br><b>High</b>: 1440 Mbps</td>
                            <td class="px-1">7680×4320@64 fps<br>8192×4320@60 fps</td>
                        </tr>
                        <tr class="t-light-gray border-lr">
                            <th class="px-1">6.2</th>
                            <td class="px-1">4,278,190,080</td>
                            <td class="px-1">35,651,584</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 240 Mbps<br><b>High</b>: 800 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 360 Mbps<br><b>High</b>: 1200 Mbps</td>
                            <td class="px-1 t-align-left"><b>Main</b>: 720 Mbps<br><b>High</b>: 2400 Mbps</td>
                            <td class="px-1">7680×4320@128 fps<br>8192×4320@120 fps</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p>以上表格见 <a href="https://en.wikipedia.org/wiki/High_Efficiency_Video_Coding_tiers_and_levels">维基百科</a>。</p>

            <code class="code-bold">--seek</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数，默认 0&gt;从第几帧开始压缩。</p>
            <code class="code-bold">--frames</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数，默认全部&gt;手动限制一共压缩多少帧，或者补充空白的元数据，从而显示进度和预计完成时间（ETA）。</p>
            <code class="code-bold">--output</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数，默认 0&gt;从第几帧开始压缩。</p>
            <code class="code-bold">--dither</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;使用抖动功能以高质量的降低色深 (比如 10bit 片源降 8bit)，避免出现斑点和方块。</p>
            <code class="code-bold">--allow-non-conformance</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;不写入 profile 和 level，绕过 HEVC 标准规定，只要不是按照 h.265 规定写的命令行参数值就必须使用这个参数。</p>
            <code class="code-bold">--force-flush</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;整数 0~2，默认 0&gt;低能耗设备用的编码调度控制：</p>
            <ul class="font-monospace pl-5 list-dotless text-smaller">
                <li><span class="text-blue-emph">0</span>等全部帧输入再编码</li>
                <li><span class="text-blue-emph">1</span>不等全部帧输入完就编码</li>
                <li><span class="text-blue-emph">2</span>取决于条带种类，调整 slice type 才能用</li>
            </ul>
            <code class="code-bold">--field</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关&gt;输入分行扫描视频时用，自动获取分场视频的帧率 + 优先场，x264 中中为 <code>--interlaced</code> 参数</p>
            <code class="code-bold">--temporal-layers</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;开关，默认关&gt;使 x265 更兼容 svc 标准，将非参考 b 帧（相当于空信息）分离到另一层视频流中，解码器可以选择跳过而降低性能损耗。</p>
            <p class="text-gray-side pl-5 m-0">注：可能会造成一般编解码方案的兼容性问题</p>

            <h3>编解码图像序列</h3>
            <p>见<a href="https://www.nazorip.site/archives/63">x264 教程</a></p>

            <h2 id="h2-21">预设参数</h2>
            
            <code class="code-bold">--preset</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;superfast/veryfast/faster/fast/medium/slow/slower/veryslow/placebo&gt;见下：</p>
            <div class="overflow-auto">
                <table class="table-fit-container text-xs">
                    <thead>
                        <tr class="border-lr">
                            <th>参数值\预设</th>
                            <th class="text-blue-emph">superfast</th>
                            <th class="text-blue-emph">veryfast</th>
                            <th class="text-blue-emph">faster</th>
                            <th class="text-blue-emph">fast</th>
                            <th class="text-blue-emph">medium</th>
                            <th class="text-blue-emph">slow</th>
                            <th class="text-blue-emph">slower</th>
                            <th class="text-blue-emph">veryslow</th>
                            <th class="text-blue-emph">placebo</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-lr">
                            <th class="px-1">ctu</th>
                            <td class="px-1">32</td>
                            <td class="px-1 t-invert-light" colspan="8">64</td>
                        </tr>
                        <tr class="border-lr">
                            <th>min-cu</th>
                            <td colspan="9" class="px-1">8</td>
                        </tr>
                        <tr class="border-lr">
                            <th>bframes</th>
                            <td class="px-1">3</td>
                            <td class="px-1 t-invert-light" colspan="5">4</td>
                            <td class="px-1 t-invert-dark" colspan="3">8</td>
                        </tr>
                        <tr class="border-lr">
                            <th>b-adapt</th>
                            <td class="px-1" colspan="4">0</td>
                            <td class="px-1 t-invert-light" colspan="5">2</td>
                        </tr>
                        <tr class="border-lr">
                            <th>rc-lookahead</th>
                            <td class="px-1">10</td>
                            <td class="px-1 t-light-gray" colspan="3">15</td>
                            <td class="px-1 t-invert-light">20</td>
                            <td class="px-1 t-invert-light">25</td>
                            <td class="px-1 t-invert-light" colspan="2">40</td>
                            <td class="px-1 t-invert-dark">60</td>
                        </tr>
                        <tr class="border-lr">
                            <th>lookahead-slices</th>
                            <td class="px-1" colspan="5">8</td>
                            <td class="px-1 t-invert-light">4</td>
                            <td class="px-1 t-invert-dark" colspan="3">1</td>
                        </tr>
                        <tr class="border-lr">
                            <th>ref</th>
                            <td class="px-1">1</td>
                            <td class="px-1 t-light-gray" colspan="2">2</td>
                            <td class="px-1 t-invert-light" colspan="2">3</td>
                            <td class="px-1 t-invert-light">4</td>
                            <td class="px-1 t-invert-dark" colspan="3">5</td>
                        </tr>
                        <tr class="border-lr">
                            <th>limit-refs</th>
                            <td class="px-1">0</td>
                            <td class="px-1 t-light-gray" colspan="5">3</td>
                            <td class="px-1 t-invert-light">1</td>
                            <td class="px-1 t-invert-dark" colspan="2">0</td>
                        </tr>
                        <tr class="border-lr">
                            <th>me</th>
                            <td class="px-1" colspan="5">hex</td>
                            <td class="px-1 t-invert-light" colspan="4">star</td>
                        </tr>
                        <tr class="border-lr">
                            <th>merange</th>
                            <td class="px-1 t-invert-light" colspan="8">57</td>
                            <td class="px-1 t-invert-dark">92</td>
                        </tr>
                        <tr class="border-lr">
                            <th>subme</th>
                            <td class="px-1" colspan="2">1</td>
                            <td class="px-1 t-invert-light" colspan="3">2</td>
                            <td class="px-1 t-invert-light">3</td>
                            <td class="px-1 t-invert-light" colspan="2">4</td>
                            <td class="px-1 t-invert-dark">5</td>
                        </tr>
                        <tr class="border-lr">
                            <th>rect</th>
                            <td class="px-1" colspan="5">0</td>
                            <td class="px-1 t-invert-dark" colspan="4">1</td>
                        </tr>
                        <tr class="border-lr">
                            <th>amp</th>
                            <td class="px-1" colspan="6">0</td>
                            <td class="px-1 t-invert-dark" colspan="3">1</td>
                        </tr>
                        <tr class="border-lr">
                            <th>limit-modes</th>
                            <td class="px-1" colspan="5">0</td>
                            <td class="px-1 t-invert-light" colspan="2">11</td>
                            <td class="px-1 t-invert-dark" colspan="2">0</td>
                        </tr>
                        <tr class="border-lr">
                            <th>max-merge</th>
                            <td class="px-1" colspan="5">2</td>
                            <td class="px-1 t-light-gray">3</td>
                            <td class="px-1 t-invert-light">4</td>
                            <td class="px-1 t-invert-dark" colspan="2">5</td>
                        </tr>
                        <tr class="border-lr">
                            <th>early-skip</th>
                            <td class="px-1" colspan="3">1</td>
                            <td class="px-1 t-light-gray">0</td>
                            <td class="px-1 t-invert-light">1</td>
                            <td class="px-1 t-invert-dark" colspan="4">0</td>
                        </tr>
                        <tr class="border-lr">
                            <th>rskip</th>
                            <td class="px-1" colspan="8">1</td>
                            <td class="px-1 t-invert-light">0</td>
                        </tr>
                        <tr class="border-lr">
                            <th>夹角模式提速 fast-intra</th>
                            <td class="px-1" colspan="4">1</td>
                            <td class="px-1 t-invert-light" colspan="5">0</td>
                        </tr>
                        <tr class="border-lr">
                            <th>B 条带帧内搜索 b-intra</th>
                            <td class="px-1" colspan="6">0</td>
                            <td class="px-1 t-invert-light" colspan="3">1</td>
                        </tr>
                        <tr class="border-lr">
                            <th>取样迁就偏移 sao</th>
                            <td class="px-1">关</td>
                            <td class="px-1 t-invert-light" colspan="8">开</td>
                        </tr>
                        <tr class="border-lr">
                            <th>P 帧权重 weightp</th>
                            <td class="px-1">0</td>
                            <td class="px-1 t-invert-light" colspan="8">1</td>
                        </tr>
                        <tr class="border-lr">
                            <th>B 帧权重 weightb</th>
                            <td class="px-1" colspan="6">0</td>
                            <td class="px-1 t-invert-light" colspan="3">1</td>
                        </tr>
                        <tr class="border-lr">
                            <th>aq-mode</th>
                            <td class="px-1">0</td>
                            <td class="px-1 t-invert-light" colspan="8">2</td>
                        </tr>
                        <tr class="border-lr">
                            <th>cutree</th>
                            <td class="px-1" colspan="9">开</td>
                        </tr>
                        <tr class="border-lr">
                            <th>率失真优化 rd</th>
                            <td class="px-1" colspan="4">2</td>
                            <td class="px-1 t-light-gray">3</td>
                            <td class="px-1 t-invert-light">4</td>
                            <td class="px-1 t-invert-dark" colspan="3">6</td>
                        </tr>
                        <tr class="border-lr">
                            <th>rdoq-level</th>
                            <td class="px-1" colspan="5">0</td>
                            <td class="px-1 t-invert-light" colspan="4">2</td>
                        </tr>
                        <tr class="border-lr">
                            <th>tu 帧内/间上限 tu-intra-depth</th>
                            <td class="px-1" colspan="6">1</td>
                            <td class="px-1 t-invert-light" colspan="2">3</td>
                            <td class="px-1 t-invert-dark">4</td>
                        </tr>
                        <tr class="border-lr">
                            <th>tu 分裂上限 tu-inter-depth</th>
                            <td class="px-1" colspan="6">0</td>
                            <td class="px-1 t-invert-light">4</td>
                            <td class="px-1 t-invert-dark" colspan="2">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <code class="code-bold">--tune</code>
            <p class="font-monospace pl-5 m-0 overflow-auto">&lt;zerolatency/animation/grain/film/fastdecode/psnr&gt;更改 preset 的一些参数，见下：</p>
            <div class="overflow-auto">
                <table class="table-fit-container text-smaller">
                    <thead>
                        <tr class="border-lr">
                            <th>预设</th>
                            <th>说明</th>
                            <th>对应参数</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-lr">
                            <th class="text-blue-emph px-1 t-light-gray">zerolatency</th>
                            <td class="px-1 t-light-gray">集中算力到一次编码一帧，并尽可能关闭率控制和 B 帧功能</td>
                            <td class="px-1 font-monospace t-light-gray"><code>--bframes 0 --b-adapt 0 --no-cutree --no-scenecut --frame-threads 1</code></td>
                        </tr>
                        <tr class="border-lr">
                            <th class="text-blue-emph px-1">animation</th>
                            <td class="px-1">优化动漫场景画面</td>
                            <td class="px-1 font-monospace"><code>--psy-rd 0.4 --aq-strength 0.4 --deblock 1:1 --no-cutree --bframes +=2</code></td>
                        </tr>
                        <tr class="border-lr">
                            <th class="text-blue-emph px-1 t-light-gray">grain</th>
                            <td class="px-1 t-light-gray">保留高频信号/最高画质</td>
                            <td class="px-1 font-monospace t-light-gray"><code>--aq-mode 0 --no-cutree --ipratio 1.1 --pbratio 1 --qp-step 1 --no-sao --psy-rdoq 0 --rskip 0</code></td>
                        </tr>
                        <tr class="border-lr">
                            <th class="text-blue-emph px-1">fastdecode</th>
                            <td class="px-1">降低解码算力占用以降低超高帧率——分辨率解码负载</td>
                            <td class="px-1 font-monospace"><code>--no-weightb --no-weightp --no-deblock --no-sao</code></td>
                        </tr>
                        <tr class="border-lr">
                            <th class="text-blue-emph px-1 t-light-gray">psnr</th>
                            <td class="px-1 t-light-gray">尽可能降低编码结果和原画的均方差 MSE 差异，但与画质关系不大</td>
                            <td class="px-1 font-monospace t-light-gray"><code>--aq-mode 0 --rd 0 --no cutree</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h2 id="h2-22">附录：下载</h2>
            <h3>LibavFormat / lavf</h3>
            <p>一种用于处理封装和解封装的动态链接库，同时阅读封装文件的元数据并传给嵌入该库的程序。x264 一般都嵌入了 lavf，x265 则不多。由于只是复制元数据的值而没有做检测，所以元数据写错（情况不罕见）的源会导致编码跟着错，主要错在色彩空间和 HDR 设置上。</p>
            <p class="text-gray-side">注：.hevc 代表不含 lavf 解码封装库，只能导出.hevc 视频流，需自行封装为 .mp4 .mkv 等格式；含 lavf 或使用 ffmpeg 内置的 libx265 则可以直接导出，使用见 x264/5 <a href="https://nazorip.site/archives/334/">急用版教程</a></p>

            <h3>下载 x265.exe</h3>
            <table class="table-center">
                <tbody>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a href="http://www.mediafire.com/?6lfp2jlygogwa">LigH</a></th>
                        <td class="px-1">.hevc [8-10-12bit]</td>
                        <td class="px-1">附 x86 32bit 版，Windows XP x86 版，附 libx265.dll</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a href="https://github.com/jpsdr/x265/releases">jpsdr</a></th>
                        <td class="px-1">.hevc [8-10-12bit] </td>
                        <td class="px-1">GCC 12.2 + MSVC_llvm 1928，附 Broadwell 版，支持 aq-mode 5</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a
                                href="https://drive.google.com/drive/u/0/folders/0BzA4dIFteM2dWEpvWGZXV3ZhdTA">Rigaya</a></th>
                        <td class="px-1">.hevc [8-10-12bit]</td>
                        <td class="px-1">GCC 9.3，附 x86 32bit 版</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a href="https://github.com/Patman86/x265-Mod-by-Patman/releases">Patman</a></th>
                        <td class="px-1">.hevc [8-10-12bit]</td>
                        <td class="px-1">GCC 11 + MSVC 1925</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a
                                href="https://forum.doom9.org/showthread.php?p=1937773#post1937773">ShortKatz</a></th>
                        <td class="px-1">arm64~64e（Mac OS，安卓等平台）</td>
                        <td class="px-1">需运行编译命令文件，附 x86 32bit 版</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a href="https://github.com/DJATOM/x265-aMod/releases/">DJATOM-aMod</a></th>
                        <td class="px-1">Intel 架构与 zen1~2 优化：[10bit]，zen3 优化：[10-12bit] </td>
                        <td class="px-1">GCC 10.2.1 + GCC10.3</td>
                    </tr>
                    <tr>
                        <th class="px-3 t-light-gray"><a href="https://down.7086.in/">MeteorRain-yuuki</a></th>
                        <td class="px-1">.mp4 .mkv [8][10][12bit]+[8-10-12bit]</td>
                        <td class="px-1">GCC 9.3 + ICC 1900 + MSVC 1916</td>
                    </tr>
                </tbody>
            </table>
            <p class="text-gray-side">表：[8-10-12bit] 代表一个.exe 同时含三种色深，<span class="text-red-emph">未使用 YUV for MPEG（y4m）pipe 或 lavf 时应设置 <code>-D</code> 参数以选择正确的色深</span>，而 [8][10][12]bit 则代表三个 .exe 分别支持三种色深，压制时选择正确的 .exe 即可</p>

            <h3>下载基本工具</h3>
            <table class="table-center">
                <tbody>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a href="http://ffmpeg.org/download.html">ffmpeg~ffprobe</a></th>
                        <td class="px-1">顶级开源多系统多媒体 CLI 处理~检测工具</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a href="https://mpv.io/installation/">mpv</a></th>
                        <td class="px-1">支持便携的开源多系统现代视频播放器。见<a href="https://nazorip.site/archives/1052/">安装与配置</a>教程</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a href="https://www.voukoder.org/">Voukoder</a></th>
                        <td class="px-1">开源 Premiere Vegas After Effects 压制导出插件，分为 Voukoder 和 V-Connector 两部分</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a href="https://obsproject.com/zh-cn/download">OBS</a></th>
                        <td class="px-1">开源直播框架和录制软件，设置略比传统录屏软件复杂，但效果也更好</td>
                    </tr>
                    <tr class="border-bottom">
                        <th class="px-3 t-light-gray"><a href="https://mediaarea.net/zh-CN/MediaInfo">MediaInfo</a></th>
                        <td class="px-1">开源 GUI 媒体元数据/视音频格式读取器，用于配置正确的压制参数</td>
                    </tr>
                </tbody>
            </table>

            <h3>VapourSynth 帧服务器滤镜工具</h3>
            <p>临时内容，具体是否应该，以及如何放于 x264/5 教程内有待讨论。</p>
        </div>

        <!-- Footer -->
        <footer class="py-3 my-4 align-items-center border-top">
            <p>联系：
                <a href='https://github.com/iAvoe/'>Github</a>，
                <a href='https://jq.qq.com/?_wv=1027&k=5YJFXyf'>QQ 群：691892901</a>
            </p>
            &#x24B8; iAvoe，2024
        </footer>
	</body>
</html>